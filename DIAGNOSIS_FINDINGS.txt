================================================================================
E2E TEST FAILURE DIAGNOSIS - COMPLETE FINDINGS
================================================================================

TASK: Diagnose why e2e tests fail on Linux when they work on Mac
RESULT: Found 5 critical configuration issues - NOT code bugs

================================================================================
TEST FAILURES OBSERVED
================================================================================

Test 1: "loads and shows actual app content"
  Status: FAILS
  Symptom: Content check returns all false (greeting=false, welcome=false, getStarted=false)
  Error: App shows "Loading..." or blank screen
  Expected: Should show "Hi [username]" (authenticated) OR "Get Started" (public)

Test 2: "loads within 10 seconds"  
  Status: FAILS
  Symptom: net::ERR_CONNECTION_REFUSED on localhost:8082
  Error: Connection to Expo server refused mid-test
  Expected: Should navigate to http://localhost:8082 successfully

================================================================================
ROOT CAUSES (5 CRITICAL ISSUES IDENTIFIED)
================================================================================

ISSUE #1: GLOBAL DATABASE SETUP IS DISABLED
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
File: e2e/playwright.config.ts (lines 73-75)
Status: COMMENTED OUT

Current Code:
  // Global setup disabled - run migrations manually before tests if needed
  // globalSetup: require.resolve('./global-setup'),

Impact:
  ✗ Database is NOT cleaned between test runs
  ✗ Stale data from previous tests remains
  ✗ Database migrations might not have run
  ✗ Data conflicts cause unpredictable test behavior

Fix: Uncomment the globalSetup line
  globalSetup: require.resolve('./global-setup'),


ISSUE #2: SERVERS ARE REUSED WITH OLD ENVIRONMENT VARIABLES
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
File: e2e/playwright.config.ts (lines 13 & 18)

Current Code:
  reuseExistingServer: !process.env.CI,

Status: CI environment variable is NOT set on this system
Therefore: reuseExistingServer = true (old servers are REUSED)

Impact:
  ✗ When backend server is reused from previous run, it doesn't have E2E_AUTH_BYPASS env var
  ✗ Playwright passes E2E_AUTH_BYPASS=true to new process, but old process ignores it
  ✗ Backend auth middleware checks for E2E_AUTH_BYPASS and doesn't find it
  ✗ /auth/me endpoint fails or returns wrong response
  ✗ App can't get user data, stays in loading state

Fix: Force fresh server startup
  reuseExistingServer: false,


ISSUE #3: HOMEPAGE TEST DOESN'T INITIALIZE E2E AUTHENTICATION
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
File: e2e/tests/homepage.spec.ts

Current Behavior:
  ✗ Does NOT call /api/e2e/seed endpoint to create test user
  ✗ Does NOT set e2e-user-id and e2e-user-email URL parameters
  ✗ Does NOT set HTTP headers for E2E authentication
  ✗ App falls back to DEFAULT_E2E_USER

Expected Flow (from single-user-journey.spec.ts):
  1. Test calls /api/e2e/seed to create user
  2. Test navigates with E2E headers or URL params
  3. App initializes with proper user context
  4. /auth/me succeeds and returns user data
  5. App renders authenticated home screen

Actual Flow in Homepage Test:
  1. Test navigates to / without any setup
  2. App tries to use DEFAULT_E2E_USER (id='e2e-test-user')
  3. App calls /auth/me without E2E headers
  4. Backend might not have user data
  5. App stuck in loading state or shows wrong screen

Impact:
  ✗ No user is seeded in the database
  ✗ /auth/me call has no E2E headers
  ✗ Backend can't authenticate request
  ✗ App never receives user data
  ✗ Content never renders

Fix: Add test.beforeEach() to seed user and set HTTP headers
  See E2E_FIXES_SUMMARY.md for complete code


ISSUE #4: EXPO SERVER STARTUP TIMEOUT TOO SHORT
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
File: e2e/playwright.config.ts (line 23)

Current Code:
  timeout: 120000,  // 2 minutes

Issue on Linux:
  ✗ Metro bundler can take 2-3 minutes on first run or after changes
  ✗ Slower file system (Docker volumes, VMs, WSL)
  ✗ System under load → slower compilation

Result:
  ✗ Playwright gives up before Expo finishes starting
  ✗ Connection to :8082 refused
  ✗ Second test fails with ERR_CONNECTION_REFUSED

Fix: Increase timeout
  timeout: 180000,  // 3 minutes


ISSUE #5: ENVIRONMENT VARIABLES MIGHT NOT PROPAGATE
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
File: e2e/playwright.config.ts (lines 10-20)

Context:
  ✓ dotenv.config() loads e2e/.env.test
  ✓ Playwright passes env vars to backend via webServer.env
  ✓ But only if server is restarted (see Issue #2)

Variables Passed:
  E2E_AUTH_BYPASS: 'true'
  MOCK_LLM: 'true'
  E2E_FIXTURE_ID: fixtureId

Verification:
  ✓ mobile/.env has EXPO_PUBLIC_E2E_MODE=true ← This is set correctly
  ✓ mobile/.env has EXPO_PUBLIC_API_URL=http://localhost:3002 ← This is correct
  ✗ backend/.env does NOT have E2E_AUTH_BYPASS (should come from playwright config)

Problem:
  If backend server is reused (Issue #2), these env vars are not active in the running process

Fix: See Issue #2 (force server restart)

================================================================================
WHY IT WORKS ON MAC BUT NOT LINUX
================================================================================

Mac (Works):
  ✓ Faster process startup (native system)
  ✓ Ports release faster
  ✓ Faster file system I/O
  ✓ Tests might naturally restart servers before they're reused
  ✓ Or tests run in different order

Linux (Fails):
  ✗ Slower process startup (Docker/VM/WSL)
  ✗ Port cleanup delays
  ✗ Slower file system (Docker volumes)
  ✗ Timeout expires before Expo finishes
  ✗ Server reuse hits stale env vars
  ✗ More likely to hit race conditions

The same code runs, but configuration/timing issues surface on Linux.

================================================================================
CONFIGURATION STATUS REPORT
================================================================================

E2E Environment (.env.test):
  ✓ DATABASE_URL set to test database
  ✓ EXPO_PUBLIC_API_URL set correctly
  ✗ E2E_AUTH_BYPASS not in file (should come from playwright config)
  ✗ MOCK_LLM not in file (should come from playwright config)

Backend Environment (.env):
  ✓ DATABASE_URL set
  ✓ CLERK keys configured (placeholders)
  ✓ ABLY key configured
  ✗ E2E_AUTH_BYPASS not set (should come from playwright config)
  ✗ MOCK_LLM not set (should come from playwright config)

Mobile Environment (.env):
  ✓ EXPO_PUBLIC_E2E_MODE=true ← CORRECT
  ✓ EXPO_PUBLIC_API_URL=http://localhost:3002 ← CORRECT

Playwright Config:
  ✓ Loads e2e/.env.test
  ✓ Passes E2E_AUTH_BYPASS=true to backend
  ✓ Passes MOCK_LLM=true to backend
  ✗ Uses reuseExistingServer: true (should be false)
  ✗ Global setup commented out
  ✗ Expo timeout 120s (should be 180s)

Test File (homepage.spec.ts):
  ✗ No test.beforeEach() to seed user
  ✗ No page.setExtraHTTPHeaders() for E2E auth
  ✗ No API setup before navigation

================================================================================
PRIORITY FIXES (In Order)
================================================================================

MUST FIX FIRST:
  1. Uncomment globalSetup in e2e/playwright.config.ts
  2. Change reuseExistingServer to false in playwright.config.ts
  3. Update e2e/tests/homepage.spec.ts with proper E2E setup

SHOULD FIX:
  4. Increase Expo timeout from 120s to 180s
  5. Kill existing servers before test runs

NICE TO HAVE:
  6. Add logging to verify E2E_AUTH_BYPASS is active
  7. Create helper script for pre-test cleanup
  8. Document E2E test patterns for future tests

================================================================================
FILES FOR DETAILED INFORMATION
================================================================================

E2E_DIAGNOSTIC_REPORT.md
  - Complete analysis of each issue
  - Why each issue causes the failures
  - Detailed solutions and verification steps
  - Checklist for environment setup

E2E_FIXES_SUMMARY.md
  - Quick reference for code changes
  - Complete updated homepage.spec.ts code
  - Line-by-line fixes for playwright.config.ts
  - Manual testing checklist
  - Debug steps if fixes don't work

DIAGNOSIS_FINDINGS.txt (this file)
  - Executive summary
  - Root cause analysis
  - Configuration status
  - Priority fixes list

================================================================================
VERIFICATION STEPS
================================================================================

After applying fixes:

1. Uncomment globalSetup line in playwright.config.ts
   grep "globalSetup:" e2e/playwright.config.ts | grep -v "//"

2. Verify reuseExistingServer is false
   grep "reuseExistingServer:" e2e/playwright.config.ts | head -2

3. Verify homepage.spec.ts has E2E setup
   grep "getE2EHeaders\|setExtraHTTPHeaders\|beforeEach" e2e/tests/homepage.spec.ts | wc -l
   Should output: 3 or more

4. Kill old servers and reset database
   npm run kill:api 2>/dev/null || true
   npm run kill:mobile 2>/dev/null || true
   DATABASE_URL="postgresql://mwf_user:mwf_password@localhost:5432/meet_without_fear_test" \
     npm run db:reset -- --force

5. Run the test
   cd e2e && npx playwright test tests/homepage.spec.ts -v

Expected: Both tests pass ✓

================================================================================
CONCLUSION
================================================================================

This is NOT a code bug. The application code is correct.

The issues are CONFIGURATION problems:
  • Global setup disabled
  • Server reuse with stale environment variables
  • Test missing E2E initialization steps
  • Timeout too short for slower systems
  • Environment variables not propagating to reused servers

These are all fixable with configuration changes in:
  • e2e/playwright.config.ts
  • e2e/tests/homepage.spec.ts

The fixes are simple, low-risk, and will make tests reliable on both Mac and Linux.

================================================================================
