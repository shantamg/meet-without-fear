<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BeHeard - Quick Preview</title>
    <link rel="stylesheet" href="styles/shared.css">
    <style>
        /* Dashboard styles for intro */
        .dashboard-view {
            padding: 0;
        }
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-lg) var(--spacing-xl);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }
        .header-actions {
            display: flex;
            gap: var(--spacing-md);
        }
        .header-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .hero-card {
            margin: var(--spacing-xl);
            padding: var(--spacing-xl);
            background: linear-gradient(135deg, var(--accent) 0%, #0d8a6a 100%);
            border-radius: var(--radius-lg);
            cursor: pointer;
        }
        .hero-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(16, 163, 127, 0.3);
        }
        .hero-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: var(--spacing-md);
        }
        .hero-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: white;
            margin-bottom: var(--spacing-xs);
        }
        .hero-subtitle {
            font-size: var(--font-size-sm);
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: var(--spacing-lg);
        }
        .hero-btn {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md) var(--spacing-lg);
            background: white;
            color: var(--accent);
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
        }
        .section-title {
            font-size: var(--font-size-sm);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: var(--spacing-lg) var(--spacing-xl) var(--spacing-sm);
        }
        .person-list {
            padding: 0 var(--spacing-xl);
        }
        .person-card {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-lg);
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-sm);
            cursor: pointer;
        }
        .person-card:hover {
            background: var(--bg-tertiary);
        }
        .person-avatar {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-full);
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--text-primary);
        }
        .person-info {
            flex: 1;
        }
        .person-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        .person-status {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        /* Session dashboard styles */
        .context-card {
            margin: 0 var(--spacing-xl) var(--spacing-md);
            padding: var(--spacing-lg);
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }
        .context-label {
            font-size: var(--font-size-xs);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--spacing-sm);
        }
        .context-text {
            font-size: var(--font-size-base);
            color: var(--text-primary);
            line-height: 1.5;
        }
        .ready-btn {
            margin: var(--spacing-xl);
            padding: var(--spacing-lg);
            background: var(--accent);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-size-lg);
            font-weight: 600;
            width: calc(100% - 40px);
            cursor: pointer;
        }
        .ready-btn:hover {
            background: var(--accent-hover);
        }

        .advance-bar {
            background: var(--bg-secondary);
            padding: var(--spacing-md) var(--spacing-xl);
            display: none;
            justify-content: center;
            border-top: 1px solid var(--border);
        }
        .advance-bar.visible {
            display: flex;
        }
        .advance-bar .btn {
            width: 100%;
        }

        /* Private Ranking Styles */
        .ranking-container {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin: var(--spacing-md) 0;
            border: 1px solid var(--border);
        }
        .ranking-header {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            margin-bottom: var(--spacing-md);
        }
        .ranking-instruction {
            font-size: var(--font-size-xs);
            color: var(--text-muted);
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        .ranking-instruction svg {
            flex-shrink: 0;
        }
        .ranking-options {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }
        .ranking-option {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .ranking-option:hover {
            border-color: var(--accent);
        }
        .ranking-option.selected {
            border-color: var(--accent);
            background: rgba(16, 163, 127, 0.1);
        }
        .ranking-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }
        .ranking-option.selected .ranking-checkbox {
            background: var(--accent);
            border-color: var(--accent);
        }
        .ranking-option.selected .ranking-checkbox::after {
            content: '\\2713';
            color: white;
            font-size: 14px;
            font-weight: bold;
        }
        .ranking-text {
            flex: 1;
            font-size: var(--font-size-sm);
            color: var(--text-primary);
        }
        .ranking-submit {
            margin-top: var(--spacing-lg);
            width: 100%;
        }

        /* Overlap Reveal Styles */
        .overlap-container {
            margin: var(--spacing-md) 0;
        }
        .overlap-section {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            border: 1px solid var(--border);
        }
        .overlap-section.matched {
            border-color: var(--accent);
            background: rgba(16, 163, 127, 0.05);
        }
        .overlap-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }
        .overlap-icon {
            font-size: 20px;
        }
        .overlap-title {
            font-size: var(--font-size-sm);
            font-weight: 600;
            color: var(--text-primary);
        }
        .overlap-subtitle {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            margin-left: auto;
        }
        .overlap-items {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }
        .overlap-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            color: var(--text-primary);
        }
        .overlap-item.matched {
            background: rgba(16, 163, 127, 0.15);
        }
        .overlap-item-icon {
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="phone-frame">
        <!-- Header -->
        <header class="header">
            <a href="features/index.html" class="header-back">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                All Demos
            </a>
            <div class="header-top">
                <div class="header-logo" id="headerLogo">BeHeard</div>
                <div class="header-stage" id="headerStage">Quick Preview</div>
            </div>
            <div class="stage-progress" id="stageProgress">
                <div class="stage-dot current" data-stage="0"></div>
                <div class="stage-line"></div>
                <div class="stage-dot" data-stage="1"></div>
                <div class="stage-line"></div>
                <div class="stage-dot" data-stage="2"></div>
                <div class="stage-line"></div>
                <div class="stage-dot" data-stage="3"></div>
                <div class="stage-line"></div>
                <div class="stage-dot" data-stage="4"></div>
            </div>
        </header>

        <!-- Content Area -->
        <div class="content-area has-input-and-emotion" id="contentArea">
            <!-- Dynamic content -->
        </div>

        <!-- Advance Bar (appears between content and input when visible) -->
        <div class="advance-bar" id="advanceBar">
            <button class="btn btn-primary" id="advanceBtn">Continue</button>
        </div>

        <!-- Emotion Bar -->
        <div class="emotion-bar" id="emotionBar">
            <div class="emotion-header">
                <span class="emotion-label">How are you feeling?</span>
                <span class="emotion-value" id="emotionValue">5</span>
            </div>
            <input type="range" class="emotion-slider" id="emotionSlider" min="1" max="10" value="5">
            <div class="emotion-labels">
                <span>Calm</span>
                <span>Elevated</span>
                <span>Intense</span>
            </div>
        </div>

        <!-- Input Area -->
        <div class="input-area" id="inputArea">
            <div class="input-wrapper">
                <textarea class="input-field" id="inputField" placeholder="Share your thoughts..." rows="1"></textarea>
            </div>
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Cooling Modal -->
    <div class="modal-overlay" id="coolingModal">
        <div class="modal">
            <div class="modal-icon">&#128524;</div>
            <div class="modal-title">Taking a Moment</div>
            <div class="modal-text">Your emotions are running high, and that is completely understandable. Let us pause and take a breath together.</div>
            <button class="btn btn-primary" onclick="closeCoolingModal()">I am ready to continue</button>
        </div>
    </div>

    <script>
        // ========== STATE ==========
        const State = {
            currentStage: -1, // -1 = dashboard, 0-4 = stages
            currentStep: 0,
            emotionLevel: 5,
            messages: [],
            flags: {
                compactSigned: false,
                feltHeard: false,
                mirrorTriggered: false,
                accuracyPassed: false,
                reflectionReceived: false,
                needsConfirmed: false,
                agreementMade: false
            }
        };

        // ========== MOCK DATA ==========
        const MockData = {
            scenario: {
                userName: "Alex",
                partnerName: "Jordan",
                topic: "household responsibilities"
            },

            stages: {
                0: {
                    name: "Onboarding",
                    compact: [
                        "Approach this process with curiosity rather than certainty",
                        "Allow the AI to guide the pace of our work together",
                        "Share honestly within my private space",
                        "Consider the other perspective when presented",
                        "Focus on understanding needs rather than winning",
                        "Take breaks when emotions run high"
                    ]
                },
                1: {
                    name: "The Witness",
                    opening: [
                        "This is a safe space for you to share what is on your mind. Take your time - there is no rush here.",
                        "What happened that brought you here today?"
                    ],
                    reflections: [
                        "I hear you. That sounds really difficult. When you describe always being the one to take care of things, it sounds like there is a lot of frustration there - and maybe some hurt underneath?",
                        "So what I am hearing is that you feel invisible sometimes, like your efforts go unnoticed. That must be exhausting.",
                        "That makes complete sense. It sounds like beneath the frustration, there is a real need for partnership - for feeling like you are in this together.",
                        "Thank you for sharing that with me. I can see how much this matters to you. You want to feel valued and seen for everything you do."
                    ]
                },
                2: {
                    name: "Perspective Stretch",
                    partnerPerspective: {
                        summary: "Jordan shared that they often feel criticized about how they help around the house. They mentioned that their contributions - like managing finances, handling repairs, and yard work - seem to go unacknowledged. They feel like no matter what they do, it is never quite right.",
                        needs: ["Recognition for their contributions", "Clarity on expectations", "Feeling competent rather than criticized"]
                    },
                    opening: [
                        "Before we look at what Jordan shared, I want to give you a moment to reflect.",
                        "Thinking about Jordan right now - what do you imagine they might be feeling about this situation?"
                    ],
                    ventingResponse: "I hear that frustration. It makes sense you would feel that way after everything you have been carrying. Take a moment - is there anything else you need to express before we continue?",
                    empathyPrompt: "Now that you have had space to express that - if you step back for a moment, what do you think Jordan might genuinely need from this relationship?",
                    mirrorIntervention: "I notice some strong feelings coming up. That reaction makes sense given your own pain. But before we go further - if you set aside the hurt for a moment, what might Jordan be experiencing that leads them to see things this way?",
                    reflections: [
                        "That is insightful. You are starting to consider what Jordan might be experiencing, even before hearing their words.",
                        "That shows real empathy. Now let me share what Jordan actually expressed, so you can see how your intuition compares:"
                    ],
                    empathyExchange: {
                        intro: "You have done meaningful work here. Now I would like to offer you something: a reflection of how Jordan experiences you. Would you be open to hearing it?",
                        reflection: "Jordan experiences you as someone who cares deeply about your home and family. They also shared that sometimes they feel like nothing they do measures up - that there is always another task or another way they have fallen short. They want to be a good partner but feel uncertain about how."
                    }
                },
                3: {
                    name: "Need Mapping",
                    yourNeeds: [
                        { name: "Partnership", desc: "Feeling like you work together as a team" },
                        { name: "Recognition", desc: "Having your efforts seen and appreciated" },
                        { name: "Fairness", desc: "An equitable sharing of responsibilities" }
                    ],
                    partnerNeeds: [
                        { name: "Recognition", desc: "Having their contributions acknowledged" },
                        { name: "Clarity", desc: "Knowing what is expected" },
                        { name: "Competence", desc: "Feeling capable, not constantly falling short" }
                    ],
                    commonGround: {
                        need: "Recognition",
                        insight: "You both want to feel that your contributions matter and are truly seen by the other."
                    },
                    opening: [
                        "Looking at everything you have both shared, I can see some core needs emerging.",
                        "Let me show you what I have identified:"
                    ]
                },
                4: {
                    name: "Strategic Repair",
                    opening: [
                        "Now comes the most important part: turning understanding into action.",
                        "Based on everything we have discussed, what is one small thing you could try doing differently? Think of something specific and time-bounded."
                    ],
                    refinementPrompt: "That is a good starting point. Let me help you make it even more concrete - how often would you do this, and for how long would you try it?",
                    // All suggestions from both parties - presented without labels
                    allStrategies: [
                        "Weekly 15-min planning session on Sundays",
                        "Say one specific appreciation each morning",
                        "Create a shared task list we both update",
                        "Take turns choosing weekend activities",
                        "5-minute check-in before bed each night"
                    ],
                    collectiveMessage: "Here is what we have come up with so far. Are you happy with these options, or would you like me to try and generate a few more to explore?",
                    agreement: {
                        text: "For the next two weeks: 15-minute Sunday planning session + share one specific appreciation each day",
                        checkIn: "Two weeks from today"
                    }
                }
            }
        };

        // ========== STAGE TITLES ==========
        const StageTitles = {
            '-1': "Home",
            0: "Onboarding",
            1: "Stage 1: The Witness",
            2: "Stage 2: Perspective Stretch",
            3: "Stage 3: Need Mapping",
            4: "Stage 4: Strategic Repair"
        };

        // ========== RENDER FUNCTIONS ==========
        function updateHeader() {
            // Update logo and stage text based on current state
            if (State.currentStage === -1) {
                document.getElementById('headerLogo').textContent = 'BeHeard';
                document.getElementById('headerStage').textContent = 'Home';
            } else {
                document.getElementById('headerLogo').textContent = 'Session with Jordan';
                document.getElementById('headerStage').textContent = StageTitles[State.currentStage];
            }

            // Update stage progress dots (only for stages 0-4)
            document.querySelectorAll('.stage-dot').forEach((dot, i) => {
                dot.classList.remove('completed', 'current');
                if (State.currentStage >= 0) {
                    if (i < State.currentStage) {
                        dot.classList.add('completed');
                    } else if (i === State.currentStage) {
                        dot.classList.add('current');
                    }
                }
            });

            document.querySelectorAll('.stage-line').forEach((line, i) => {
                line.classList.toggle('completed', State.currentStage >= 0 && i < State.currentStage);
            });
        }

        function renderContent() {
            const content = document.getElementById('contentArea');
            content.innerHTML = '';
            State.messages = [];
            State.currentStep = 0;
            hideAdvanceBar();

            switch(State.currentStage) {
                case -1: renderDashboard(); break;
                case 0: renderStage0(); break;
                case 1: renderStage1(); break;
                case 2: renderStage2(); break;
                case 3: renderStage3(); break;
                case 4: renderStage4(); break;
            }

            updateHeader();
        }

        // ========== DASHBOARD (PRE-STAGE) ==========
        function renderDashboard() {
            const header = document.querySelector('.header');
            const content = document.getElementById('contentArea');
            document.getElementById('emotionBar').classList.add('hidden');
            document.getElementById('inputArea').classList.add('hidden');

            // Hide stage progress for dashboard
            document.getElementById('stageProgress').classList.add('hidden');

            content.innerHTML = `
                <div class="dashboard-view">
                    <div class="hero-card" onclick="goToSessionDashboard()">
                        <div class="hero-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                                <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                            </svg>
                        </div>
                        <div class="hero-title">Start a new session with Jordan</div>
                        <div class="hero-subtitle">Work through something together</div>
                        <button class="hero-btn">
                            Begin
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                        </button>
                    </div>

                    <div class="section-title">My People</div>
                    <div class="person-list">
                        <div class="person-card" onclick="goToSessionDashboard()">
                            <div class="person-avatar">J</div>
                            <div class="person-info">
                                <div class="person-name">Jordan</div>
                                <div class="person-status">Ready to start</div>
                            </div>
                        </div>
                    </div>

                    <div class="section-title">Inner Work</div>
                    <div class="person-list">
                        <div class="person-card" style="opacity: 0.6;">
                            <div class="person-avatar" style="background: var(--accent);">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 16v-4M12 8h.01"/>
                                </svg>
                            </div>
                            <div class="person-info">
                                <div class="person-name">Process something alone</div>
                                <div class="person-status">Inner Work mode</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function goToSessionDashboard() {
            const content = document.getElementById('contentArea');
            document.getElementById('stageProgress').classList.remove('hidden');

            // Update header to show session context
            document.getElementById('headerLogo').textContent = 'Session with Jordan';
            document.getElementById('headerStage').textContent = 'Preparation';

            content.innerHTML = `
                <div class="context-card">
                    <div class="context-label">About this process</div>
                    <div class="context-text">BeHeard guides you through 5 stages to help you and Jordan understand each other and find resolution together.</div>
                </div>

                <div class="context-card">
                    <div class="context-label">What to expect</div>
                    <div class="context-text">You will each share your perspective privately, then work together to find common ground and create agreements.</div>
                </div>

                <button class="ready-btn" onclick="startOnboarding()">Ready to Begin</button>
            `;
        }

        function startOnboarding() {
            State.currentStage = 0;
            document.getElementById('stageProgress').classList.remove('hidden');
            renderContent();
        }

        // ========== STAGE 0: ONBOARDING ==========
        function renderStage0() {
            const content = document.getElementById('contentArea');
            const data = MockData.stages[0];
            document.getElementById('emotionBar').classList.add('hidden');
            document.getElementById('inputArea').classList.add('hidden');

            // Go directly to Curiosity Compact (no splash screen)
            content.innerHTML = `
                <div class="message ai">Congratulations ${MockData.scenario.userName}, you have taken the first step towards strengthening your connections. Are you open to me guiding you and ${MockData.scenario.partnerName} through a process where you both can be heard? I think there is a way we can find a win-win here.</div>
                <div class="compact-container">
                    <div class="compact-title">The Curiosity Compact</div>
                    <div class="compact-terms">
                        ${data.compact.map(term => `<div class="compact-term">${term}</div>`).join('')}
                    </div>
                    <div class="compact-agree">
                        <input type="checkbox" id="compactCheck" onchange="updateSignButton()">
                        <label for="compactCheck">I commit to approaching this with curiosity</label>
                    </div>
                    <button class="btn btn-primary" id="signBtn" disabled onclick="signCompact()">Sign and Begin</button>
                </div>
            `;
        }

        function updateSignButton() {
            const check = document.getElementById('compactCheck');
            document.getElementById('signBtn').disabled = !check.checked;
        }

        function signCompact() {
            State.flags.compactSigned = true;
            showWaitingRoom();
        }

        function showWaitingRoom() {
            const content = document.getElementById('contentArea');
            content.innerHTML = '';

            // Partner status card
            const card = document.createElement('div');
            card.className = 'partner-status';
            card.innerHTML = `
                <div class="partner-avatar">J</div>
                <div class="partner-name">${MockData.scenario.partnerName}</div>
                <div class="partner-stage">Reviewing the Curiosity Compact...</div>
            `;
            content.appendChild(card);

            // AI message
            const msg = document.createElement('div');
            msg.className = 'message ai';
            msg.textContent = `You have signed the Curiosity Compact. Now we wait for ${MockData.scenario.partnerName} to review and sign as well.`;
            content.appendChild(msg);

            // Waiting options
            setTimeout(() => {
                const optionsMsg = document.createElement('div');
                optionsMsg.className = 'message ai';
                optionsMsg.textContent = 'While you wait, here are some things you can do:';
                content.appendChild(optionsMsg);

                const options = document.createElement('div');
                options.className = 'partner-options';
                options.id = 'waitingOptions';
                options.innerHTML = `
                    <button class="btn btn-outline" onclick="reviewCompact()">Review the Compact</button>
                    <button class="btn btn-outline" onclick="previewStages()">What to expect</button>
                    <button class="btn btn-outline" onclick="takeBreakStage0()">Take a break</button>
                `;
                content.appendChild(options);
                content.scrollTop = content.scrollHeight;

                // Simulate partner signing after delay
                setTimeout(() => {
                    showPartnerSigned();
                }, 5000);
            }, 500);
        }

        function reviewCompact() {
            const content = document.getElementById('contentArea');
            document.getElementById('waitingOptions').classList.add('hidden');

            const data = MockData.stages[0];
            const panel = document.createElement('div');
            panel.className = 'panel';
            panel.innerHTML = `
                <div class="panel-header">Your Commitment</div>
                <div class="panel-content">
                    ${data.compact.map(term => `<div style="padding: 8px 0; border-bottom: 1px solid var(--border);">${term}</div>`).join('')}
                </div>
            `;
            content.appendChild(panel);

            setTimeout(() => {
                addBackToWaitingButton();
            }, 500);
        }

        function previewStages() {
            const content = document.getElementById('contentArea');
            document.getElementById('waitingOptions').classList.add('hidden');

            const stages = [
                { num: 1, name: 'The Witness', desc: 'Share your experience and feel fully heard' },
                { num: 2, name: 'Perspective Stretch', desc: 'Understand your partner\'s point of view' },
                { num: 3, name: 'Need Mapping', desc: 'Identify the needs beneath the conflict' },
                { num: 4, name: 'Strategic Repair', desc: 'Create agreements that work for both' }
            ];

            const panel = document.createElement('div');
            panel.className = 'panel';
            panel.innerHTML = `
                <div class="panel-header">The Journey Ahead</div>
                <div class="panel-content">
                    ${stages.map(s => `<div style="padding: 10px 0; border-bottom: 1px solid var(--border);"><strong>Stage ${s.num}: ${s.name}</strong><br><span style="color: var(--text-secondary); font-size: 13px;">${s.desc}</span></div>`).join('')}
                </div>
            `;
            content.appendChild(panel);

            setTimeout(() => {
                addBackToWaitingButton();
            }, 500);
        }

        function takeBreakStage0() {
            const content = document.getElementById('contentArea');
            document.getElementById('waitingOptions').classList.add('hidden');

            const msg = document.createElement('div');
            msg.className = 'message ai';
            msg.textContent = `Taking a break is healthy. We will notify you when ${MockData.scenario.partnerName} has signed the Compact.`;
            content.appendChild(msg);

            setTimeout(() => {
                const panel = document.createElement('div');
                panel.className = 'panel';
                panel.innerHTML = `
                    <div class="panel-header">Notification Settings</div>
                    <div class="panel-content">You will receive a notification when ${MockData.scenario.partnerName} signs. Take the time you need.</div>
                `;
                content.appendChild(panel);
                addBackToWaitingButton();
            }, 1000);
        }

        function addBackToWaitingButton() {
            const content = document.getElementById('contentArea');
            const container = document.createElement('div');
            container.style.padding = 'var(--spacing-md)';
            container.style.textAlign = 'center';
            const btn = document.createElement('button');
            btn.className = 'btn btn-outline';
            btn.textContent = 'Back to waiting';
            btn.onclick = showWaitingRoom;
            container.appendChild(btn);
            content.appendChild(container);
            content.scrollTop = content.scrollHeight;
        }

        function showPartnerSigned() {
            const content = document.getElementById('contentArea');

            // Update partner status
            const statusEl = document.querySelector('.partner-stage');
            if (statusEl) statusEl.textContent = 'Has signed the Curiosity Compact';

            // Show notification
            const notification = document.createElement('div');
            notification.className = 'agreement-card';
            notification.innerHTML = `<h3><span>&#10003;</span> ${MockData.scenario.partnerName} has signed</h3><p>You are both ready to begin the process.</p>`;
            content.appendChild(notification);
            content.scrollTop = content.scrollHeight;

            setTimeout(() => {
                showAdvanceBar('Start Stage 1', false);
            }, 1000);
        }

        // ========== STAGE 1: THE WITNESS ==========
        function renderStage1() {
            document.getElementById('emotionBar').classList.remove('hidden');
            document.getElementById('inputArea').classList.remove('hidden');

            const data = MockData.stages[1];
            addAIMessage(data.opening[0]);
            setTimeout(() => {
                addAIMessage(data.opening[1]);
                // No suggested options - Stage 1 is open-ended to assess AI listening quality
            }, 1500);
        }

        // ========== STAGE 2: PERSPECTIVE STRETCH ==========
        function renderStage2() {
            document.getElementById('emotionBar').classList.remove('hidden');
            document.getElementById('inputArea').classList.remove('hidden');

            const data = MockData.stages[2];

            // Stage 2 now starts by creating space for empathy, not presenting partner's words
            addAIMessage(data.opening[0]);
            setTimeout(() => {
                addAIMessage(data.opening[1]);
                // Open-ended - user types their response
            }, 1500);
        }

        // ========== STAGE 3: NEED MAPPING ==========
        function renderStage3() {
            document.getElementById('emotionBar').classList.remove('hidden');
            document.getElementById('inputArea').classList.remove('hidden');

            const data = MockData.stages[3];

            addAIMessage(data.opening[0]);
            setTimeout(() => {
                addAIMessage(data.opening[1]);
                setTimeout(() => {
                    addNeedsGrid(data);
                    setTimeout(() => {
                        addAIMessage("Do you see yourself in these needs? Does this feel accurate?");
                        // Open-ended - user types their response
                    }, 1000);
                }, 1000);
            }, 1500);
        }

        // ========== STAGE 4: STRATEGIC REPAIR ==========
        function renderStage4() {
            document.getElementById('emotionBar').classList.remove('hidden');
            document.getElementById('inputArea').classList.remove('hidden');

            const data = MockData.stages[4];

            // Stage 4 now starts by inviting the user to suggest their own strategies
            addAIMessage(data.opening[0]);
            setTimeout(() => {
                addAIMessage(data.opening[1]);
                // No suggestions - user proposes their own ideas first
            }, 1500);
        }

        function addStrategiesGrid(strategies, message) {
            const content = document.getElementById('contentArea');
            const container = document.createElement('div');
            container.className = 'strategies-container';
            container.innerHTML = `
                <div class="strategies-header">${message}</div>
                <div class="strategies-grid">
                    ${strategies.map(s => `<button class="strategy-btn" onclick="selectStrategy(this, '${s.replace(/'/g, "\\'")}')">${s}</button>`).join('')}
                </div>
            `;
            content.appendChild(container);
            content.scrollTop = content.scrollHeight;
        }

        function selectStrategy(btn, strategy) {
            btn.classList.toggle('selected');
        }

        // Store user selections for ranking
        let userRankingSelections = [];

        function showPrivateRanking(strategies) {
            const content = document.getElementById('contentArea');
            userRankingSelections = [];

            const container = document.createElement('div');
            container.className = 'ranking-container';
            container.id = 'rankingContainer';
            container.innerHTML = `
                <div class="ranking-header">Select Your Top Choices</div>
                <div class="ranking-instruction">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 16v-4M12 8h.01"/>
                    </svg>
                    Jordan will not see your picks until you both submit
                </div>
                <div class="ranking-options" id="rankingOptions">
                    ${strategies.map((s, i) => `
                        <div class="ranking-option" onclick="toggleRankingOption(this, ${i})">
                            <div class="ranking-checkbox"></div>
                            <div class="ranking-text">${s}</div>
                        </div>
                    `).join('')}
                </div>
                <button class="btn btn-primary ranking-submit" onclick="submitRanking()">Submit My Ranking</button>
            `;
            content.appendChild(container);
            content.scrollTop = content.scrollHeight;

            // Store strategies for later
            window.currentStrategies = strategies;
        }

        function toggleRankingOption(el, index) {
            el.classList.toggle('selected');
            const strategy = window.currentStrategies[index];
            if (el.classList.contains('selected')) {
                if (!userRankingSelections.includes(strategy)) {
                    userRankingSelections.push(strategy);
                }
            } else {
                userRankingSelections = userRankingSelections.filter(s => s !== strategy);
            }
        }

        function submitRanking() {
            if (userRankingSelections.length === 0) {
                addAIMessage("Please select at least one strategy before submitting.");
                return;
            }

            // Remove ranking container
            const rankingContainer = document.getElementById('rankingContainer');
            if (rankingContainer) rankingContainer.remove();

            addUserMessage(`Selected ${userRankingSelections.length} strategies`);

            showTyping();
            setTimeout(() => {
                hideTyping();
                addAIMessage("Thank you. Jordan has also submitted their choices. Let me show you where you overlap...");

                setTimeout(() => {
                    showOverlapReveal();
                }, 1500);
            }, 1500);
        }

        function showOverlapReveal() {
            const content = document.getElementById('contentArea');

            // Simulate Jordan's picks - they match some of the user's selections
            const jordanPicks = [
                "Weekly 15-min planning session on Sundays",
                "Say one specific appreciation each morning",
                "5-minute check-in before bed each night"
            ];

            // Find overlaps
            const overlaps = userRankingSelections.filter(s => jordanPicks.includes(s));
            const userOnly = userRankingSelections.filter(s => !jordanPicks.includes(s));
            const jordanOnly = jordanPicks.filter(s => !userRankingSelections.includes(s));

            const container = document.createElement('div');
            container.className = 'overlap-container';
            container.id = 'overlapContainer';

            let html = '';

            // Show matches section
            if (overlaps.length > 0) {
                html += `
                    <div class="overlap-section matched">
                        <div class="overlap-header">
                            <span class="overlap-icon">&#10003;</span>
                            <span class="overlap-title">You Both Chose</span>
                            <span class="overlap-subtitle">${overlaps.length} match${overlaps.length > 1 ? 'es' : ''}</span>
                        </div>
                        <div class="overlap-items">
                            ${overlaps.map(s => `
                                <div class="overlap-item matched">
                                    <span class="overlap-item-icon">&#128154;</span>
                                    ${s}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Show unique selections
            if (userOnly.length > 0 || jordanOnly.length > 0) {
                html += `
                    <div class="overlap-section">
                        <div class="overlap-header">
                            <span class="overlap-icon">&#128100;</span>
                            <span class="overlap-title">Only One of You Chose</span>
                        </div>
                        <div class="overlap-items">
                            ${userOnly.map(s => `
                                <div class="overlap-item">
                                    <span class="overlap-item-icon">You:</span>
                                    ${s}
                                </div>
                            `).join('')}
                            ${jordanOnly.map(s => `
                                <div class="overlap-item">
                                    <span class="overlap-item-icon">Jordan:</span>
                                    ${s}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
            content.appendChild(container);
            content.scrollTop = content.scrollHeight;

            // Continue with the flow
            setTimeout(() => {
                if (overlaps.length > 0) {
                    addAIMessage(`Great news! You both chose ${overlaps.length === 1 ? 'the same strategy' : overlaps.length + ' strategies in common'}. This gives you a strong foundation.`);
                } else {
                    addAIMessage("Your choices are different, but that is okay. Let us discuss which ones feel most important to each of you.");
                }

                setTimeout(() => {
                    finalizeAgreementFromOverlap(overlaps);
                }, 2000);
            }, 1500);
        }

        function finalizeAgreementFromOverlap(overlaps) {
            const data = MockData.stages[4];

            if (overlaps.length > 0) {
                addAIMessage("Based on your shared choices, here is your agreement:");
            } else {
                addAIMessage("After discussing, you have found common ground:");
            }

            setTimeout(() => {
                addAgreement(data.agreement);
                setTimeout(() => {
                    showStageCompletion("Resolution Complete", "You and Jordan have completed the BeHeard process and reached an agreement. Remember: this is an experiment. You will check in together in two weeks.", "Finish Demo", true);
                }, 1500);
            }, 1000);
        }

        // ========== MESSAGE HELPERS ==========
        function addAIMessage(text) {
            const content = document.getElementById('contentArea');
            const msg = document.createElement('div');
            msg.className = 'message ai';
            msg.textContent = text;
            content.appendChild(msg);
            State.messages.push({ type: 'ai', text });
            content.scrollTop = content.scrollHeight;
        }

        function addUserMessage(text) {
            const content = document.getElementById('contentArea');
            const msg = document.createElement('div');
            msg.className = 'message user';
            msg.textContent = text;
            content.appendChild(msg);
            State.messages.push({ type: 'user', text });
            content.scrollTop = content.scrollHeight;
        }

        function addInterventionMessage(text) {
            const content = document.getElementById('contentArea');
            const msg = document.createElement('div');
            msg.className = 'message intervention';
            msg.textContent = text;
            content.appendChild(msg);
            content.scrollTop = content.scrollHeight;
        }

        function showTyping() {
            const content = document.getElementById('contentArea');
            const typing = document.createElement('div');
            typing.className = 'typing-indicator';
            typing.id = 'typingIndicator';
            typing.innerHTML = '<span></span><span></span><span></span>';
            content.appendChild(typing);
            content.scrollTop = content.scrollHeight;
        }

        function hideTyping() {
            const typing = document.getElementById('typingIndicator');
            if (typing) typing.remove();
        }

        function addPanel(title, text) {
            const content = document.getElementById('contentArea');
            const panel = document.createElement('div');
            panel.className = 'panel';
            panel.innerHTML = `
                <div class="panel-header">${title}</div>
                <div class="panel-content">${text}</div>
            `;
            content.appendChild(panel);
            content.scrollTop = content.scrollHeight;
        }

        function addNeedsList(title, needs) {
            const content = document.getElementById('contentArea');
            const panel = document.createElement('div');
            panel.className = 'panel';
            panel.innerHTML = `
                <div class="panel-header">${title}</div>
                <div class="panel-content">
                    ${needs.map(n => `<div class="need-card">${n}</div>`).join('')}
                </div>
            `;
            content.appendChild(panel);
            content.scrollTop = content.scrollHeight;
        }

        function addNeedsGrid(data) {
            const content = document.getElementById('contentArea');
            const grid = document.createElement('div');
            grid.className = 'needs-grid';
            grid.innerHTML = `
                <div class="needs-column">
                    <h4>Your Needs</h4>
                    ${data.yourNeeds.map(n => `<div class="need-card ${n.name === data.commonGround.need ? 'common' : ''}">${n.name}</div>`).join('')}
                </div>
                <div class="needs-column">
                    <h4>Their Needs</h4>
                    ${data.partnerNeeds.map(n => `<div class="need-card ${n.name === data.commonGround.need ? 'common' : ''}">${n.name}</div>`).join('')}
                </div>
                <div class="common-ground">
                    <h4>Common Ground</h4>
                    <strong>${data.commonGround.need}</strong><br>
                    <span style="font-size: 13px; color: var(--text-secondary);">${data.commonGround.insight}</span>
                </div>
            `;
            content.appendChild(grid);
            content.scrollTop = content.scrollHeight;
        }

        function addProposal(proposal) {
            const content = document.getElementById('contentArea');
            const card = document.createElement('div');
            card.className = 'proposal-card incoming';
            card.innerHTML = `
                <h4>${proposal.from}'s Proposal</h4>
                <div class="proposal-text">${proposal.text}</div>
            `;
            content.appendChild(card);
            content.scrollTop = content.scrollHeight;
        }

        function addAgreement(agreement) {
            const content = document.getElementById('contentArea');
            const card = document.createElement('div');
            card.className = 'agreement-card';
            card.innerHTML = `
                <h3><span>&#10003;</span> Agreement Reached</h3>
                <p>${agreement.text}</p>
                <p style="margin-top: 12px; font-size: 13px; color: var(--text-secondary);">Check-in scheduled: ${agreement.checkIn}</p>
            `;
            content.appendChild(card);
            content.scrollTop = content.scrollHeight;
        }


        // ========== MESSAGE HANDLING ==========
        function sendMessage() {
            const input = document.getElementById('inputField');
            const text = input.value.trim();
            if (!text) return;

            processMessage(text);
            input.value = '';
            input.style.height = 'auto';
        }

        function processMessage(text) {
            addUserMessage(text);

            // Check for judgment patterns in Stage 2
            if (State.currentStage === 2 && !State.flags.mirrorTriggered) {
                const judgmentPattern = /never|always|selfish|lazy|does not care|doesn't care/i;
                if (judgmentPattern.test(text)) {
                    State.flags.mirrorTriggered = true;
                    showTyping();
                    setTimeout(() => {
                        hideTyping();
                        addInterventionMessage(MockData.stages[2].mirrorIntervention);
                        // Open-ended - user types their response
                    }, 2000);
                    return;
                }
            }

            showTyping();
            setTimeout(() => {
                hideTyping();
                respondToMessage(text);
            }, 1500 + Math.random() * 1000);
        }

        function respondToMessage(text) {
            State.currentStep++;
            const stage = State.currentStage;
            const step = State.currentStep;
            const data = MockData.stages[stage];

            switch(stage) {
                case 1: handleStage1Response(text, step, data); break;
                case 2: handleStage2Response(text, step, data); break;
                case 3: handleStage3Response(text, step, data); break;
                case 4: handleStage4Response(text, step, data); break;
            }
        }

        function handleStage1Response(text, step, data) {
            if (step <= data.reflections.length) {
                addAIMessage(data.reflections[step - 1]);
                // No suggested options - Stage 1 is fully open-ended
                // This allows assessment of how well the AI listens and reframes
                if (step >= 3) {
                    showCompletionCheck("Do you feel fully heard?", "Not yet", "Yes, I feel heard", () => {
                        showStageCompletion("Stage 1 Complete", "You have been witnessed. When Jordan completes their session, you will both move to understanding each other's perspective.", "Continue to Stage 2");
                    });
                }
            }
        }

        function handleStage2Response(text, step, data) {
            // Check for venting/frustration patterns
            const ventingPattern = /frustrated|angry|annoyed|mad|unfair|they never|they always|selfish|lazy|does not care|doesn't care/i;
            const isVenting = ventingPattern.test(text);

            if (!State.flags.reflectionReceived) {
                if (step === 1) {
                    if (isVenting) {
                        // Allow space for venting first
                        addAIMessage(data.ventingResponse);
                        // Open-ended - user types their response
                    } else {
                        // They attempted empathy - acknowledge it
                        addAIMessage(data.reflections[0]);
                        // Open-ended - user types their response
                    }
                } else if (step === 2) {
                    if (State.flags.mirrorTriggered) {
                        addAIMessage(data.mirrorIntervention);
                        // Open-ended - user types their response
                        State.flags.mirrorTriggered = false;
                    } else {
                        // Now reveal what partner actually shared
                        addAIMessage(data.reflections[1]);
                        setTimeout(() => {
                            addPanel("What Jordan Shared", data.partnerPerspective.summary);
                            addNeedsList("Their Core Needs", data.partnerPerspective.needs);
                            setTimeout(() => {
                                addAIMessage("How does this compare to what you imagined?");
                                // Open-ended - user types their response
                            }, 1000);
                        }, 1500);
                    }
                } else if (step === 3) {
                    addAIMessage(data.empathyExchange.intro);
                    // Open-ended - user types their response
                } else if (step === 4) {
                    addAIMessage(data.empathyExchange.reflection);
                    State.flags.reflectionReceived = true;
                    setTimeout(() => {
                        showCompletionCheck("Does this reflection feel accurate?", "Not quite", "Yes, I see myself in this", () => {
                            showStageCompletion("Stage 2 Complete", "You have stretched your perspective and received Jordan's reflection of you. Now let us identify the core needs.", "Continue to Stage 3");
                        });
                    }, 2000);
                }
            }
        }

        function handleStage3Response(text, step, data) {
            if (step === 1) {
                addAIMessage("Good. These needs - partnership, recognition, fairness for you, and recognition, clarity, competence for Jordan - will guide our repair work.");
                setTimeout(() => {
                    addAIMessage("Notice that you both share a need for Recognition. This is your common ground - the foundation for moving forward.");
                    showCompletionCheck("Ready to move to repair?", "I need more time", "Yes, let us continue", () => {
                        showStageCompletion("Stage 3 Complete", "You have identified your needs and found common ground. Now let us turn understanding into action.", "Continue to Stage 4");
                    });
                }, 2000);
            }
        }

        function handleStage4Response(text, step, data) {
            if (step === 1) {
                // User proposed their first strategy
                addAIMessage(data.refinementPrompt);
                // Let them refine with open text
            } else if (step === 2) {
                // After refinement, show that Jordan has also contributed
                addAIMessage("Great. I have also collected some ideas from Jordan. Let me combine everything you have both come up with.");
                setTimeout(() => {
                    addStrategiesGrid(data.allStrategies, data.collectiveMessage);
                    // Open-ended - user types their response
                }, 1500);
            } else if (step === 3) {
                if (text.toLowerCase().includes("more")) {
                    // Generate more ideas
                    addAIMessage("Let me think of a few more based on your shared needs...");
                    setTimeout(() => {
                        const moreStrategies = [
                            ...data.allStrategies,
                            "Text each other one thing you are grateful for at lunch",
                            "Alternate who handles bedtime routine each night"
                        ];
                        addStrategiesGrid(moreStrategies, "Here are some additional options:");
                        window.currentStrategiesForRanking = moreStrategies;
                        // Open-ended - user types their response
                    }, 1500);
                } else {
                    // Ready for private ranking
                    addAIMessage("Now it is time to privately rank your top choices. Jordan will do the same, and then we will reveal where you overlap.");
                    setTimeout(() => {
                        // Use current strategies or default
                        const strategies = window.currentStrategiesForRanking || data.allStrategies;
                        showPrivateRanking(strategies);
                    }, 1500);
                }
            }
            // Step 4+ is now handled by submitRanking and showOverlapReveal
        }

        function showCompletionCheck(question, noText, yesText, onYes) {
            const content = document.getElementById('contentArea');
            const check = document.createElement('div');
            check.className = 'completion-check';
            check.innerHTML = `
                <div class="completion-question">${question}</div>
                <div class="completion-buttons">
                    <button class="btn btn-secondary" onclick="this.parentElement.parentElement.remove(); addAIMessage('Take your time. What else would help you feel complete here?');">
                        ${noText}
                    </button>
                    <button class="btn btn-primary" onclick="this.parentElement.parentElement.remove();">
                        ${yesText}
                    </button>
                </div>
            `;
            check.querySelector('.btn-primary').onclick = () => {
                check.remove();
                onYes();
            };
            content.appendChild(check);
            content.scrollTop = content.scrollHeight;
        }

        // ========== ADVANCE BAR ==========
        function showAdvanceBar(btnText, isFinal = false) {
            const bar = document.getElementById('advanceBar');
            const btn = document.getElementById('advanceBtn');
            btn.textContent = btnText;
            btn.onclick = () => advanceStage(isFinal);
            bar.classList.add('visible');
        }

        function hideAdvanceBar() {
            const bar = document.getElementById('advanceBar');
            if (bar) bar.classList.remove('visible');
        }

        // ========== STAGE COMPLETION ==========
        function showStageCompletion(title, text, btnText, isFinal = false) {
            const content = document.getElementById('contentArea');

            const card = document.createElement('div');
            card.className = 'agreement-card';
            card.innerHTML = `
                <h3><span>&#10003;</span> ${title}</h3>
                <p>${text}</p>
            `;
            content.appendChild(card);
            content.scrollTop = content.scrollHeight;

            setTimeout(() => {
                showAdvanceBar(btnText, isFinal);
            }, 500);
        }

        function advanceStage(isFinal = false) {
            hideAdvanceBar();
            if (isFinal) {
                State.currentStage = -1; // Return to dashboard
                State.flags = {
                    compactSigned: false,
                    feltHeard: false,
                    mirrorTriggered: false,
                    accuracyPassed: false,
                    reflectionReceived: false,
                    needsConfirmed: false,
                    agreementMade: false
                };
            } else {
                State.currentStage++;
            }
            renderContent();
        }

        function closeCoolingModal() {
            document.getElementById('coolingModal').classList.remove('visible');
        }

        // ========== EMOTION SLIDER ==========
        document.getElementById('emotionSlider').addEventListener('input', function() {
            State.emotionLevel = parseInt(this.value);
            document.getElementById('emotionValue').textContent = this.value;

            if (State.emotionLevel >= 9) {
                setTimeout(() => {
                    document.getElementById('coolingModal').classList.add('visible');
                }, 500);
            }
        });

        // ========== INPUT ==========
        document.getElementById('inputField').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        document.getElementById('inputField').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // ========== INIT ==========
        renderContent();
    </script>
</body>
</html>
