---
phase: 10-stage-3-needs-verification
plan: 02
type: execute
wave: 2
depends_on:
  - "10-01"
files_modified:
  - e2e/tests/two-browser-stage-3.spec.ts
  - e2e/playwright.config.ts
autonomous: true
requirements:
  - NEEDS-01
  - NEEDS-02
  - NEEDS-03
  - NEEDS-04

must_haves:
  truths:
    - "Both users can navigate to session and see needs extraction results via UI"
    - "Both users can confirm their needs via UI button click"
    - "Both users complete consent flow (confirm triggers automatic consent)"
    - "Common ground analysis runs after both users consent and displays results to both"
    - "Playwright screenshots capture needs review panel, common ground visualization, and waiting state"
  artifacts:
    - path: "e2e/tests/two-browser-stage-3.spec.ts"
      provides: "Two-browser E2E test for complete Stage 3 flow"
      min_lines: 200
    - path: "e2e/playwright.config.ts"
      provides: "Test project entry for stage-3 two-browser test"
      contains: "two-browser-stage-3"
  key_links:
    - from: "e2e/tests/two-browser-stage-3.spec.ts"
      to: "backend/src/fixtures/stage-3-needs.ts"
      via: "fixture ID in createUserContext header"
      pattern: "stage-3-needs"
    - from: "e2e/tests/two-browser-stage-3.spec.ts"
      to: "mobile/src/screens/NeedMappingScreen.tsx"
      via: "testID selectors in Playwright"
      pattern: "need-mapping-review|confirm-needs-button|common-ground"
---

<objective>
Create a two-browser E2E test that verifies both users can complete the full Stage 3 (Need Mapping) flow via UI interactions with Playwright screenshots documenting each state.

Purpose: Prove that Stage 3 works end-to-end for both users through the actual UI (not just API calls), capturing visual evidence at each step: needs extraction, review/confirmation, consent, waiting states, and common ground discovery.

Output: A comprehensive two-browser Playwright test with 8-10 screenshots documenting the Stage 3 flow, registered as a project in playwright.config.ts.
</objective>

<execution_context>
@/Users/shantam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-stage-3-needs-verification/10-RESEARCH.md
@.planning/phases/10-stage-3-needs-verification/10-01-SUMMARY.md
@e2e/tests/two-browser-stage-2.spec.ts
@e2e/tests/stage-3-4-complete.spec.ts
@e2e/helpers/test-utils.ts
@e2e/helpers/session-builder.ts
@e2e/playwright.config.ts
@backend/src/fixtures/stage-3-needs.ts
@mobile/src/screens/NeedMappingScreen.tsx
@backend/src/controllers/stage3.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create two-browser Stage 3 E2E test</name>
  <files>
    e2e/tests/two-browser-stage-3.spec.ts
    e2e/playwright.config.ts
  </files>
  <action>
Create `e2e/tests/two-browser-stage-3.spec.ts` following the pattern from `two-browser-stage-2.spec.ts` and `two-browser-circuit-breaker.spec.ts`.

**Test structure:**

```typescript
import { test, expect, devices, Page, BrowserContext } from '@playwright/test';
import { cleanupE2EData, getE2EHeaders, SessionBuilder, navigateToShareFromSession } from '../helpers';
```

Use `createUserContext` helper (inline, same as stage-3-4-complete.spec.ts pattern) with `stage-3-needs` fixture for both users.

**Test flow (single test case: 'Complete Stage 3 flow for both users'):**

1. **Setup (beforeEach):**
   - `cleanupE2EData()`
   - `SessionBuilder` with `.startingAt('EMPATHY_REVEALED')`
   - Create two browser contexts with `stage-3-needs` fixture for both users
   - Set timeout to 180000ms (3 minutes)

2. **Navigate both users to session:**
   - Both users goto `${APP_BASE_URL}/session/${sessionId}` with E2E query params
   - Wait for `networkidle`
   - Handle mood check if visible (dismiss via `mood-check-continue-button`)

3. **Trigger needs extraction via API for both users:**
   - Use API helper to call `GET /api/sessions/${sessionId}/needs` for both users (this triggers AI extraction with fixture responses)
   - Wait for needs to be extracted (poll or fixed wait)
   - The fixture's `extract-needs` operation returns 3 deterministic needs per user

4. **Reload pages and verify needs review phase:**
   - Reload both pages
   - Wait for `need-mapping-review` testID to be visible (30s timeout, needs may take time to load)
   - Screenshot: `test-results/stage-3-01-needs-review-user-a.png` and `stage-3-01-needs-review-user-b.png`
   - Verify at least one `[data-testid^="need-"]` element is visible on each page

5. **User A confirms needs:**
   - Click `confirm-needs-button` on pageA
   - Wait 2s for mutation to complete
   - Screenshot: `test-results/stage-3-02-user-a-confirmed.png`
   - User A should now see waiting state (`need-mapping-waiting`) since User B hasn't confirmed yet

6. **User B confirms needs:**
   - Click `confirm-needs-button` on pageB
   - Wait 2s for mutation to complete
   - Screenshot: `test-results/stage-3-02-user-b-confirmed.png`

7. **Wait for common ground analysis:**
   - Since handleConfirmNeeds automatically calls consentShareNeeds on success, both users should have consented after confirming
   - Poll `GET /api/sessions/${sessionId}/common-ground` for User A until `analysisComplete: true` (timeout 30s, poll every 2s)
   - This triggers the common-ground AI analysis with fixture responses

8. **Verify common ground display:**
   - Reload both pages (common ground may require page reload to show)
   - Wait for `need-mapping-common-ground` testID to be visible
   - Screenshot: `test-results/stage-3-03-common-ground-user-a.png` and `stage-3-03-common-ground-user-b.png`
   - Verify `common-ground-card` testID is visible
   - Verify common ground content is displayed

9. **Both users confirm common ground:**
   - Click `continue-to-strategies-button` on pageA
   - Wait 2s
   - Screenshot: `test-results/stage-3-04-user-a-continue.png`
   - Click `continue-to-strategies-button` on pageB
   - Wait 2s
   - Screenshot: `test-results/stage-3-04-user-b-continue.png`

10. **Final state verification:**
    - Verify both users have advanced past Stage 3 (verify via progress API or page state)
    - Screenshot: `test-results/stage-3-05-final-user-a.png` and `stage-3-05-final-user-b.png`

**Important patterns to follow:**
- Use `makeApiRequest` helper for API calls (same as stage-3-4-complete.spec.ts)
- Add elapsed time logging throughout: `const elapsed = () => \`[\${((Date.now() - testStart) / 1000).toFixed(1)}s]\``
- Use generous timeouts for visibility checks (30s) since needs extraction involves AI calls
- If NeedMappingScreen is NOT the main session screen (it's a separate route), you may need to navigate to it. Check if the session screen routes to NeedMappingScreen at Stage 3 or if it appears inline. If navigation is needed, check for a "Needs" button or link in the session screen.
- If the needs review phase doesn't appear automatically (because needs extraction is triggered by navigating to the screen), use the API to trigger extraction first, then reload.
- Handle the case where the NeedMappingScreen phases transition automatically after confirm (the component calls `consentShareNeeds` in the `onSuccess` callback of `confirmNeeds`).

**Fallback approach if UI-driven needs extraction doesn't work:**
If the NeedMappingScreen exploration phase doesn't trigger needs extraction via the AI fixture (because it uses chat messages not the extract-needs operation), use the API to create needs via `POST /api/sessions/${sessionId}/needs` for each user (as stage-3-4-complete.spec.ts does), then verify the UI displays and confirms them. Document this as a known limitation.

**Add project to playwright.config.ts:**
Add a new project entry:
```typescript
{
  name: 'two-browser-stage-3',
  testMatch: /two-browser-stage-3\.spec\.ts/,
  use: {
    baseURL: 'http://localhost:8082',
  },
},
```
  </action>
  <verify>
Run the test: `cd e2e && npx playwright test two-browser-stage-3.spec.ts --project=two-browser-stage-3`
Verify: Test passes, screenshots exist in e2e/test-results/ with stage-3-* prefix, at least 8 screenshots captured.
  </verify>
  <done>
Two-browser E2E test passes proving both users can complete Stage 3 via UI. Screenshots document: needs review (both users), needs confirmation (both users), common ground discovery (both users), and final state. Test registered in playwright.config.ts.
  </done>
</task>

</tasks>

<verification>
1. `cd e2e && npx playwright test two-browser-stage-3.spec.ts --project=two-browser-stage-3` passes
2. Screenshots in e2e/test-results/ capture: needs review, confirmation, common ground, and final states for both users
3. Test uses `stage-3-needs` fixture for deterministic AI responses
4. Both users complete the full flow: extraction -> review -> confirm -> consent -> common ground -> continue
5. `npm run check` passes
</verification>

<success_criteria>
- Two-browser E2E test verifies complete Stage 3 flow for both users
- At least 8 Playwright screenshots document each UI state
- Test uses stage-3-needs fixture for deterministic behavior
- Test is registered in playwright.config.ts and passes reliably
</success_criteria>

<output>
After completion, create `.planning/phases/10-stage-3-needs-verification/10-02-SUMMARY.md`
</output>
