---
phase: 10-stage-3-needs-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - mobile/src/screens/NeedMappingScreen.tsx
  - mobile/src/components/NeedsSection.tsx
  - mobile/src/components/CommonGroundCard.tsx
  - backend/src/fixtures/stage-3-needs.ts
  - backend/src/fixtures/index.ts
autonomous: true
requirements:
  - NEEDS-01
  - NEEDS-04

must_haves:
  truths:
    - "NeedMappingScreen review phase has testIDs for needs section, confirm button, and adjust button"
    - "NeedMappingScreen common ground phase has testIDs for common ground section, continue button"
    - "NeedMappingScreen waiting phase has testID for waiting state"
    - "Stage 3 fixture provides deterministic extract-needs and common-ground operation responses"
    - "Stage 3 fixture is registered in fixture index and accessible by ID 'stage-3-needs'"
  artifacts:
    - path: "mobile/src/screens/NeedMappingScreen.tsx"
      provides: "testIDs for Stage 3 UI phases"
      contains: "testID"
    - path: "backend/src/fixtures/stage-3-needs.ts"
      provides: "Deterministic AI responses for needs extraction and common ground"
      exports: ["stage3Needs"]
    - path: "backend/src/fixtures/index.ts"
      provides: "Registry entry for stage-3-needs fixture"
      contains: "stage-3-needs"
  key_links:
    - from: "backend/src/fixtures/stage-3-needs.ts"
      to: "backend/src/services/needs.ts"
      via: "operations keys matching getCompletion operation parameter"
      pattern: "extract-needs|common-ground"
    - from: "backend/src/fixtures/index.ts"
      to: "backend/src/fixtures/stage-3-needs.ts"
      via: "import and registry entry"
      pattern: "stage-3-needs"
---

<objective>
Add testIDs to Stage 3 UI components and create a deterministic E2E fixture for needs extraction and common ground analysis.

Purpose: Enable Playwright to find and interact with Stage 3 UI elements (needs cards, confirm/adjust buttons, common ground cards) and provide deterministic AI responses so E2E tests produce predictable results.

Output: NeedMappingScreen with testIDs on all interactive elements, NeedsSection/CommonGroundCard with testIDs propagated, and a registered stage-3-needs fixture with extract-needs and common-ground operation responses.
</objective>

<execution_context>
@/Users/shantam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-stage-3-needs-verification/10-RESEARCH.md
@backend/src/fixtures/types.ts
@backend/src/fixtures/index.ts
@backend/src/fixtures/reconciler-no-gaps.ts
@mobile/src/screens/NeedMappingScreen.tsx
@mobile/src/components/NeedsSection.tsx
@mobile/src/components/NeedCard.tsx
@mobile/src/components/CommonGroundCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add testIDs to NeedMappingScreen and child components</name>
  <files>
    mobile/src/screens/NeedMappingScreen.tsx
    mobile/src/components/NeedsSection.tsx
    mobile/src/components/CommonGroundCard.tsx
  </files>
  <action>
Add testIDs to NeedMappingScreen.tsx for each phase render:

**Review phase** (around line 721-776):
- The outer ScrollView or container: `testID="need-mapping-review"`
- The NeedsSection component: pass `testID="needs-section"` prop
- The "Yes, confirm my needs" TouchableOpacity: `testID="confirm-needs-button"`
- The "I want to adjust these" TouchableOpacity: `testID="adjust-needs-button"`
- The confirm question text container: `testID="needs-confirm-question"`

**Common ground phase** (around line 779-845):
- The outer ScrollView or container: `testID="need-mapping-common-ground"`
- The CommonGroundCard component: add `testID="common-ground-card"` prop
- The "Continue to Strategies" TouchableOpacity: `testID="continue-to-strategies-button"`

**Waiting phase** (around line 848-865):
- The SafeAreaView or WaitingRoom wrapper: `testID="need-mapping-waiting"`

**Exploration phase** (around line 688-714):
- The container: `testID="need-mapping-exploration"`

In CommonGroundCard.tsx:
- The component already accepts testID prop (line 24) and applies it (line 38). No changes needed unless the prop is not being passed from NeedMappingScreen.

In NeedsSection.tsx:
- Already accepts and applies testID (lines 28, 44). Individual NeedCards get `testID={`need-${need.id}`}` (line 52). No changes needed.

Ensure all testIDs follow the existing project convention (kebab-case).
  </action>
  <verify>
Run `npm run check` from project root to verify TypeScript compilation passes. Grep NeedMappingScreen.tsx for "testID" to confirm at least 6 testID assignments exist.
  </verify>
  <done>
NeedMappingScreen has testIDs on all four phase containers (exploration, review, common_ground, waiting) plus interactive elements (confirm button, adjust button, continue button). TypeScript compiles successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create stage-3-needs fixture and register in index</name>
  <files>
    backend/src/fixtures/stage-3-needs.ts
    backend/src/fixtures/index.ts
  </files>
  <action>
Create `backend/src/fixtures/stage-3-needs.ts` with a fixture that provides:

1. **responses array**: Reuse the same Stage 0-1-2 witnessing/empathy-building responses from `reconciler-no-gaps.ts` (copy the 7 responses). These are needed because SessionBuilder with `.startingAt('EMPATHY_REVEALED')` skips stage chat but the fixture ID is still set on the browser context for any subsequent AI calls.

2. **operations object** with two keys:
   - `'extract-needs'`: Returns a JSON response with 3 deterministic needs:
     ```json
     {
       "needs": [
         {
           "category": "CONNECTION",
           "need": "To feel emotionally connected and understood",
           "evidence": ["I just want to feel like we are on the same team"],
           "aiConfidence": 0.85
         },
         {
           "category": "RECOGNITION",
           "need": "To have efforts acknowledged and appreciated",
           "evidence": ["It feels like nothing I do is ever enough"],
           "aiConfidence": 0.78
         },
         {
           "category": "SAFETY",
           "need": "To feel safe expressing feelings without conflict",
           "evidence": ["I am afraid to bring things up because it always turns into a fight"],
           "aiConfidence": 0.82
         }
       ]
     }
     ```
   - `'common-ground'`: Returns a JSON response with 2 common ground items:
     ```json
     {
       "commonGround": [
         {
           "category": "CONNECTION",
           "need": "Both partners value emotional connection and want to feel like a team",
           "insight": "While expressed differently, both seek the same underlying closeness"
         },
         {
           "category": "SAFETY",
           "need": "Both need to feel safe being vulnerable in conversations",
           "insight": "The fear of conflict is shared - both want discussions to feel constructive"
         }
       ]
     }
     ```

Export as `stage3Needs` (following the camelCase convention from other fixtures like `reconcilerNoGaps`).

In `backend/src/fixtures/index.ts`:
- Add import: `import { stage3Needs } from './stage-3-needs';`
- Add to named exports: `stage3Needs,`
- Add to `fixtureRegistry`: `'stage-3-needs': stage3Needs,`

Follow the exact structure of existing fixtures (see reconciler-no-gaps.ts for reference). The fixture must conform to the E2EFixture type from types.ts.

IMPORTANT: The operation key names MUST be exactly `'extract-needs'` and `'common-ground'` to match the operation parameter in `backend/src/services/needs.ts` lines 211 and 323.
  </action>
  <verify>
Run `npm run check` from project root to verify TypeScript compilation. Run `cd backend && npx ts-node -e "const { getFixture } = require('./src/fixtures'); const f = getFixture('stage-3-needs'); console.log('Found:', !!f, 'Ops:', Object.keys(f?.operations || {}))"` to verify fixture loads and has correct operation keys.
  </verify>
  <done>
stage-3-needs fixture exists with extract-needs and common-ground operations, is registered in index.ts with ID 'stage-3-needs', and TypeScript compiles.
  </done>
</task>

</tasks>

<verification>
1. `npm run check` passes (TypeScript across all workspaces)
2. NeedMappingScreen.tsx contains testIDs for all four phases plus interactive elements
3. stage-3-needs fixture loads via `getFixture('stage-3-needs')` and has `extract-needs` and `common-ground` operation keys
4. Fixture operation key names match backend service operation parameters exactly
</verification>

<success_criteria>
- All Stage 3 UI phases have testIDs accessible via Playwright `getByTestId()`
- stage-3-needs fixture provides deterministic responses for both extract-needs and common-ground operations
- TypeScript compiles across all workspaces
</success_criteria>

<output>
After completion, create `.planning/phases/10-stage-3-needs-verification/10-01-SUMMARY.md`
</output>
