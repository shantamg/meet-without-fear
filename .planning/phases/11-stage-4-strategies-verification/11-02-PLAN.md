---
phase: 11-stage-4-strategies-verification
plan: 02
type: execute
wave: 2
depends_on:
  - "11-01"
files_modified:
  - e2e/tests/two-browser-stage-4.spec.ts
  - e2e/playwright.config.ts
autonomous: true
requirements:
  - STRAT-01
  - STRAT-02
  - STRAT-03
  - STRAT-04
  - STRAT-05
must_haves:
  truths:
    - "Both users can propose strategies to the anonymous pool via API"
    - "Both users can mark ready and submit rankings via API"
    - "Overlap reveals strategies both users ranked in their top 3"
    - "Both users can create and confirm an agreement via API"
    - "Screenshots capture strategy pool, ranking, overlap, and agreement states for both users"
  artifacts:
    - path: "e2e/tests/two-browser-stage-4.spec.ts"
      provides: "Two-browser E2E test for complete Stage 4 flow"
      min_lines: 200
    - path: "e2e/playwright.config.ts"
      provides: "Playwright project entry for two-browser-stage-4"
      contains: "two-browser-stage-4"
  key_links:
    - from: "e2e/tests/two-browser-stage-4.spec.ts"
      to: "backend/src/controllers/stage4.ts"
      via: "API calls to /api/sessions/:id/strategies/* and /api/sessions/:id/agreements/*"
      pattern: "api/sessions.*strategies"
    - from: "e2e/tests/two-browser-stage-4.spec.ts"
      to: "e2e/helpers/session-builder.ts"
      via: "SessionBuilder.startingAt('NEED_MAPPING_COMPLETE')"
      pattern: "NEED_MAPPING_COMPLETE"
---

<objective>
Create a two-browser Playwright E2E test that verifies the complete Stage 4 (Strategic Repair) flow for both users: strategy proposal, ranking, overlap reveal, and agreement confirmation.

Purpose: Prove that both users can complete the entire Stage 4 flow end-to-end with visual documentation at each phase.

Output: `e2e/tests/two-browser-stage-4.spec.ts` with screenshots at each Stage 4 phase.
</objective>

<execution_context>
@/Users/shantam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-stage-4-strategies-verification/11-01-SUMMARY.md
@.planning/phases/10-stage-3-needs-verification/10-02-SUMMARY.md
@e2e/tests/two-browser-stage-3.spec.ts
@e2e/helpers/session-builder.ts
@backend/src/controllers/stage4.ts
@mobile/src/components/StrategyPool.tsx
@mobile/src/components/StrategyRanking.tsx
@mobile/src/components/OverlapReveal.tsx
@mobile/src/components/AgreementCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create two-browser Stage 4 E2E test with screenshots</name>
  <files>e2e/tests/two-browser-stage-4.spec.ts, e2e/playwright.config.ts</files>
  <action>
Create `e2e/tests/two-browser-stage-4.spec.ts` following the exact pattern from `two-browser-stage-3.spec.ts`. Use the API-driven approach (Phase 10 lesson: testIDs don't work in RN Web).

**Setup (beforeEach):**
- `cleanupE2EData()` to reset database
- `SessionBuilder` starting at `NEED_MAPPING_COMPLETE` with fixture `'stage-4-strategies'`
- Test users: `stage4-two-a@e2e.test` (Alice), `stage4-two-b@e2e.test` (Bob)
- Two browser contexts with `createUserContext` helper (copy pattern from stage-3 test)
- `makeApiRequest` helper for authenticated API calls (copy from stage-3 test)
- Timeout: 180s (3 minutes)

**Test flow (single test case: "Both users complete Stage 4: strategies, ranking, overlap, and agreement"):**

1. **STEP 1: Navigate both users to session**
   - Navigate to `/session/{sessionId}` with E2E query params
   - Wait for `networkidle`
   - Handle mood check if visible
   - Screenshots: `stage-4-01-initial-user-a.png`, `stage-4-01-initial-user-b.png`

2. **STEP 2: Propose strategies via API (both users)**
   - User A proposes 2 strategies via `POST /api/sessions/${sessionId}/strategies`:
     - "Have a 10-minute phone-free conversation at dinner each day" (needs: ['Connection', 'Recognition'])
     - "Use a pause signal when conversations get heated" (needs: ['Safety', 'Connection'])
   - User B proposes 1 strategy:
     - "Say one specific thing I appreciate each morning" (needs: ['Recognition'])
   - Verify strategies via `GET /api/sessions/${sessionId}/strategies` returns 3 strategies
   - Reload pages to show strategy pool UI
   - Handle mood check after reload
   - Try to verify text "Here is what we have come up with" is visible (10s timeout, catch failure - RN Web may not show this)
   - Screenshots: `stage-4-02-pool-user-a.png`, `stage-4-02-pool-user-b.png`

3. **STEP 3: Mark both users ready to rank**
   - User A: `POST /api/sessions/${sessionId}/strategies/ready`
   - User B: `POST /api/sessions/${sessionId}/strategies/ready`
   - Verify User B response has `canStartRanking: true`
   - Log ready status for debugging

4. **STEP 4: Submit rankings via API (both users)**
   - Get strategy IDs from `GET /api/sessions/${sessionId}/strategies` response
   - User A ranks: [strategy1, strategy2, strategy3] (all 3 in order)
   - User B ranks: [strategy1, strategy3, strategy2] (different order but strategy1 first in both = guaranteed overlap)
   - Submit via `POST /api/sessions/${sessionId}/strategies/rank` with `{rankedIds: [...]}`
   - Verify User B response has `canReveal: true`
   - Reload pages to show ranking/reveal UI
   - Handle mood check after reload
   - Try to verify "Rank Your Top Choices" or "Your Shared Priorities" text visible (10s timeout, catch failure)
   - Screenshots: `stage-4-03-ranking-user-a.png`, `stage-4-03-ranking-user-b.png`

5. **STEP 5: Verify overlap via API**
   - `GET /api/sessions/${sessionId}/strategies/overlap` for both users
   - Assert `overlap` array is not null and has at least 1 strategy (strategy1 is in both top 3)
   - Log overlap strategy descriptions
   - Reload pages to show overlap reveal UI
   - Handle mood check after reload
   - Try to verify "Your Shared Priorities" or "You Both Chose" text visible (10s timeout, catch failure)
   - Screenshots: `stage-4-04-overlap-user-a.png`, `stage-4-04-overlap-user-b.png`

6. **STEP 6: Create agreement via API**
   - Get first overlap strategy ID from overlap response
   - User A creates agreement: `POST /api/sessions/${sessionId}/agreements` with:
     ```json
     {
       "description": "<overlap strategy description>",
       "type": "MICRO_EXPERIMENT",
       "followUpDate": "<7 days from now ISO string>"
     }
     ```
   - Note: `strategyId` is optional in createAgreementRequestSchema. Include the overlap strategy ID if available.
   - Verify response has `awaitingPartnerConfirmation: true`
   - Log agreement ID

7. **STEP 7: Confirm agreement via API (partner)**
   - User B confirms: `POST /api/sessions/${sessionId}/agreements/${agreementId}/confirm` with `{confirmed: true}`
   - Verify response has `partnerConfirmed: true` and `sessionComplete: true`
   - Reload pages to show agreement UI
   - Handle mood check after reload
   - Try to verify "Micro-Experiment Agreement" or "Confirm Agreement" text visible (10s timeout, catch failure)
   - Screenshots: `stage-4-05-agreement-user-a.png`, `stage-4-05-agreement-user-b.png`

8. **Final summary log:** Print all API responses and screenshot paths for debugging.

**Important implementation details:**
- Use `page.getByText(/text/i)` for text-based verification, wrapped in try-catch to not fail the test if RN Web doesn't render as expected
- All phase-advancing actions done via API, not UI clicks (Phase 10 lesson)
- Each step logs extensively for debugging
- Screenshot paths use `test-results/` directory prefix
- `handleMoodCheck` helper identical to stage-3 test
- Strategies are proposed by BOTH users (not AI-generated) because requestSuggestions is a TODO

**Register in `e2e/playwright.config.ts`:**
Add a new project entry:
```typescript
{
  name: 'two-browser-stage-4',
  testMatch: /two-browser-stage-4\.spec\.ts/,
  use: {
    baseURL: 'http://localhost:8082',
  },
}
```
  </action>
  <verify>
1. Run `cd /Users/shantam/Software/meet-without-fear && npm run check` to verify types
2. Verify test file exists and has correct structure: `grep -c 'test.describe' e2e/tests/two-browser-stage-4.spec.ts`
3. Verify playwright config has new project: `grep 'two-browser-stage-4' e2e/playwright.config.ts`
4. If backend and mobile are running, execute test:
   `cd /Users/shantam/Software/meet-without-fear/e2e && npx playwright test two-browser-stage-4.spec.ts --project=two-browser-stage-4`
   (This requires backend on :3000 and mobile web on :8082 - may not be available in CI)
  </verify>
  <done>
Two-browser Stage 4 E2E test exists with all 7 steps covering strategy proposal (STRAT-01), ranking (STRAT-02), overlap reveal (STRAT-03), agreement confirmation (STRAT-04), and screenshots at each phase (STRAT-05). Playwright config has 'two-browser-stage-4' project entry. TypeScript compilation passes.
  </done>
</task>

</tasks>

<verification>
1. `npm run check` passes across all workspaces
2. `e2e/tests/two-browser-stage-4.spec.ts` exists with all Stage 4 API calls
3. `e2e/playwright.config.ts` has `two-browser-stage-4` project entry
4. Test covers all 5 requirements: STRAT-01 (propose strategies), STRAT-02 (ranking), STRAT-03 (overlap), STRAT-04 (agreement), STRAT-05 (screenshots)
5. Test uses API-driven pattern (not UI clicks) following Phase 10 lessons
6. Test captures 10+ screenshots (2 per phase, 5 phases)
</verification>

<success_criteria>
- Two-browser E2E test covers complete Stage 4 flow via API
- All 5 STRAT requirements addressed
- Screenshots capture each Stage 4 phase for both users
- Test follows established Phase 10 patterns (API-driven, text-based verification, screenshot documentation)
</success_criteria>

<output>
After completion, create `.planning/phases/11-stage-4-strategies-verification/11-02-SUMMARY.md`
</output>
