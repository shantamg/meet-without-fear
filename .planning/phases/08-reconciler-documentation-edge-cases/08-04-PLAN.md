---
phase: 08-reconciler-documentation-edge-cases
plan: 04
type: execute
wave: 3
depends_on:
  - "08-01"
  - "08-03"
files_modified:
  - e2e/tests/reconciler-offer-optional.spec.ts
  - e2e/tests/reconciler-offer-sharing-refinement.spec.ts
autonomous: true
requirements:
  - RECON-EC-01
  - RECON-EC-02
  - RECON-EC-03
  - RECON-EC-05
  - RECON-VIS-01
  - RECON-VIS-02

must_haves:
  truths:
    - "E2E test verifies OFFER_OPTIONAL path: subject sees ShareTopicPanel, can accept (draft generated, shared) or decline (confirmation dialog, guesser sees normal reveal)"
    - "E2E test verifies context-already-shared guard: after sharing, navigating back to share page does not show duplicate share panel"
    - "E2E test verifies OFFER_SHARING path: subject shares context, guesser receives context, guesser refines empathy, reconciler re-runs, both proceed"
    - "E2E test verifies accuracy feedback inaccurate path: subject rates inaccurate, crafts feedback, guesser refines or accepts"
    - "Playwright screenshots capture ShareTopicPanel/Drawer for both users at key states"
    - "Playwright screenshots capture refinement prompt state for both users"
  artifacts:
    - path: "e2e/tests/reconciler-offer-optional.spec.ts"
      provides: "E2E test for OFFER_OPTIONAL accept and decline paths with screenshots"
      contains: "TwoBrowserHarness"
    - path: "e2e/tests/reconciler-offer-sharing-refinement.spec.ts"
      provides: "E2E test for OFFER_SHARING + refinement + accuracy feedback with screenshots"
      contains: "TwoBrowserHarness"
  key_links:
    - from: "e2e/tests/reconciler-offer-optional.spec.ts"
      to: "backend/src/fixtures/reconciler-offer-optional.ts"
      via: "fixtureId in TwoBrowserHarness config"
      pattern: "reconciler-offer-optional"
    - from: "e2e/tests/reconciler-offer-sharing-refinement.spec.ts"
      to: "backend/src/fixtures/reconciler-refinement.ts"
      via: "fixtureId in TwoBrowserHarness config"
      pattern: "reconciler-refinement"
---

<objective>
Create E2E tests with Playwright screenshots that verify all reconciler edge case paths: OFFER_OPTIONAL (accept/decline), OFFER_SHARING (share + refinement), accuracy feedback inaccurate path, and context-already-shared guard.

Purpose: E2E tests prove the full flow works end-to-end for both users, and screenshots provide visual documentation of what each user sees at every step. This fulfills the remaining RECON-EC and RECON-VIS requirements.

Output: Two E2E test files with comprehensive Playwright screenshots.
</objective>

<execution_context>
@/Users/shantam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-reconciler-documentation-edge-cases/08-01-SUMMARY.md
@.planning/phases/08-reconciler-documentation-edge-cases/08-02-SUMMARY.md
@.planning/phases/08-reconciler-documentation-edge-cases/08-03-SUMMARY.md
@e2e/tests/two-browser-stage-2.spec.ts
@e2e/helpers/test-utils.ts
@e2e/playwright.two-browser.config.ts
@backend/src/fixtures/reconciler-offer-optional.ts
@backend/src/fixtures/reconciler-offer-sharing.ts
@backend/src/fixtures/reconciler-refinement.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: OFFER_OPTIONAL E2E test with accept/decline paths and context-already-shared guard</name>
  <files>e2e/tests/reconciler-offer-optional.spec.ts</files>
  <action>
Create `e2e/tests/reconciler-offer-optional.spec.ts` following the exact pattern from `e2e/tests/two-browser-stage-2.spec.ts`.

**Test setup:**
- Use TwoBrowserHarness with:
  - User A: `fixtureId: 'user-a-full-journey'` (guesser, shares empathy first)
  - User B: `fixtureId: 'reconciler-offer-optional'` (subject, reconciler returns OFFER_OPTIONAL)
- Standard beforeEach: cleanup, setupUserA, createSession
- Use iPhone 12 viewport
- 15-minute timeout (same as two-browser-stage-2)

**Test flow (one test with multiple assertions):**

1. **Stage 0-1 prerequisite** (same pattern as two-browser-stage-2):
   - Both users: navigate, sign compact, handle mood check
   - User A: send Stage 1 messages matching user-a-full-journey fixture, confirm feel-heard
   - User B: send Stage 1 messages matching reconciler-offer-optional fixture, confirm feel-heard

2. **Stage 2 empathy drafting** (both users draft BEFORE sharing):
   - User A: send Stage 2 messages, wait for empathy-review-button
   - User B: send Stage 2 messages, wait for empathy-review-button

3. **User A shares empathy first** (guesser):
   - Click empathy-review-button -> share-empathy-button
   - Wait 3s for Ably propagation

4. **User B shares empathy** (triggers reconciler with OFFER_OPTIONAL fixture):
   - Click empathy-review-button -> share-empathy-button
   - Wait for reconciler completion via waitForReconcilerComplete(harness.userBPage, 60000)

5. **SCREENSHOT CHECKPOINT 1 - Both perspectives after reconciler:**
   - Screenshot User A (guesser): Should show waiting banner (e.g., "considering a suggestion")
   - Screenshot User B (subject): Should show ShareTopicPanel (blue, soft language)
   - Paths: `test-results/offer-optional-01-guesser-waiting.png`, `test-results/offer-optional-01-subject-panel.png`

6. **Subject opens ShareTopicDrawer:**
   - User B: click share-topic-panel
   - Assert ShareTopicDrawer visible (testID: share-topic-drawer)
   - Assert contains "might consider sharing" text (OFFER_OPTIONAL language)
   - Screenshot: `test-results/offer-optional-02-subject-drawer.png`

7. **OFFER_OPTIONAL decline path:**
   - User B: click share-topic-decline (testID: share-topic-decline)
   - Handle Alert confirmation dialog (Playwright may need `page.on('dialog')` handler)
   - Wait for dialog, accept the "Continue without sharing" option
   - Wait 3s for Ably propagation
   - Assert ShareTopicDrawer is no longer visible
   - Screenshot User B: `test-results/offer-optional-03-subject-after-decline.png`
   - Screenshot User A: `test-results/offer-optional-03-guesser-after-decline.png`
   - Assert guesser does NOT see any indication of declined offer (information boundary)

8. **Wait for empathy reveal:**
   - Both users should enter the reveal phase
   - Wait for empathy-shared indicator on both pages
   - Screenshot: `test-results/offer-optional-04-guesser-revealed.png`, `test-results/offer-optional-04-subject-revealed.png`

9. **Navigate to Share tab and verify content:**
   - Both users navigate to Share page
   - Screenshot: `test-results/offer-optional-05-guesser-share.png`, `test-results/offer-optional-05-subject-share.png`
   - Navigate back to Chat
   - Verify content still visible (persistence)

10. **CONTEXT-ALREADY-SHARED GUARD (RECON-EC-05):**
    - This is tested as an inline assertion WITHIN this test per user decision
    - After step 9, navigate User B back to Share page
    - Assert no duplicate ShareTopicPanel appears
    - Assert no second share offer is shown
    - This verifies the hasContextAlreadyBeenShared guard prevents duplicate offers

**Screenshot naming convention:** `test-results/offer-optional-{NN}-{user-role}-{state}.png`

**IMPORTANT patterns from existing tests:**
- Use `sendAndWaitForPanel` for sending messages and waiting for panels
- Use `confirmFeelHeard` for Stage 1 completion
- Use `signCompact` and `handleMoodCheck` for Stage 0
- Wait 3s after Ably-triggering actions before screenshots
- Use testIDs for assertions, NOT text matching (except for visual differentiation verification)
  </action>
  <verify>
```bash
cd /Users/shantam/Software/meet-without-fear/e2e && npx playwright test reconciler-offer-optional.spec.ts --config=playwright.two-browser.config.ts
```
Test must pass. Screenshots must exist in test-results/ directory.
  </verify>
  <done>
E2E test passes for OFFER_OPTIONAL path: subject sees ShareTopicPanel (blue/soft), opens drawer, declines with confirmation, guesser sees normal reveal (no indication of decline). Context-already-shared guard verified inline (no duplicate panel on re-navigation). At least 10 screenshots captured documenting both user perspectives at key states.
  </done>
</task>

<task type="auto">
  <name>Task 2: OFFER_SHARING + refinement + accuracy feedback E2E test</name>
  <files>e2e/tests/reconciler-offer-sharing-refinement.spec.ts</files>
  <action>
Create `e2e/tests/reconciler-offer-sharing-refinement.spec.ts` following the same TwoBrowserHarness pattern.

**Test setup:**
- User A: `fixtureId: 'user-a-full-journey'` (guesser)
- User B: `fixtureId: 'reconciler-refinement'` (subject, reconciler returns OFFER_SHARING, then guard intercepts second run)
- 15-minute timeout
- iPhone 12 viewport

**Test flow:**

1. **Stage 0-1 prerequisite** (same as OFFER_OPTIONAL test):
   - Both users complete Stage 0 and Stage 1

2. **Stage 2 empathy drafting** (both draft before sharing):
   - Both users send Stage 2 messages, wait for empathy-review-button

3. **Both share empathy** (User A first, User B triggers reconciler):
   - User A shares, wait 3s
   - User B shares, wait for reconciler with OFFER_SHARING result

4. **SCREENSHOT CHECKPOINT 1 - OFFER_SHARING state:**
   - Screenshot User A: guesser waiting
   - Screenshot User B: subject sees ShareTopicPanel (orange, strong language)
   - Paths: `test-results/offer-sharing-01-guesser-waiting.png`, `test-results/offer-sharing-01-subject-panel.png`

5. **Subject opens ShareTopicDrawer and accepts:**
   - User B: click share-topic-panel
   - Assert drawer shows OFFER_SHARING language ("share more about")
   - Screenshot: `test-results/offer-sharing-02-subject-drawer.png`
   - User B: click share-topic-accept (testID: share-topic-accept)
   - Wait for AI to generate draft (new AI message should appear in chat)
   - Screenshot: `test-results/offer-sharing-03-subject-draft.png`

6. **Subject shares context:**
   - Look for "Review and share" button in chat (or equivalent testID)
   - Click to open ShareSuggestionDrawer (if this is the flow)
   - Approve and share the context
   - Wait 3s for Ably propagation to guesser

7. **SCREENSHOT CHECKPOINT 2 - After sharing:**
   - Screenshot User A: guesser should see shared context message in chat
   - Screenshot User B: subject sees confirmation of sharing
   - Paths: `test-results/offer-sharing-04-guesser-received-context.png`, `test-results/offer-sharing-04-subject-shared.png`

8. **Navigate to Share tab - verify content persistence:**
   - Both users navigate to Share page
   - Screenshot: `test-results/offer-sharing-05-guesser-share.png`, `test-results/offer-sharing-05-subject-share.png`
   - Verify shared content is visible on Share page

9. **Guesser refinement:**
   - Navigate guesser back to Chat
   - Look for AI messages about refinement
   - Look for "Refine" button on Share tab (or in chat via PartnerContentCard)
   - If refinement UI is available, interact with it to refine empathy
   - If guesser needs to resubmit: use the resubmit flow
   - Wait for reconciler re-run (hasContextAlreadyBeenShared guard should intercept, mark READY)
   - Screenshot: `test-results/offer-sharing-06-guesser-refinement.png`

10. **Wait for empathy reveal:**
    - Wait for empathy-shared indicator on both pages
    - Screenshot: `test-results/offer-sharing-07-guesser-revealed.png`, `test-results/offer-sharing-07-subject-revealed.png`

11. **Accuracy feedback - subject validates:**
    - User B should see accuracy feedback panel (or AccuracyFeedbackDrawer)
    - If visible, test the inaccurate path (per CONTEXT.md: full inaccurate path tested):
      - Click the accuracy feedback panel/button to open AccuracyFeedbackDrawer
      - Click "Not quite" (testID: accuracy-inaccurate-button)
      - Interact with feedback chat if opened
      - Screenshot: `test-results/offer-sharing-08-subject-feedback.png`
    - If AccuracyFeedback not visible after reveal (known Ably timing issue from existing tests):
      - Document as known issue
      - Screenshot the current state
      - Continue test

12. **Final state screenshots:**
    - Navigate both users to Share tab
    - Screenshot final Share state: `test-results/offer-sharing-09-guesser-final-share.png`, `test-results/offer-sharing-09-subject-final-share.png`
    - Navigate both to Chat
    - Screenshot final Chat state: `test-results/offer-sharing-10-guesser-final-chat.png`, `test-results/offer-sharing-10-subject-final-chat.png`
    - Verify content persistence: shared context, refinement status, validation result all visible

**IMPORTANT:**
- One refinement cycle only (per CONTEXT.md decision)
- After resubmit, the hasContextAlreadyBeenShared guard in reconciler.ts prevents another OFFER_SHARING, forcing READY status
- This is the happy path: subject shares -> guesser refines -> reconciler re-runs -> PROCEED
- Test navigates between Chat and Share to verify content persistence (per decision)
- Accuracy feedback path may be limited by Ably timing - document actual behavior
- If accuracy feedback panel is not visible, still take screenshots and document
  </action>
  <verify>
```bash
cd /Users/shantam/Software/meet-without-fear/e2e && npx playwright test reconciler-offer-sharing-refinement.spec.ts --config=playwright.two-browser.config.ts
```
Test must pass. Screenshots must exist in test-results/ directory.
  </verify>
  <done>
E2E test passes for OFFER_SHARING + refinement path: subject shares context, guesser receives and refines, reconciler re-runs with PROCEED. Accuracy feedback interaction tested (or documented as known issue if Ably timing prevents). At least 12 screenshots captured documenting both perspectives at every key state. Content persistence verified across Chat/Share navigation.
  </done>
</task>

</tasks>

<verification>
1. Both E2E test files pass with `npx playwright test --config=playwright.two-browser.config.ts`
2. OFFER_OPTIONAL test: Screenshots capture ShareTopicPanel (blue), drawer, decline confirmation, reveal
3. OFFER_SHARING test: Screenshots capture ShareTopicPanel (orange), drawer, shared context, refinement, reveal
4. Context-already-shared guard verified (no duplicate panels on re-navigation)
5. Content persistence verified (Chat and Share pages show complete record)
6. All screenshots exist in test-results/ directory
</verification>

<success_criteria>
- OFFER_OPTIONAL E2E test passes with accept/decline paths verified
- OFFER_SHARING + refinement E2E test passes with share -> refine -> re-run -> PROCEED
- Context-already-shared guard prevents duplicate shares (RECON-EC-05)
- Playwright screenshots capture both user perspectives at all key states (RECON-VIS-01, RECON-VIS-02)
- Tests navigate between Chat and Share to verify content persistence
</success_criteria>

<output>
After completion, create `.planning/phases/08-reconciler-documentation-edge-cases/08-04-SUMMARY.md`
</output>
