---
phase: 08-reconciler-documentation-edge-cases
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - mobile/src/components/ShareTopicDrawer.tsx
  - mobile/src/screens/UnifiedSessionScreen.tsx
  - mobile/src/components/ChatBubble.tsx
  - mobile/src/hooks/useAnimationQueue.ts
autonomous: true
requirements:
  - RECON-EC-01
  - RECON-EC-02

must_haves:
  truths:
    - "Subject can tap ShareTopicPanel to open a full-screen ShareTopicDrawer showing reconciler suggestion"
    - "ShareTopicDrawer shows differentiated language for OFFER_OPTIONAL (soft, blue) vs OFFER_SHARING (strong, orange)"
    - "Subject tapping 'No thanks' sees a confirmation dialog before proceeding"
    - "After subject declines, guesser sees normal reveal flow with no indication decline happened"
    - "Chat messages do not re-animate when navigating back to chat screen"
  artifacts:
    - path: "mobile/src/components/ShareTopicDrawer.tsx"
      provides: "Full-screen drawer showing reconciler topic suggestion with accept/decline buttons"
      contains: "ShareTopicDrawer"
    - path: "mobile/src/screens/UnifiedSessionScreen.tsx"
      provides: "ShareTopicDrawer wired with state management and callbacks"
      contains: "ShareTopicDrawer"
  key_links:
    - from: "mobile/src/screens/UnifiedSessionScreen.tsx"
      to: "mobile/src/components/ShareTopicDrawer.tsx"
      via: "state toggle and onAccept/onDecline callbacks"
      pattern: "ShareTopicDrawer"
    - from: "mobile/src/components/ShareTopicPanel.tsx"
      to: "mobile/src/components/ShareTopicDrawer.tsx"
      via: "onPress opens drawer"
      pattern: "setShowShareTopicDrawer"
---

<objective>
Build the ShareTopicDrawer component, wire it into UnifiedSessionScreen, add decline confirmation dialog, and fix the chat re-animation bug.

Purpose: This creates the Phase 1 of the two-phase share flow (topic suggestion). When the reconciler finds gaps, the subject sees the ShareTopicPanel, taps it, and the ShareTopicDrawer opens showing the topic to share about with accept/decline options. Also fixes a UX bug where chat messages re-animate on navigation.

Output: ShareTopicDrawer component, wired into UnifiedSessionScreen, decline confirmation dialog, chat re-animation bug fix.
</objective>

<execution_context>
@/Users/shantam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@docs/specs/when-the-reconciler-responds-with-offeroptional-we-need-to-implement-this.md
@mobile/src/components/ShareTopicPanel.tsx
@mobile/src/screens/UnifiedSessionScreen.tsx
@mobile/src/components/AccuracyFeedbackDrawer.tsx
@mobile/src/components/ViewEmpathyStatementDrawer.tsx
@mobile/src/utils/chatUIState.ts
@mobile/src/hooks/useStages.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build ShareTopicDrawer component and wire into UnifiedSessionScreen</name>
  <files>
    mobile/src/components/ShareTopicDrawer.tsx
    mobile/src/screens/UnifiedSessionScreen.tsx
  </files>
  <action>
**Create `mobile/src/components/ShareTopicDrawer.tsx`:**

A full-screen Modal drawer (same pattern as AccuracyFeedbackDrawer and ViewEmpathyStatementDrawer) that shows the reconciler's share topic suggestion with accept/decline buttons.

Props:
```typescript
interface ShareTopicDrawerProps {
  visible: boolean;
  action: 'OFFER_SHARING' | 'OFFER_OPTIONAL';
  partnerName: string;
  suggestedShareFocus: string;
  onAccept: () => void;
  onDecline: () => void;
  onClose: () => void;
}
```

Content structure (from spec US-2):
- Header with close button (X icon, top right - same pattern as AccuracyFeedbackDrawer)
- Title area (centered)
- Intro text: "Our internal reconciler has reviewed what {partnerName} is imagining you are feeling, noted some of the things you have talked about, and has suggested that..."
- Action suffix:
  - OFFER_SHARING: "...you share more about:" (orange/amber text)
  - OFFER_OPTIONAL: "...you might consider sharing about:" (blue/gray text)
- "SUGGESTED FOCUS" label (small caps style)
- Topic text (the `suggestedShareFocus` string) in a styled container
- Two buttons at bottom:
  - "Yes, help me share" (primary action, brand colored) - testID: `share-topic-accept`
  - "No thanks" (secondary/subtle) - testID: `share-topic-decline`
- Overall testID: `share-topic-drawer`

For "No thanks" button: Show React Native Alert.alert confirmation dialog per user decision:
- Title: "Are you sure?"
- Message: "Sharing this could help {partnerName} understand you better."
- Buttons: "Go back" (cancel, default), "Continue without sharing" (destructive, calls onDecline)
- Same confirmation dialog for both OFFER_OPTIONAL and OFFER_SHARING (per user decision: no differentiation by severity)

Visual differentiation by action type:
- OFFER_SHARING: Use `colors.warning` (orange/amber) for icon and action text
- OFFER_OPTIONAL: Use `colors.brandBlue` for icon and action text
- Use Lightbulb icon from lucide-react-native (same as ShareTopicPanel)

**Wire into UnifiedSessionScreen.tsx:**

1. Import ShareTopicDrawer
2. Add state: `const [showShareTopicDrawer, setShowShareTopicDrawer] = useState(false);`
3. Find where ShareTopicPanel is rendered (search for `share-topic-panel` or `ShareTopicPanel`). The ShareTopicPanel's `onPress` should set `setShowShareTopicDrawer(true)`
4. Render ShareTopicDrawer alongside other drawers (near AccuracyFeedbackDrawer):
   ```tsx
   <ShareTopicDrawer
     visible={showShareTopicDrawer}
     action={shareOfferAction}  // derive from session state - reconciler result action
     partnerName={partnerName}
     suggestedShareFocus={shareOfferFocus}  // derive from share offer data
     onAccept={() => {
       setShowShareTopicDrawer(false);
       // Call the existing handleRespondToShareOffer('accept') or equivalent
       // which triggers draft generation via chat (US-3 from spec)
     }}
     onDecline={() => {
       setShowShareTopicDrawer(false);
       // Call handleRespondToShareOffer('decline') which marks empathy as READY
     }}
     onClose={() => setShowShareTopicDrawer(false)}
   />
   ```
5. Check how `shareOfferAction` and `shareOfferFocus` are available. Look at existing share offer data in the session state hooks (likely via `useShareOffer` or similar in `useStages.ts`). The reconciler result's `recommendation.action` and `recommendation.suggestedShareFocus` should be accessible.
6. After subject declines: Per user decision, guesser sees normal reveal flow with NO indication that a share offer was made or declined (information boundary preserved). Verify the existing `handleRespondToShareOffer('decline')` already handles this correctly (marks direction as READY without notifying partner).
  </action>
  <verify>
```bash
cd /Users/shantam/Software/meet-without-fear && npm run check --workspace=mobile
cd /Users/shantam/Software/meet-without-fear && npm run test --workspace=mobile -- --testPathPattern="ShareTopic" --passWithNoTests
```
Verify:
- ShareTopicDrawer.tsx exists with correct testIDs (share-topic-drawer, share-topic-accept, share-topic-decline)
- UnifiedSessionScreen.tsx imports and renders ShareTopicDrawer
- Alert.alert used for decline confirmation
  </verify>
  <done>
ShareTopicDrawer component exists with differentiated OFFER_OPTIONAL/OFFER_SHARING language, confirmation dialog on decline. Wired into UnifiedSessionScreen with state management. Subject can open drawer from ShareTopicPanel tap, accept (triggers draft generation), or decline (with confirmation dialog, marks READY).
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix chat re-animation bug</name>
  <files>
    mobile/src/components/ChatBubble.tsx
    mobile/src/hooks/useAnimationQueue.ts
  </files>
  <action>
Investigate and fix the chat re-animation bug described in CONTEXT.md:
- Symptom: "sometimes the entire chat history re-animates (one AI message at a time)"
- Likely trigger: navigating away from chat while a message is pending or still animating
- Probable fix: mark message as "animated" when animation starts, so leaving mid-animation considers it done

**Investigation steps:**

1. Read `mobile/src/hooks/useAnimationQueue.ts` to understand the animation queue mechanism
2. Read `mobile/src/components/ChatBubble.tsx` and `mobile/src/components/TypewriterText.tsx` to understand how individual messages are animated
3. Read `mobile/src/components/chat/renderers/AIMessageRenderer.tsx` for AI message animation
4. Search for how "animated" state is tracked - look for `skipTypewriter`, `animated`, `hasAnimated` patterns
5. Check if animation state is persisted or only in React state (which resets on unmount/remount)

**Root cause analysis:**

The typewriter animation likely uses a React state or ref to track which messages have been animated. When the user navigates away (component unmounts), this state is lost. When they navigate back (component remounts), all messages appear "new" and re-animate.

**Fix approach (per CONTEXT.md guidance):**

The fix should ensure that once a message's animation starts (or if the message was already present when the component mounted), it is considered "animated" and won't re-animate on remount. Options:

a. **Mark in React Query cache**: Add `skipTypewriter: true` or `animated: true` to messages in the cache after animation completes. On remount, messages with this flag skip animation. This is the preferred approach per Cache-First architecture (CLAUDE.md).

b. **Mark when animation starts**: When a message begins animating, immediately mark it as "animated" in cache. If user leaves mid-animation, the message is already marked, so re-mount won't re-animate.

c. **Use message age**: Messages older than N seconds skip animation on mount (simpler but less precise).

Choose the approach that best fits existing patterns. Likely (a) or (b) using the React Query cache.

**Key files to modify:**
- The animation queue or typewriter component: to mark messages as animated in cache
- ChatBubble or AIMessageRenderer: to check animated status before starting animation

**What NOT to change:**
- Don't change how new messages animate (streaming responses should still typewrite)
- Don't break the typing indicator behavior
- Don't change the message data model in the backend
  </action>
  <verify>
```bash
cd /Users/shantam/Software/meet-without-fear && npm run check --workspace=mobile
cd /Users/shantam/Software/meet-without-fear && npm run test --workspace=mobile -- --passWithNoTests
```
Manual verification: The fix should be verifiable in E2E tests by navigating away from chat and back - messages should not re-animate.
  </verify>
  <done>
Chat messages no longer re-animate when navigating away and back to the chat screen. Messages that have started or completed animation are marked as such (in cache or persistent state), and this marking survives component unmount/remount cycles. New streaming messages still animate normally.
  </done>
</task>

</tasks>

<verification>
1. ShareTopicDrawer.tsx exists with differentiated language for OFFER_OPTIONAL vs OFFER_SHARING
2. Decline confirmation dialog uses Alert.alert with proper copy
3. ShareTopicDrawer wired into UnifiedSessionScreen with accept/decline callbacks
4. Chat re-animation bug fixed - messages don't re-animate on navigation
5. `npm run check --workspace=mobile` passes
6. `npm run test --workspace=mobile` passes
</verification>

<success_criteria>
- Subject can tap ShareTopicPanel -> opens ShareTopicDrawer -> sees topic suggestion -> accept or decline
- Decline shows confirmation dialog before proceeding
- After decline, guesser sees normal reveal (information boundary preserved)
- Chat messages don't re-animate when navigating back to chat
</success_criteria>

<output>
After completion, create `.planning/phases/08-reconciler-documentation-edge-cases/08-02-SUMMARY.md`
</output>
