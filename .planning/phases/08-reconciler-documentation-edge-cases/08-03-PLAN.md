---
phase: 08-reconciler-documentation-edge-cases
plan: 03
type: execute
wave: 2
depends_on:
  - "08-02"
files_modified:
  - mobile/src/screens/UnifiedSessionScreen.tsx
  - mobile/src/utils/chatUIState.ts
  - mobile/src/hooks/useUnifiedSession.ts
  - mobile/src/components/AccuracyFeedbackDrawer.tsx
autonomous: true
requirements:
  - RECON-EC-01
  - RECON-EC-02
  - RECON-EC-03
  - RECON-EC-05

must_haves:
  truths:
    - "Subject tapping 'Not quite' in AccuracyFeedbackDrawer opens an AI-mediated feedback chat where subject crafts constructive feedback"
    - "AI acts as gatekeeper - subject never sends raw text to partner, AI redrafts feedback ensuring appropriateness"
    - "After subject submits inaccurate feedback, guesser receives notification and sees feedback in their chat"
    - "Guesser can refine empathy via AI conversation and resubmit, or skip refinement via acceptance check"
    - "Acceptance check offers 'I accept this is their experience' (proceed) or 'I cannot accept' (AI collects reason, proceed with disagreement)"
    - "Both Chat and Share pages serve as persistent records - nothing disappears after actions"
  artifacts:
    - path: "mobile/src/screens/UnifiedSessionScreen.tsx"
      provides: "Wired accuracy feedback inaccurate path and guesser refinement UI"
      contains: "handleInaccurateFeedback"
    - path: "mobile/src/components/AccuracyFeedbackDrawer.tsx"
      provides: "Updated drawer with inaccurate path leading to feedback chat"
      contains: "onInaccurate"
  key_links:
    - from: "mobile/src/screens/UnifiedSessionScreen.tsx"
      to: "mobile/src/hooks/useStages.ts"
      via: "useValidateEmpathy mutation for feedback submission"
      pattern: "useValidateEmpathy"
    - from: "mobile/src/screens/UnifiedSessionScreen.tsx"
      to: "mobile/src/hooks/useStages.ts"
      via: "useResubmitEmpathy for guesser refinement"
      pattern: "useResubmitEmpathy"
    - from: "mobile/src/screens/UnifiedSessionScreen.tsx"
      to: "mobile/src/hooks/useStages.ts"
      via: "useSkipRefinement for acceptance check"
      pattern: "useSkipRefinement"
---

<objective>
Wire the accuracy feedback "inaccurate" path (subject crafts AI-mediated feedback) and the guesser refinement UI (receive feedback, refine or accept) into UnifiedSessionScreen.

Purpose: Completes the full reconciler loop - after empathy reveal, subject validates accuracy. If inaccurate, subject crafts feedback via AI coach, which is delivered to guesser. Guesser can refine empathy or accept via acceptance check. All per-user decision: AI is the gatekeeper for all inter-user content.

Output: Wired accuracy feedback inaccurate flow, guesser refinement UI with acceptance check, content persistence across Chat/Share navigation.
</objective>

<execution_context>
@/Users/shantam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-reconciler-documentation-edge-cases/08-02-SUMMARY.md
@docs/user-flows/accuracy-feedback-flow.md
@mobile/src/screens/UnifiedSessionScreen.tsx
@mobile/src/components/AccuracyFeedbackDrawer.tsx
@mobile/src/components/ValidationCoachChat.tsx
@mobile/src/components/PartnerContentCard.tsx
@mobile/src/hooks/useStages.ts
@mobile/src/hooks/useUnifiedSession.ts
@mobile/src/utils/chatUIState.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire accuracy feedback inaccurate path for subject</name>
  <files>
    mobile/src/screens/UnifiedSessionScreen.tsx
    mobile/src/components/AccuracyFeedbackDrawer.tsx
    mobile/src/hooks/useUnifiedSession.ts
  </files>
  <action>
Wire the "inaccurate" feedback path so the subject can craft constructive feedback via AI coach.

**Current state:** AccuracyFeedbackDrawer exists with three buttons (Accurate, Partially, Not quite). The `onInaccurate` callback in UnifiedSessionScreen currently calls `handleValidatePartnerEmpathy(false, 'This does not capture my perspective')` - this sends a generic validation but doesn't open a feedback crafting flow.

**Required behavior (from accuracy-feedback-flow.md):**

1. Subject taps "Not quite" -> AccuracyFeedbackDrawer closes -> an AI-mediated feedback chat opens
2. Subject describes what was wrong -> AI helps craft constructive feedback
3. Subject approves final feedback message
4. Feedback is sent to backend via `POST /empathy/validate` with `rating: 'inaccurate'` and `feedback: <AI-crafted message>`
5. Backend notifies guesser (via Ably) that partner shared feedback

**Implementation:**

A. **Update AccuracyFeedbackDrawer onInaccurate behavior:**
   - When "Not quite" is tapped, instead of immediately validating, transition to a feedback crafting mode
   - Two approaches (choose what fits best with existing patterns):
     1. Keep drawer open, show a text input area where subject types initial thoughts, then submit to AI for refinement
     2. Close drawer, open a separate feedback chat (ValidationCoachChat pattern from PerspectiveStretchScreen)
   - Per user decision: "The user should never be able to send their own text to the other person. The user should always be asking the AI for edits and the AI has the job of making sure it is appropriate and drafts updates."
   - The subject types what they want to say, the AI redrafts it, the subject approves the AI's version

B. **Check existing ValidationCoachChat component** (`mobile/src/components/ValidationCoachChat.tsx`):
   - This component exists in PerspectiveStretchScreen (old, unused screen)
   - It likely has the AI feedback crafting chat pattern already built
   - If suitable, import and wire into UnifiedSessionScreen
   - If not suitable (too coupled to old screen), extract the pattern into a standalone component

C. **Wire into UnifiedSessionScreen:**
   - Add state for feedback chat visibility: `const [showFeedbackChat, setShowFeedbackChat] = useState(false);`
   - Update onInaccurate handler:
     ```typescript
     onInaccurate={() => {
       setShowAccuracyFeedbackDrawer(false);
       setShowFeedbackChat(true);
     }}
     ```
   - The feedback chat uses `POST /sessions/:id/empathy/feedback/refine` (check `useStages.ts` for `useSaveValidationFeedbackDraft` or similar hook)
   - When subject approves AI-crafted feedback, call `handleValidatePartnerEmpathy(false, aiCraftedFeedback)` or equivalent
   - After feedback submission, close feedback chat, show confirmation

D. **Verify the accurate and partially-accurate paths still work:**
   - Accurate: `handleValidatePartnerEmpathy(true)` -> validate -> proceed
   - Partially accurate: Same as accurate but with rating 'partially_accurate' and optional feedback
   - These should not change - only inaccurate path gets new behavior

E. **Ensure content persistence (per user decision):**
   - After validation, the AccuracyFeedbackDrawer should NOT be accessible again (already validated)
   - But the partner's empathy statement should remain visible on the Share page
   - The validation result (accurate/partial/inaccurate) should be visible somewhere
  </action>
  <verify>
```bash
cd /Users/shantam/Software/meet-without-fear && npm run check --workspace=mobile
cd /Users/shantam/Software/meet-without-fear && npm run test --workspace=mobile -- --testPathPattern="AccuracyFeedback|ValidationCoach" --passWithNoTests
```
Verify:
- onInaccurate opens feedback crafting flow (not just generic validation)
- Feedback goes through AI before delivery to partner
- Accurate and partially-accurate paths unchanged
  </verify>
  <done>
Subject tapping "Not quite" opens AI-mediated feedback chat. Subject describes concerns, AI crafts constructive feedback, subject approves. Approved feedback sent via empathy/validate endpoint. Accurate and partially-accurate paths work unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire guesser refinement UI and acceptance check</name>
  <files>
    mobile/src/screens/UnifiedSessionScreen.tsx
    mobile/src/utils/chatUIState.ts
    mobile/src/hooks/useUnifiedSession.ts
  </files>
  <action>
Wire the guesser's refinement flow and acceptance check after receiving subject's feedback.

**Current state:**
- `useResubmitEmpathy` hook exists (useStages.ts line 1122) - handles empathy resubmission
- `useSkipRefinement` hook exists (useStages.ts line 1290) - handles acceptance check
- PartnerContentCard has "Refine" button (shows when status is REFINING or AWAITING_SHARING)
- PartnerChatTab passes `onRefineEmpathy` prop to PartnerContentCard
- UnifiedSessionScreen already imports `useResubmitEmpathy` and has `resubmitEmpathy` mutation

**What needs wiring:**

A. **Guesser receives feedback notification:**
   - When subject validates as "inaccurate" with feedback, the backend sends an Ably event
   - Check `mobile/src/hooks/useUnifiedSession.ts` for how Ably events update the guesser's UI
   - The guesser should see: a chat message with the subject's feedback AND their empathy status changes to NEEDS_WORK or REFINING
   - Verify this Ably event handling already exists. If not, add handler for `empathy.feedback_received` or similar event

B. **Guesser refinement chat:**
   - When guesser's empathy status is REFINING/NEEDS_WORK, and they have feedback from subject:
     1. Chat should show AI intro message acknowledging the feedback
     2. A SHARED_CONTEXT-type message with the subject's feedback
     3. AI reflection message guiding the guesser
   - The guesser can then chat with AI to refine their empathy understanding
   - When ready, they tap "Refine" button on Share tab (PartnerContentCard already has this)
   - This should call `resubmitEmpathy` mutation with updated content

C. **Wire the Refine button action in UnifiedSessionScreen:**
   - Find where `onRefineEmpathy` is passed to PartnerChatTab
   - Ensure it calls `handleResubmitEmpathy` or similar handler
   - The handler should:
     1. Open a refinement drawer/modal where guesser can review and approve AI-suggested revisions
     2. On approval, call `resubmitEmpathy({ sessionId, content: revisedEmpathy })`
     3. This triggers reconciler re-run (which will PROCEED due to hasContextAlreadyBeenShared guard)

D. **Acceptance check UI (when guesser declines to refine):**
   - Per accuracy-feedback-flow.md and CONTEXT.md:
     1. AI presents: "You said [Original], and they say [Feedback]. With this adjustment, they say their experience is accurately reflected."
     2. AI asks: "Are you willing to accept this as their experience?"
     3. Options:
        - "I accept this is their experience" -> `useSkipRefinement({ sessionId, willingToAccept: true })` -> proceed
        - "I cannot accept" -> AI asks "Why?" -> guesser answers -> `useSkipRefinement({ sessionId, willingToAccept: false, reason: '...' })` -> proceed with disagreement logged
   - Implementation: After guesser sees feedback and chats with AI, if they indicate unwillingness to change, the AI should present the acceptance check. This may already be handled by the AI's prompting (backend handles the conversation flow), but the UI needs to support:
     - A final confirmation button or acceptance flow
     - Calling `useSkipRefinement` with the appropriate parameters

E. **chatUIState.ts updates (if needed):**
   - Check if `computeShowAccuracyFeedbackPanel` needs updating for the refinement state
   - The accuracy feedback panel should NOT show while guesser is in refinement mode
   - May need to add conditions based on empathy status (REFINING, NEEDS_WORK)

F. **Ensure content persistence:**
   - Share page should show: original empathy, feedback received, refined empathy (if resubmitted)
   - Nothing should disappear - all states are visible as a record
   - Chat page should show the full conversation including feedback messages
  </action>
  <verify>
```bash
cd /Users/shantam/Software/meet-without-fear && npm run check --workspace=mobile
cd /Users/shantam/Software/meet-without-fear && npm run test --workspace=mobile -- --passWithNoTests
```
Verify:
- onRefineEmpathy is wired in UnifiedSessionScreen
- Acceptance check calls useSkipRefinement with proper parameters
- chatUIState.ts handles refinement states correctly
  </verify>
  <done>
Guesser can: (1) see subject's feedback in chat and on Share page, (2) refine empathy via AI conversation and resubmit, (3) skip refinement via acceptance check ("I accept"/"I cannot accept"). Both Chat and Share pages persist all content as a record. Empathy status transitions work through REFINING -> resubmit -> reconciler re-run -> READY.
  </done>
</task>

</tasks>

<verification>
1. Subject "Not quite" path opens AI feedback chat, crafts feedback via AI, submits
2. Guesser receives feedback notification and sees it in chat + Share page
3. Guesser can refine empathy and resubmit via Refine button
4. Guesser can skip refinement via acceptance check (accept/decline with reason)
5. Content persists across Chat/Share navigation for both users
6. `npm run check --workspace=mobile` passes
7. `npm run test --workspace=mobile` passes
</verification>

<success_criteria>
- Full accuracy feedback inaccurate path works: subject rates inaccurate -> AI crafts feedback -> delivered to guesser -> guesser refines or accepts
- Acceptance check supports both "I accept" (proceed) and "I cannot accept" (reason collected, proceed)
- All content persists as record on both Chat and Share pages
- No UI state regression for PROCEED and OFFER paths
</success_criteria>

<output>
After completion, create `.planning/phases/08-reconciler-documentation-edge-cases/08-03-SUMMARY.md`
</output>
