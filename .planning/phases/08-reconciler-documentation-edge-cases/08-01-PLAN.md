---
phase: 08-reconciler-documentation-edge-cases
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/state-diagrams/reconciler-paths.md
  - backend/src/fixtures/reconciler-offer-optional.ts
  - backend/src/fixtures/reconciler-offer-sharing.ts
  - backend/src/fixtures/reconciler-refinement.ts
  - backend/src/fixtures/index.ts
autonomous: true
requirements:
  - RECON-DOC-01
  - RECON-DOC-02

must_haves:
  truths:
    - "State diagrams document guesser perspective for PROCEED, OFFER_OPTIONAL, OFFER_SHARING, refinement, accuracy feedback, and acceptance check"
    - "State diagrams document subject perspective for PROCEED, OFFER_OPTIONAL, OFFER_SHARING, refinement, accuracy feedback, and acceptance check"
    - "OFFER_OPTIONAL fixture returns reconciler-analysis with action OFFER_OPTIONAL and moderate severity"
    - "OFFER_SHARING fixture returns reconciler-analysis with action OFFER_SHARING and significant severity"
    - "Refinement fixture returns OFFER_SHARING on first reconciler-analysis and PROCEED on second"
    - "All three fixtures are registered in fixture registry and can be referenced by ID"
  artifacts:
    - path: "docs/state-diagrams/reconciler-paths.md"
      provides: "Mermaid state diagrams for all reconciler paths from both user perspectives"
      contains: "stateDiagram-v2"
    - path: "backend/src/fixtures/reconciler-offer-optional.ts"
      provides: "E2E fixture with OFFER_OPTIONAL reconciler outcome"
      contains: "OFFER_OPTIONAL"
    - path: "backend/src/fixtures/reconciler-offer-sharing.ts"
      provides: "E2E fixture with OFFER_SHARING reconciler outcome"
      contains: "OFFER_SHARING"
    - path: "backend/src/fixtures/reconciler-refinement.ts"
      provides: "E2E fixture with two-pass reconciler (OFFER_SHARING then PROCEED)"
      contains: "reconciler-analysis"
    - path: "backend/src/fixtures/index.ts"
      provides: "Updated fixture registry with new fixtures"
      contains: "reconcilerOfferOptional"
  key_links:
    - from: "backend/src/fixtures/index.ts"
      to: "backend/src/fixtures/reconciler-offer-optional.ts"
      via: "import and registry entry"
      pattern: "reconciler-offer-optional"
    - from: "backend/src/fixtures/index.ts"
      to: "backend/src/fixtures/reconciler-offer-sharing.ts"
      via: "import and registry entry"
      pattern: "reconciler-offer-sharing"
    - from: "backend/src/fixtures/index.ts"
      to: "backend/src/fixtures/reconciler-refinement.ts"
      via: "import and registry entry"
      pattern: "reconciler-refinement"
---

<objective>
Create state diagrams documenting all reconciler outcome paths from both user perspectives, and build deterministic E2E fixtures for OFFER_OPTIONAL, OFFER_SHARING, and refinement reconciler outcomes.

Purpose: These are foundational artifacts needed by all subsequent plans. State diagrams fulfill RECON-DOC-01/02 requirements and serve as reference for UI implementation. Fixtures enable deterministic E2E testing of each reconciler path.

Output: Mermaid state diagrams in docs/state-diagrams/reconciler-paths.md, three new E2E fixtures registered in fixture registry.
</objective>

<execution_context>
@/Users/shantam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@docs/user-flows/accuracy-feedback-flow.md
@docs/specs/when-the-reconciler-responds-with-offeroptional-we-need-to-implement-this.md
@docs/plans/2026-01-08-stage2-reconciler-flow-design.md
@backend/src/fixtures/reconciler-no-gaps.ts
@backend/src/fixtures/types.ts
@backend/src/fixtures/index.ts
@backend/src/services/reconciler.ts
@shared/src/dto/reconciler.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Mermaid state diagrams for all reconciler paths</name>
  <files>docs/state-diagrams/reconciler-paths.md</files>
  <action>
Create `docs/state-diagrams/reconciler-paths.md` with Mermaid `stateDiagram-v2` diagrams documenting ALL reconciler outcome paths from BOTH user perspectives (guesser and subject). Per user decision: separate per-user diagrams for each outcome, NOT unified swim lanes.

Cover these paths (per CONTEXT.md decisions):

1. **PROCEED path** (no gaps)
   - Guesser: HELD -> ANALYZING -> READY -> REVEALED -> (subject validates) -> VALIDATED
   - Subject: Confirms feel-heard -> reconciler finds no gaps -> sees partner empathy revealed -> validates accuracy

2. **OFFER_OPTIONAL path** (moderate gaps)
   - Guesser: HELD -> ANALYZING -> AWAITING_SHARING -> (subject decides) -> READY -> REVEALED
   - Subject: Sees ShareTopicPanel (blue, soft language "might consider sharing") -> Accept/Decline
   - Accept branch: AI drafts context -> subject reviews/shares -> guesser receives context -> refinement possible
   - Decline branch: Confirmation dialog -> mark READY -> guesser sees normal reveal flow (no indication of declined offer per decision)

3. **OFFER_SHARING path** (significant gaps)
   - Same as OFFER_OPTIONAL but with strong language (orange, "share more about")
   - Same accept/decline branches

4. **Refinement loop** (one cycle only per CONTEXT.md)
   - Subject shares context -> delivered to guesser as SHARED_CONTEXT message in chat
   - Guesser: Sees shared context + AI reflection + "Refine" button on Share tab
   - Guesser refines empathy via AI chat -> resubmits -> reconciler re-runs -> PROCEED
   - Guesser can also skip refinement (acceptance check)

5. **Accuracy feedback paths** (post-reveal)
   - Subject sees AccuracyFeedbackDrawer with partner's empathy statement
   - Accurate: Validate -> both proceed to Stage 3
   - Partially Accurate: Optional feedback -> validate -> proceed
   - Inaccurate: Subject crafts feedback via AI coach -> delivered to guesser -> guesser refines or accepts

6. **Acceptance check** (guesser declines to refine)
   - AI asks "Are you willing to accept this as their experience?"
   - Yes (accepts): Proceed to Stage 3
   - No (does not accept): AI collects reason -> proceed with disagreement logged

Reference existing diagrams in `docs/plans/2026-01-08-stage2-reconciler-flow-design.md` for Mermaid patterns. Use annotations/notes on states to describe what each user SEES in the UI (panels, buttons, banners).

Add a brief text description above each diagram explaining the scenario.
  </action>
  <verify>
Verify file exists and contains valid Mermaid syntax:
- File contains at least 6 `stateDiagram-v2` blocks (2 per major path minimum)
- Each diagram has both guesser and subject variants
- Diagrams reference specific UI elements (ShareTopicPanel, AccuracyFeedbackDrawer, Refine button)
- `grep -c 'stateDiagram-v2' docs/state-diagrams/reconciler-paths.md` returns >= 6
  </verify>
  <done>
State diagrams exist documenting both user perspectives for PROCEED, OFFER_OPTIONAL, OFFER_SHARING, refinement, accuracy feedback (accurate/partial/inaccurate), and acceptance check. Each diagram annotates what the user sees in the UI.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create OFFER_OPTIONAL, OFFER_SHARING, and refinement E2E fixtures</name>
  <files>
    backend/src/fixtures/reconciler-offer-optional.ts
    backend/src/fixtures/reconciler-offer-sharing.ts
    backend/src/fixtures/reconciler-refinement.ts
    backend/src/fixtures/index.ts
  </files>
  <action>
Create three new E2E fixtures following the exact pattern in `backend/src/fixtures/reconciler-no-gaps.ts`:

**1. `reconciler-offer-optional.ts`**
- Same seed user as reconciler-no-gaps (user-b pattern: Darryl Test)
- Same Stage 1 witnessing responses (responses 0-3 with FeelHeardCheck: Y on response 3)
- Same Stage 2 empathy building responses (responses 4-6 with ReadyShare: Y on response 6)
- `operations` section:
  - `reconciler-analysis`: Returns `action: 'OFFER_OPTIONAL'`, `severity: 'moderate'`, score ~70, `suggestedShareFocus: 'Work stress and feeling unappreciated'`
  - `reconciler-share-suggestion`: Returns `suggestedContent` and `reason` for optional share topic
- Export as `reconcilerOfferOptional`

**2. `reconciler-offer-sharing.ts`**
- Same seed user pattern
- Same responses as offer-optional (reuse same Stage 1+2 messages)
- `operations` section:
  - `reconciler-analysis`: Returns `action: 'OFFER_SHARING'`, `severity: 'significant'`, score ~45, `suggestedShareFocus: 'The depth of exhaustion and feeling taken for granted at work'`
  - `reconciler-share-suggestion`: Returns `suggestedContent` and `reason` for sharing suggestion
- Export as `reconcilerOfferSharing`

**3. `reconciler-refinement.ts`**
- Same seed user pattern
- Same Stage 1+2 responses
- `operations` section needs TWO reconciler-analysis responses. Since the fixture system uses exact key matching, check how the fixture system handles multiple calls to the same operation. If it cannot, use the same OFFER_SHARING response for the first call (the second call after refinement will use the SAME key but by that point the test should have the guesser resubmit empathy which creates a new reconciler run).
  - `reconciler-analysis`: Returns `action: 'OFFER_SHARING'` (first pass - significant gaps)
  - `reconciler-share-suggestion`: Returns share suggestion content
  - `reconciler-refine-suggestion`: Returns refine suggestion content (for when guesser refines)
- NOTE: After guesser resubmits, the reconciler re-runs and calls `reconciler-analysis` again. Since fixtures return the same response for the same operation key, the second analysis will ALSO return OFFER_SHARING. However, the `hasContextAlreadyBeenShared` guard (Phase 6 fix) will intercept this and mark as READY instead. This means the refinement fixture naturally works without needing two different analysis responses - the guard does the work.
- Export as `reconcilerRefinement`

**Register all three in `backend/src/fixtures/index.ts`:**
- Add imports for all three fixtures
- Add to `fixtureRegistry` with IDs: `'reconciler-offer-optional'`, `'reconciler-offer-sharing'`, `'reconciler-refinement'`
- Add to named exports

IMPORTANT: Verify exact operation names match what `backend/src/services/reconciler.ts` uses:
- `reconciler-analysis` (line ~1556)
- `reconciler-share-suggestion` (line ~901)
- `reconciler-refine-suggestion` (verify exact name by searching reconciler.ts)
  </action>
  <verify>
```bash
cd /Users/shantam/Software/meet-without-fear && npm run check --workspace=backend
cd /Users/shantam/Software/meet-without-fear && npm run test --workspace=backend -- --testPathPattern="fixtures" --passWithNoTests
```
Also verify:
- `grep 'reconciler-offer-optional' backend/src/fixtures/index.ts` returns match
- `grep 'reconciler-offer-sharing' backend/src/fixtures/index.ts` returns match
- `grep 'reconciler-refinement' backend/src/fixtures/index.ts` returns match
  </verify>
  <done>
Three new fixtures exist: reconciler-offer-optional (OFFER_OPTIONAL with moderate gaps), reconciler-offer-sharing (OFFER_SHARING with significant gaps), reconciler-refinement (OFFER_SHARING + guard-based PROCEED on resubmit). All registered in fixture registry with correct IDs. Backend types check passes.
  </done>
</task>

</tasks>

<verification>
1. `docs/state-diagrams/reconciler-paths.md` exists with >= 6 Mermaid state diagrams
2. All three fixture files exist and export correctly typed E2EFixture objects
3. `backend/src/fixtures/index.ts` registers all three with correct IDs
4. `npm run check --workspace=backend` passes
5. Operation names in fixtures match exact strings used in `backend/src/services/reconciler.ts`
</verification>

<success_criteria>
- State diagrams document BOTH user perspectives for PROCEED, OFFER_OPTIONAL, OFFER_SHARING, refinement, accuracy feedback, and acceptance check
- Three new fixtures registered and type-checked
- Fixture operation names match backend reconciler.ts exact strings
</success_criteria>

<output>
After completion, create `.planning/phases/08-reconciler-documentation-edge-cases/08-01-SUMMARY.md`
</output>
