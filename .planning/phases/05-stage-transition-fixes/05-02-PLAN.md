---
phase: 05-stage-transition-fixes
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - e2e/tests/two-browser-stage-0-1.spec.ts
  - e2e/tests/two-browser-stage-2.spec.ts
autonomous: true

must_haves:
  truths:
    - "Existing Stage 0-1 E2E test still passes (no regressions from event handler changes)"
    - "Existing Stage 2 E2E test still passes (no regressions from partner.stage_completed handler changes)"
    - "Stage 0-1 tests continue to pass with new Ably event handlers active"
  artifacts:
    - path: "e2e/tests/two-browser-stage-0-1.spec.ts"
      provides: "Stage 0-1 regression test"
    - path: "e2e/tests/two-browser-stage-2.spec.ts"
      provides: "Stage 2 regression test"
  key_links:
    - from: "mobile/src/screens/UnifiedSessionScreen.tsx"
      to: "e2e/tests/two-browser-stage-0-1.spec.ts"
      via: "New Ably handlers fire during compact signing flow"
      pattern: "partner\\.signed_compact"
    - from: "mobile/src/screens/UnifiedSessionScreen.tsx"
      to: "e2e/tests/two-browser-stage-2.spec.ts"
      via: "Updated partner.stage_completed handler fires during Stage 3 entry"
      pattern: "partner\\.stage_completed"
---

<objective>
Run existing E2E tests to verify Plan 01 changes don't break existing functionality.

Purpose: Plan 01 modified Ably event handlers in UnifiedSessionScreen.tsx and added new event publications in backend controllers. These changes affect code paths exercised by existing two-browser E2E tests. This plan verifies no regressions were introduced.

Output: Confirmation that all existing E2E tests pass with the new event handling code.
</objective>

<execution_context>
@/Users/shantam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-stage-transition-fixes/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run Stage 0-1 and Stage 2 E2E regression tests</name>
  <files>
    e2e/tests/two-browser-stage-0-1.spec.ts
    e2e/tests/two-browser-stage-2.spec.ts
  </files>
  <action>
  Run the existing E2E tests to verify no regressions from Plan 01 changes.

  1. Start the backend server if not running:
     ```bash
     cd /Users/shantam/Software/meet-without-fear/backend && npm run dev
     ```

  2. Start the mobile web server if not running:
     ```bash
     cd /Users/shantam/Software/meet-without-fear/mobile && npx expo start --web
     ```

  3. Run the Stage 0-1 E2E test:
     ```bash
     cd /Users/shantam/Software/meet-without-fear/e2e && npx playwright test --config=playwright.two-browser.config.ts two-browser-stage-0-1
     ```
     This test exercises:
     - Compact signing flow (will now trigger new `partner.signed_compact` events)
     - Feel-heard confirmation flow (existing `useConfirmFeelHeard` cache updates)
     - The new Ably handlers must not interfere with existing test flow

  4. Run the Stage 2 E2E test:
     ```bash
     cd /Users/shantam/Software/meet-without-fear/e2e && npx playwright test --config=playwright.two-browser.config.ts two-browser-stage-2 --timeout 900000
     ```
     This test exercises:
     - Empathy sharing and reconciler flow
     - Stage 2â†’3 transition (will now trigger updated `partner.stage_completed` handler)
     - Stage 3 entry verification (chat input visible)

  5. If either test fails:
     - Capture the error output
     - Check if failure is related to Plan 01 changes (new event handlers causing unexpected cache updates)
     - If Plan 01 changes caused the failure: fix the issue in the relevant file (UnifiedSessionScreen.tsx handler or backend controller)
     - If failure is pre-existing/flaky: document as known issue, not a regression

  6. If both tests pass: document results and confirm no regressions.
  </action>
  <verify>
  Both commands should exit with 0 status:
  ```bash
  cd /Users/shantam/Software/meet-without-fear/e2e && npx playwright test --config=playwright.two-browser.config.ts two-browser-stage-0-1
  cd /Users/shantam/Software/meet-without-fear/e2e && npx playwright test --config=playwright.two-browser.config.ts two-browser-stage-2 --timeout 900000
  ```
  </verify>
  <done>
  1. Stage 0-1 E2E test passes with new Ably event handlers active
  2. Stage 2 E2E test passes with updated partner.stage_completed handler
  3. No regressions introduced by Plan 01 changes
  4. If any test fixes were needed, they are committed and documented
  </done>
</task>

</tasks>

<verification>
1. Stage 0-1 two-browser E2E test passes
2. Stage 2 two-browser E2E test passes (15-minute timeout)
3. No new test failures compared to Phase 4 baseline
</verification>

<success_criteria>
- Both existing E2E tests pass without modifications (or with documented non-regression fixes)
- Stage transitions with new Ably events don't cause test failures
- All Phase 5 requirements verified through test execution:
  - TRANS-01: Triggering user sees correct cache update (verified by existing test assertions)
  - TRANS-02: Partner receives Ably notification (verified by new event handlers firing during tests)
  - TRANS-03: Feel-heard advances stages (verified by Stage 0-1 test)
  - TRANS-04: Empathy sharing triggers reconciler (verified by Stage 2 test)
</success_criteria>

<output>
After completion, create `.planning/phases/05-stage-transition-fixes/05-02-SUMMARY.md`
</output>
