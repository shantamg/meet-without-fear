---
phase: 06-reconciler-fixes
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - e2e/tests/two-browser-stage-2.spec.ts
autonomous: true

must_haves:
  truths:
    - "Stage 2 E2E test passes with reconciler fixes active"
    - "Both users complete Stage 2 and enter Stage 3 in the two-browser test"
    - "No regressions in Stage 0-1 E2E tests"
  artifacts:
    - path: "e2e/tests/two-browser-stage-2.spec.ts"
      provides: "Passing Stage 2 E2E test with reconciler fixes"
  key_links:
    - from: "e2e/tests/two-browser-stage-2.spec.ts"
      to: "backend/src/services/reconciler.ts"
      via: "HTTP API calls trigger reconciler"
      pattern: "empathy.*consent|empathy.*share"
---

<objective>
Verify reconciler fixes via E2E regression tests

Purpose: Confirm that the reconciler guard and race condition fixes from Plan 01 work correctly in the full two-browser E2E flow. This is the same verification pattern used in Phase 05-02.

Output: All E2E tests passing (Stage 0-1 and Stage 2), confirming reconciler fixes don't break existing behavior.
</objective>

<execution_context>
@/Users/shantam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-reconciler-fixes/06-01-SUMMARY.md
@.planning/phases/05-stage-transition-fixes/05-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run Stage 0-1 and Stage 2 E2E regression tests</name>
  <files>e2e/tests/two-browser-stage-2.spec.ts</files>
  <action>
Run all two-browser E2E tests in sequence to verify no regressions from Plan 01 reconciler fixes:

1. Run Stage 0-1 tests first (fast, ~7min total):
   ```
   cd /Users/shantam/Software/meet-without-fear/e2e && npx playwright test --config=playwright.two-browser.config.ts two-browser-stage-0.spec.ts two-browser-stage-1.spec.ts
   ```
   Expected: Both pass (same as Phase 05-02 baseline). If either fails, investigate whether Plan 01 changes caused regression.

2. Run Stage 2 test (~12-15min):
   ```
   cd /Users/shantam/Software/meet-without-fear/e2e && npx playwright test --config=playwright.two-browser.config.ts two-browser-stage-2.spec.ts
   ```
   Expected: Passes with reconciler no-gaps fixture (deterministic path). The reconciler guard fix should be transparent for the no-gaps path since `hasContextAlreadyBeenShared` is only relevant when gaps exist and sharing occurs.

3. If any test fails:
   - Check backend logs for errors related to `hasContextAlreadyBeenShared` import changes
   - Check for TypeScript compilation errors in the backend
   - Check that `runReconcilerForDirection` still returns the same shape response
   - If failure is unrelated to Plan 01 changes, document as pre-existing issue
   - If failure IS related to Plan 01 changes, fix the issue and re-run

4. Record exact test runtimes and pass/fail status for SUMMARY.md.
  </action>
  <verify>
All three test files pass:
- `two-browser-stage-0.spec.ts` PASSED
- `two-browser-stage-1.spec.ts` PASSED
- `two-browser-stage-2.spec.ts` PASSED

Check backend logs during test execution for any CRITICAL errors or unexpected warnings from reconciler:
- No "CRITICAL: Could not find reconcilerResult" errors
- No "hasContextAlreadyBeenShared" import errors
- Reconciler completes normally (logs show "Analysis complete" and "No sharing needed" for no-gaps fixture)
  </verify>
  <done>
1. Stage 0 E2E test passes (compact signing flow verified)
2. Stage 1 E2E test passes (feel-heard flow verified)
3. Stage 2 E2E test passes (empathy sharing, reconciler, validation, Stage 3 entry verified)
4. No regressions from reconciler fixes
5. Backend logs clean - no CRITICAL errors
  </done>
</task>

</tasks>

<verification>
1. All 3 E2E test files pass: Stage 0, Stage 1, Stage 2
2. Stage 2 test completes full flow through Stage 3 entry
3. No CRITICAL errors in backend logs
4. Test runtimes comparable to Phase 05-02 baseline (~7min for 0-1, ~12min for 2)
</verification>

<success_criteria>
- All two-browser E2E tests pass without flakiness
- Reconciler fixes are transparent to the no-gaps test path
- Phase 6 requirements RECON-01/02/03 validated through test execution
</success_criteria>

<output>
After completion, create `.planning/phases/06-reconciler-fixes/06-02-SUMMARY.md`
</output>
