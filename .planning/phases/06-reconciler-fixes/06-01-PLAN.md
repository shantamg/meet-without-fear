---
phase: 06-reconciler-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/services/reconciler.ts
  - backend/src/controllers/stage2.ts
autonomous: true

must_haves:
  truths:
    - "Reconciler never creates a second share offer after context has already been shared for a direction"
    - "ReconcilerResult is always found when generating share suggestion (no retry loop failures)"
    - "Resubmit flow respects sharing history guard at the source (runReconcilerForDirection) not post-hoc"
  artifacts:
    - path: "backend/src/services/reconciler.ts"
      provides: "Sharing history guard in runReconcilerForDirection, ReconcilerResult passed by reference"
      contains: "hasContextAlreadyBeenShared"
    - path: "backend/src/controllers/stage2.ts"
      provides: "Simplified triggerReconcilerForUser without post-hoc guard"
  key_links:
    - from: "backend/src/services/reconciler.ts:runReconcilerForDirection"
      to: "backend/src/controllers/stage2.ts:hasContextAlreadyBeenShared"
      via: "import and call before setting AWAITING_SHARING"
      pattern: "hasContextAlreadyBeenShared.*sessionId"
    - from: "backend/src/services/reconciler.ts:analyzeEmpathyGap"
      to: "backend/src/services/reconciler.ts:generateShareSuggestion"
      via: "ReconcilerResult DB record passed as parameter"
      pattern: "dbReconcilerResult"
---

<objective>
Fix reconciler infinite share loop and ReconcilerResult visibility race condition

Purpose: The reconciler has two critical bugs that block reliable Stage 2 completion:
1. `runReconcilerForDirection()` lacks the `hasContextAlreadyBeenShared()` guard, allowing infinite share offer loops when guesser resubmits refined empathy
2. `generateShareSuggestion()` re-queries ReconcilerResult via a fragile 100ms retry loop instead of using the already-available object reference

Output: Backend fixes in reconciler.ts and stage2.ts that prevent infinite loops and eliminate race condition
</objective>

<execution_context>
@/Users/shantam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-reconciler-fixes/06-RESEARCH.md
@.planning/phases/01-audit/01-02-AUDIT-RECONCILER.md
@backend/src/services/reconciler.ts
@backend/src/controllers/stage2.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sharing history guard to runReconcilerForDirection and pass ReconcilerResult by reference</name>
  <files>backend/src/services/reconciler.ts, backend/src/controllers/stage2.ts</files>
  <action>
**In `backend/src/services/reconciler.ts`:**

1. Import `hasContextAlreadyBeenShared` from stage2.ts (or move the function to reconciler.ts since it's a reconciler concern). The function is currently defined in stage2.ts at lines 75-100 as a module-private function. Since reconciler.ts needs it, EITHER:
   - Export it from stage2.ts and import in reconciler.ts, OR
   - Move the function to reconciler.ts and export it (preferred - keeps reconciler logic together)

   **Decision: Move `hasContextAlreadyBeenShared` to reconciler.ts and export it.** Update stage2.ts to import from reconciler.ts.

2. In `runReconcilerForDirection()` (lines 530-704), add the sharing history guard BEFORE setting status to AWAITING_SHARING. Currently, lines 606-608 determine `shouldOfferSharing` and line 666-680 set AWAITING_SHARING unconditionally. Change to:
   ```
   if (shouldOfferSharing) {
     // Check if context has already been shared for this direction
     const contextAlreadyShared = await hasContextAlreadyBeenShared(sessionId, guesserId, subjectId);
     if (contextAlreadyShared) {
       console.log(`[Reconciler] Context already shared ${subjectId}->${guesserId}, skipping AWAITING_SHARING, marking READY`);
       // Same as the no-gaps path: mark READY, create alignment message, check reveal
       await prisma.empathyAttempt.updateMany({...});
       // Create alignment message (same as lines 622-653)
       // Call checkAndRevealBothIfReady
       return { result, empathyStatus: 'READY', shareOffer: null };
     }
     // Existing AWAITING_SHARING logic (lines 666-703)
   }
   ```

   To avoid code duplication, extract the "mark READY" logic (lines 614-662) into a helper function like `markEmpathyReady()` that:
   - Updates empathy attempt status to READY
   - Creates alignment message for guesser
   - Publishes alignment message via Ably
   - Calls checkAndRevealBothIfReady

3. Fix the ReconcilerResult visibility race in `generateShareSuggestion()` (lines 710-851). Currently at lines 792-813, it re-queries the ReconcilerResult with a 3-attempt retry loop. Instead:

   a. In `analyzeEmpathyGap()` (lines 1402-1529), after `prisma.reconcilerResult.create()` at line 1467, capture the returned DB record:
   ```
   const dbRecord = await prisma.reconcilerResult.create({ data: {...} });
   ```
   Store `dbRecord.id` on the returned result object (add a `dbId` field to the return value, or return it alongside).

   b. In `runReconcilerForDirection()`, after calling `analyzeEmpathyGap()`, the DB record already exists. Query it ONCE right there (since we're in the same execution context, no transaction isolation issue):
   ```
   const dbReconcilerResult = await prisma.reconcilerResult.findUnique({
     where: { sessionId_guesserId_subjectId: { sessionId, guesserId, subjectId } }
   });
   ```
   Pass `dbReconcilerResult` to `generateShareSuggestion()`.

   c. Update `generateShareSuggestion()` signature to accept an optional `dbReconcilerResult` parameter. When provided, skip the retry loop entirely and use it directly. When not provided (for backward compat with `generateShareSuggestionForDirection`), keep the existing query (but this path is less critical).

4. Remove the retry loop (lines 794-813) when `dbReconcilerResult` is provided. Replace with:
   ```
   const dbResult = dbReconcilerResult || await findReconcilerResultWithRetry(sessionId, guesser.id, subject.id);
   ```
   Extract the retry loop into a named function `findReconcilerResultWithRetry` for the fallback path only.

**In `backend/src/controllers/stage2.ts`:**

5. Remove the `hasContextAlreadyBeenShared` function definition (lines 75-100) and import it from reconciler.ts instead.

6. Simplify `triggerReconcilerForUser()` (lines 2023-2079). The post-hoc guard at lines 2047-2065 is no longer needed because `runReconcilerForDirection()` now has the guard built-in. Remove the `hasContextAlreadyBeenShared` check and the override logic. The function becomes:
   ```
   async function triggerReconcilerForUser(...) {
     const result = await runReconcilerForDirection(sessionId, guesserId, subjectId);
     if (!result.result) { return; }
     console.log(`[triggerReconcilerForUser] Reconciler complete: ...`);
     await checkAndRevealBothIfReady(sessionId);
   }
   ```

7. Update `triggerReconcilerAndUpdateStatuses()` (lines 110-269) to also import `hasContextAlreadyBeenShared` from reconciler.ts (it still uses the function at lines 155-156 and 205-206). Since this function calls `runReconciler()` (symmetric flow) which does NOT have the guard internally, the existing check here must stay.
  </action>
  <verify>
Run `cd /Users/shantam/Software/meet-without-fear && npm run check` to verify TypeScript compilation passes with no errors.

Run `cd /Users/shantam/Software/meet-without-fear && npm run test -- --filter backend` to verify existing backend tests pass.

Grep for the retry loop pattern `attempt <= 3` in reconciler.ts to confirm it's been extracted/guarded.

Grep for `hasContextAlreadyBeenShared` in reconciler.ts to confirm the guard exists in `runReconcilerForDirection`.

Grep for `hasContextAlreadyBeenShared` in stage2.ts to confirm the function definition is removed (only imports remain).
  </verify>
  <done>
1. `runReconcilerForDirection()` checks `hasContextAlreadyBeenShared()` before setting AWAITING_SHARING - if context already shared, marks READY instead
2. `generateShareSuggestion()` accepts optional DB record parameter, eliminating retry loop when called from `runReconcilerForDirection()`
3. `triggerReconcilerForUser()` simplified - no post-hoc guard needed
4. `hasContextAlreadyBeenShared()` moved to reconciler.ts and exported
5. All TypeScript compilation and existing tests pass
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npm run check` passes
2. Backend tests: `npm run test -- --filter backend` passes
3. Guard present: `grep -n "hasContextAlreadyBeenShared" backend/src/services/reconciler.ts` shows function definition AND usage in `runReconcilerForDirection`
4. Retry loop guarded: The 3-attempt retry loop in `generateShareSuggestion` is bypassed when `dbReconcilerResult` parameter is provided
5. No duplicate guard: `triggerReconcilerForUser` no longer has its own `hasContextAlreadyBeenShared` check
</verification>

<success_criteria>
- `runReconcilerForDirection()` cannot set AWAITING_SHARING when context has already been shared
- `generateShareSuggestion()` never fails to find ReconcilerResult when called from the normal flow
- `triggerReconcilerForUser()` relies on the guard in `runReconcilerForDirection()` instead of post-hoc override
- All existing backend tests pass
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/06-reconciler-fixes/06-01-SUMMARY.md`
</output>
