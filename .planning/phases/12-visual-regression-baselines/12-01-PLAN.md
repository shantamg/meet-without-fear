---
phase: 12-visual-regression-baselines
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - e2e/playwright.config.ts
  - e2e/playwright.two-browser.config.ts
  - e2e/.gitignore
  - e2e/tests/stage-2-empathy/reconciler/no-gaps-screenshot.spec.ts
  - e2e/tests/two-browser-reconciler-offer-optional.spec.ts
  - e2e/tests/two-browser-reconciler-offer-sharing-refinement.spec.ts
  - e2e/tests/two-browser-circuit-breaker.spec.ts
autonomous: true
requirements:
  - RECON-VIS-03
  - RECON-VIS-04

must_haves:
  truths:
    - "All reconciler E2E tests use toHaveScreenshot() assertions instead of page.screenshot()"
    - "Playwright configs define global toHaveScreenshot tolerance settings"
    - "Baseline snapshot directories are not gitignored"
    - "Validation button screenshots use toHaveScreenshot() for both users (RECON-VIS-03)"
    - "Empathy reveal state screenshots use toHaveScreenshot() for both users (RECON-VIS-04)"
  artifacts:
    - path: "e2e/playwright.config.ts"
      provides: "Global toHaveScreenshot configuration with maxDiffPixels and animations disabled"
      contains: "toHaveScreenshot"
    - path: "e2e/playwright.two-browser.config.ts"
      provides: "Two-browser config with matching toHaveScreenshot settings"
      contains: "toHaveScreenshot"
    - path: "e2e/tests/two-browser-reconciler-offer-optional.spec.ts"
      provides: "OFFER_OPTIONAL screenshots as visual regression assertions"
      contains: "toHaveScreenshot"
    - path: "e2e/tests/two-browser-reconciler-offer-sharing-refinement.spec.ts"
      provides: "OFFER_SHARING screenshots as visual regression assertions"
      contains: "toHaveScreenshot"
    - path: "e2e/tests/two-browser-circuit-breaker.spec.ts"
      provides: "Circuit breaker screenshots as visual regression assertions"
      contains: "toHaveScreenshot"
    - path: "e2e/tests/stage-2-empathy/reconciler/no-gaps-screenshot.spec.ts"
      provides: "No-gaps screenshots as visual regression assertions"
      contains: "toHaveScreenshot"
  key_links:
    - from: "e2e/playwright.config.ts"
      to: "e2e/tests/**/*.spec.ts"
      via: "toHaveScreenshot global config inherited by all tests"
      pattern: "toHaveScreenshot.*maxDiffPixels"
---

<objective>
Convert all reconciler E2E test screenshots from documentation-only `page.screenshot()` to visual regression `toHaveScreenshot()` assertions. Add global tolerance configuration to Playwright configs.

Purpose: Reconciler screenshots become automated regression tests that fail when UI changes unexpectedly, satisfying RECON-VIS-03 (validation buttons) and RECON-VIS-04 (empathy reveal state).

Output: 4 reconciler test files converted, 2 Playwright configs updated, .gitignore updated for baseline snapshots.
</objective>

<execution_context>
@/Users/shantam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-visual-regression-baselines/12-RESEARCH.md
@e2e/playwright.config.ts
@e2e/playwright.two-browser.config.ts
@e2e/.gitignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add toHaveScreenshot global config and update .gitignore</name>
  <files>
    e2e/playwright.config.ts
    e2e/playwright.two-browser.config.ts
    e2e/.gitignore
  </files>
  <action>
    1. In `e2e/playwright.config.ts`, add `toHaveScreenshot` settings inside the existing `expect` block:
       ```typescript
       expect: {
         timeout: 10000,
         toHaveScreenshot: {
           maxDiffPixels: 100,
           threshold: 0.2,
           animations: 'disabled',
         },
       },
       ```

    2. In `e2e/playwright.two-browser.config.ts`, add matching `toHaveScreenshot` settings inside the existing `expect` block:
       ```typescript
       expect: {
         timeout: 15000,
         toHaveScreenshot: {
           maxDiffPixels: 100,
           threshold: 0.2,
           animations: 'disabled',
         },
       },
       ```

    3. In `e2e/.gitignore`, ensure `-snapshots/` directories are NOT listed (they shouldn't be since baselines must be committed). Verify `test-results/` IS listed (for transient artifacts). No changes needed if already correct.

    Do NOT add `fullPage: true` to global config (React Native Web renders in fixed viewport — fullPage captures empty space).
  </action>
  <verify>
    grep "toHaveScreenshot" e2e/playwright.config.ts e2e/playwright.two-browser.config.ts
    grep -v "snapshots" e2e/.gitignore  # Confirm -snapshots/ is NOT gitignored
  </verify>
  <done>Both Playwright configs have toHaveScreenshot global settings with maxDiffPixels: 100, threshold: 0.2, animations: 'disabled'. Snapshot directories are not gitignored.</done>
</task>

<task type="auto">
  <name>Task 2: Convert reconciler test screenshots to toHaveScreenshot assertions</name>
  <files>
    e2e/tests/stage-2-empathy/reconciler/no-gaps-screenshot.spec.ts
    e2e/tests/two-browser-reconciler-offer-optional.spec.ts
    e2e/tests/two-browser-reconciler-offer-sharing-refinement.spec.ts
    e2e/tests/two-browser-circuit-breaker.spec.ts
  </files>
  <action>
    Convert every `page.screenshot({ path: 'test-results/...' })` or `page.screenshot({ path: screenshotPath, ... })` call in the 4 reconciler test files to `expect(page).toHaveScreenshot('name.png')` assertions.

    **Conversion pattern:**
    ```typescript
    // BEFORE:
    await page.screenshot({ path: 'test-results/offer-optional-01-guesser-waiting.png' });

    // AFTER:
    await expect(page).toHaveScreenshot('offer-optional-01-guesser-waiting.png', {
      maxDiffPixels: 100,
    });
    ```

    **For each file:**

    1. **no-gaps-screenshot.spec.ts** (2 screenshots):
       - Convert `userBPage.screenshot({ path: ... })` calls to `expect(userBPage).toHaveScreenshot(...)`.
       - Remove the `SCREENSHOT_DIR` variable and `path.join()` logic — no longer needed since toHaveScreenshot auto-manages paths.
       - Remove the `import * as path from 'path'` and `import * as fs from 'fs'` if they become unused after conversion.
       - Keep `fullPage: false` option on the empathy validation buttons screenshot.

    2. **two-browser-reconciler-offer-optional.spec.ts** (15 screenshots):
       - Convert all `harness.userAPage.screenshot(...)` and `harness.userBPage.screenshot(...)` to `expect(harness.userAPage).toHaveScreenshot(...)` and `expect(harness.userBPage).toHaveScreenshot(...)`.
       - Extract screenshot name from the `path:` value (e.g., `'test-results/offer-optional-01-guesser-waiting.png'` → `'offer-optional-01-guesser-waiting.png'`).

    3. **two-browser-reconciler-offer-sharing-refinement.spec.ts** (20 screenshots):
       - Same conversion pattern. Extract filenames from path values.
       - Some screenshots use multi-line format — collapse to single toHaveScreenshot call.

    4. **two-browser-circuit-breaker.spec.ts** (5 screenshots):
       - Same conversion pattern.

    **Important rules:**
    - Do NOT add `animations: 'disabled'` per-screenshot — it's already in the global config.
    - DO add `maxDiffPixels: 100` per-screenshot for explicitness (overrides global if global changes).
    - Do NOT add `mask` arrays yet — timestamps in these tests come from fixture data, not real time.
    - Do NOT change any test logic, assertions, or wait patterns — only convert screenshot calls.
    - Remove any `import * as path` or `import * as fs` that become unused after removing hardcoded paths.
  </action>
  <verify>
    # Verify no old-style screenshots remain in reconciler files:
    grep -c "\.screenshot(" e2e/tests/stage-2-empathy/reconciler/no-gaps-screenshot.spec.ts e2e/tests/two-browser-reconciler-offer-optional.spec.ts e2e/tests/two-browser-reconciler-offer-sharing-refinement.spec.ts e2e/tests/two-browser-circuit-breaker.spec.ts

    # Verify toHaveScreenshot is used in all files:
    grep -c "toHaveScreenshot" e2e/tests/stage-2-empathy/reconciler/no-gaps-screenshot.spec.ts e2e/tests/two-browser-reconciler-offer-optional.spec.ts e2e/tests/two-browser-reconciler-offer-sharing-refinement.spec.ts e2e/tests/two-browser-circuit-breaker.spec.ts

    # TypeScript check:
    cd e2e && npx tsc --noEmit 2>&1 | head -20
  </verify>
  <done>All 42 reconciler screenshots converted from page.screenshot() to expect().toHaveScreenshot(). Zero old-style screenshot calls remain in the 4 reconciler test files. TypeScript compiles without errors.</done>
</task>

</tasks>

<verification>
1. `grep -r "\.screenshot(" e2e/tests/stage-2-empathy/reconciler/ e2e/tests/two-browser-reconciler-*.spec.ts e2e/tests/two-browser-circuit-breaker.spec.ts` returns no matches (all converted)
2. `grep -c "toHaveScreenshot" e2e/tests/stage-2-empathy/reconciler/no-gaps-screenshot.spec.ts` returns >= 1
3. `grep "toHaveScreenshot" e2e/playwright.config.ts` returns config with maxDiffPixels
4. `npm run check` passes (TypeScript)
</verification>

<success_criteria>
- All 42 reconciler screenshots use toHaveScreenshot() assertions
- Both Playwright configs have toHaveScreenshot global settings
- Snapshot directories are committable (not gitignored)
- No old-style page.screenshot() calls remain in reconciler test files
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-visual-regression-baselines/12-01-SUMMARY.md`
</output>
