---
phase: 12-visual-regression-baselines
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - e2e/tests/two-browser-stage-3.spec.ts
  - e2e/tests/two-browser-stage-4.spec.ts
  - e2e/tests/needs-confirmation-visual.spec.ts
  - e2e/tests/needs-tab-visual.spec.ts
autonomous: true
requirements:
  - E2E-03

must_haves:
  truths:
    - "All Stage 3-4 E2E tests use toHaveScreenshot() assertions instead of page.screenshot()"
    - "Stage 3 needs review screenshots use toHaveScreenshot() for both users"
    - "Stage 4 strategy pool, ranking, overlap, and agreement screenshots use toHaveScreenshot()"
    - "Needs confirmation visual tests use toHaveScreenshot()"
    - "Needs tab visual tests use toHaveScreenshot()"
  artifacts:
    - path: "e2e/tests/two-browser-stage-3.spec.ts"
      provides: "Stage 3 screenshots as visual regression assertions"
      contains: "toHaveScreenshot"
    - path: "e2e/tests/two-browser-stage-4.spec.ts"
      provides: "Stage 4 screenshots as visual regression assertions"
      contains: "toHaveScreenshot"
    - path: "e2e/tests/needs-confirmation-visual.spec.ts"
      provides: "Needs confirmation screenshots as visual regression assertions"
      contains: "toHaveScreenshot"
    - path: "e2e/tests/needs-tab-visual.spec.ts"
      provides: "Needs tab screenshots as visual regression assertions"
      contains: "toHaveScreenshot"
  key_links:
    - from: "e2e/playwright.config.ts"
      to: "e2e/tests/two-browser-stage-3.spec.ts"
      via: "Global toHaveScreenshot config inherited (set by Plan 01 or can be parallel)"
      pattern: "toHaveScreenshot"
---

<objective>
Convert all Stage 3-4 E2E test screenshots from documentation-only `page.screenshot()` to visual regression `toHaveScreenshot()` assertions.

Purpose: Stage 3-4 screenshots become automated regression tests that fail when UI changes unexpectedly, satisfying E2E-03 (visual regression baselines established).

Output: 4 Stage 3-4 test files converted with toHaveScreenshot() assertions.
</objective>

<execution_context>
@/Users/shantam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-visual-regression-baselines/12-RESEARCH.md
@e2e/tests/two-browser-stage-3.spec.ts
@e2e/tests/two-browser-stage-4.spec.ts
@e2e/tests/needs-confirmation-visual.spec.ts
@e2e/tests/needs-tab-visual.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert Stage 3 test screenshots to toHaveScreenshot assertions</name>
  <files>
    e2e/tests/two-browser-stage-3.spec.ts
    e2e/tests/needs-confirmation-visual.spec.ts
    e2e/tests/needs-tab-visual.spec.ts
  </files>
  <action>
    Convert every `page.screenshot({ path: 'test-results/...' })` call in the 3 Stage 3 test files to `expect(page).toHaveScreenshot('name.png')` assertions.

    **Conversion pattern:**
    ```typescript
    // BEFORE:
    await pageA.screenshot({ path: 'test-results/stage-3-01-initial-user-a.png' });

    // AFTER:
    await expect(pageA).toHaveScreenshot('stage-3-01-initial-user-a.png', {
      maxDiffPixels: 100,
    });
    ```

    **For each file:**

    1. **two-browser-stage-3.spec.ts** (8 screenshots):
       - Convert all `pageA.screenshot(...)` and `pageB.screenshot(...)` calls.
       - Extract screenshot name from path value (strip `test-results/` prefix).
       - 8 pairs documenting: initial state, needs review, confirmed, common ground, continue, final.

    2. **needs-confirmation-visual.spec.ts** (3 screenshots):
       - Convert all `pageA.screenshot(...)` calls.
       - These use multi-line format with `path:` on separate line — collapse to toHaveScreenshot.
       - Extract filenames from path values.

    3. **needs-tab-visual.spec.ts** (4 screenshots):
       - Convert all `pageA.screenshot(...)` calls.
       - Same multi-line pattern — collapse to toHaveScreenshot.

    **Important rules:**
    - Do NOT add `animations: 'disabled'` per-screenshot — it's in global config (Plan 01 adds it, or if running in parallel, the per-call maxDiffPixels is sufficient).
    - DO add `maxDiffPixels: 100` per-screenshot for explicitness.
    - Do NOT change any test logic, assertions, or wait patterns.
    - Remove unused imports (path, fs) if they become unused after conversion.
  </action>
  <verify>
    # Verify no old-style screenshots remain:
    grep -c "\.screenshot(" e2e/tests/two-browser-stage-3.spec.ts e2e/tests/needs-confirmation-visual.spec.ts e2e/tests/needs-tab-visual.spec.ts

    # Verify toHaveScreenshot is used:
    grep -c "toHaveScreenshot" e2e/tests/two-browser-stage-3.spec.ts e2e/tests/needs-confirmation-visual.spec.ts e2e/tests/needs-tab-visual.spec.ts
  </verify>
  <done>All 15 Stage 3 screenshots converted from page.screenshot() to expect().toHaveScreenshot(). Zero old-style screenshot calls remain in the 3 Stage 3 test files.</done>
</task>

<task type="auto">
  <name>Task 2: Convert Stage 4 test screenshots and document baseline update process</name>
  <files>
    e2e/tests/two-browser-stage-4.spec.ts
  </files>
  <action>
    **Part A: Convert Stage 4 screenshots**

    Convert every `page.screenshot({ path: 'test-results/...' })` call in the Stage 4 test file to `expect(page).toHaveScreenshot('name.png')` assertions.

    **two-browser-stage-4.spec.ts** (10 screenshots):
    - Convert all `pageA.screenshot(...)` and `pageB.screenshot(...)` calls.
    - 10 screenshots documenting: initial state, strategy pool, ranking, overlap reveal, agreement.
    - Same pattern: strip `test-results/` prefix, add `maxDiffPixels: 100`.

    **Part B: Add baseline update documentation as code comment**

    At the top of `e2e/tests/two-browser-stage-4.spec.ts` (inside the existing JSDoc comment block), add a section documenting the visual regression baseline update process. This serves as inline documentation for developers:

    ```
    * VISUAL REGRESSION BASELINES:
    * - Baselines auto-created in .spec.ts-snapshots/ on first run
    * - To update after intentional UI changes: npx playwright test [test-name] --update-snapshots
    * - Review diff images in test-results/ before committing updated baselines
    * - Commit baselines: git add e2e/tests/**/*-snapshots/*.png
    * - Never update baselines without understanding WHY pixels changed
    ```

    Also add this same comment block to `e2e/tests/two-browser-stage-3.spec.ts` for consistency.

    **Important rules:**
    - Same conversion pattern as Task 1.
    - Do NOT change test logic.
    - The documentation comment goes inside the EXISTING JSDoc at the top of the file, not as a separate block.
  </action>
  <verify>
    # Verify no old-style screenshots remain:
    grep -c "\.screenshot(" e2e/tests/two-browser-stage-4.spec.ts

    # Verify toHaveScreenshot is used:
    grep -c "toHaveScreenshot" e2e/tests/two-browser-stage-4.spec.ts

    # Verify baseline docs exist:
    grep "update-snapshots" e2e/tests/two-browser-stage-4.spec.ts e2e/tests/two-browser-stage-3.spec.ts

    # TypeScript check:
    npm run check
  </verify>
  <done>All 10 Stage 4 screenshots converted. Baseline update documentation added to Stage 3 and Stage 4 test files. TypeScript compiles without errors. npm run check passes.</done>
</task>

</tasks>

<verification>
1. `grep -r "\.screenshot(" e2e/tests/two-browser-stage-3.spec.ts e2e/tests/two-browser-stage-4.spec.ts e2e/tests/needs-confirmation-visual.spec.ts e2e/tests/needs-tab-visual.spec.ts` returns no matches
2. `grep -c "toHaveScreenshot" e2e/tests/two-browser-stage-3.spec.ts` returns >= 8
3. `grep -c "toHaveScreenshot" e2e/tests/two-browser-stage-4.spec.ts` returns >= 10
4. `grep "update-snapshots" e2e/tests/two-browser-stage-3.spec.ts e2e/tests/two-browser-stage-4.spec.ts` returns matches (baseline docs)
5. `npm run check` passes
</verification>

<success_criteria>
- All 25 Stage 3-4 screenshots use toHaveScreenshot() assertions
- No old-style page.screenshot() calls remain in any of the 4 files
- Baseline update documentation exists in Stage 3 and Stage 4 test files
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-visual-regression-baselines/12-02-SUMMARY.md`
</output>
