---
phase: 04-stage-2-test-coverage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - e2e/helpers/test-utils.ts
  - e2e/tests/two-browser-stage-2.spec.ts
autonomous: true

must_haves:
  truths:
    - "Test verifies both users draft empathy, share it, and reconciler completes without gaps"
    - "Test verifies both users see empathy revealed (status REVEALED) after reconciler"
    - "Test verifies both users validate partner empathy on Share tab"
    - "Test verifies both users enter Stage 3 (chat input remains visible after validation)"
    - "Test documents actual behavior with comments on known issues from audit"
  artifacts:
    - path: "e2e/helpers/test-utils.ts"
      provides: "waitForReconcilerComplete and navigateBackToChat helper functions"
      contains: "waitForReconcilerComplete"
    - path: "e2e/tests/two-browser-stage-2.spec.ts"
      provides: "Two-browser Stage 2 E2E test covering empathy sharing, reconciler, validation, and Stage 3 entry"
      contains: "two-browser-stage-2"
  key_links:
    - from: "e2e/tests/two-browser-stage-2.spec.ts"
      to: "e2e/helpers/test-utils.ts"
      via: "imports waitForReconcilerComplete, navigateToShareFromSession, sendAndWaitForPanel"
      pattern: "import.*waitForReconcilerComplete"
    - from: "e2e/tests/two-browser-stage-2.spec.ts"
      to: "e2e/helpers/two-browser-harness.ts"
      via: "imports TwoBrowserHarness for two-browser orchestration"
      pattern: "import.*TwoBrowserHarness"
    - from: "reconciler-no-gaps fixture"
      to: "backend reconciler"
      via: "fixture operations provide mock reconciler-analysis with no gaps"
      pattern: "reconciler-no-gaps"
---

<objective>
Create two-browser E2E test covering Stage 2 empathy sharing, reconciler analysis (no-gaps path), mutual reveal, partner validation, and Stage 3 entry for both users.

Purpose: Prove both users can complete the full Stage 2 flow together using real Ably events and fixture-based AI, verifying the most complex stage in the process works end-to-end. Documents actual behavior including known issues from audit.

Output: `e2e/tests/two-browser-stage-2.spec.ts` test file + helper utilities in `e2e/helpers/test-utils.ts`
</objective>

<execution_context>
@/Users/shantam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-stage-2-test-coverage/04-RESEARCH.md
@.planning/phases/03-stage-0-1-test-coverage/03-01-SUMMARY.md

# Key source files to reference
@e2e/tests/two-browser-stage-1.spec.ts
@e2e/helpers/test-utils.ts
@e2e/helpers/two-browser-harness.ts
@e2e/playwright.two-browser.config.ts
@backend/src/fixtures/user-a-full-journey.ts
@backend/src/fixtures/reconciler-no-gaps.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Stage 2 helper utilities to test-utils.ts</name>
  <files>e2e/helpers/test-utils.ts</files>
  <action>
Add two new exported helper functions to `e2e/helpers/test-utils.ts`:

1. **`waitForReconcilerComplete(page, timeout = 30000): Promise<boolean>`**
   - Polls for reconciler completion by checking for `chat-indicator-empathy-shared` testID visibility
   - Returns `true` if indicator becomes visible within timeout, `false` if timeout
   - Polls every 1 second using `page.waitForTimeout(1000)` between checks
   - Uses `page.getByTestId('chat-indicator-empathy-shared').isVisible({ timeout: 1000 }).catch(() => false)` for each check

2. **`navigateBackToChat(page, timeout = 10000): Promise<void>`**
   - If page URL does not include `/share`, return immediately (already on chat)
   - Try clicking `page.getByTestId('share-header-back-button')` if visible within 5s
   - Fallback: call `page.goBack()`
   - Wait for URL to match `/session/[^/]+$` pattern
   - Wait for `networkidle` load state

Add JSDoc comments with `@param` tags matching the style of existing functions in the file.

Import `Page` from `@playwright/test` if not already imported (it is already imported).
  </action>
  <verify>
Run TypeScript check: `cd /Users/shantam/Software/meet-without-fear/e2e && npx tsc --noEmit --project tsconfig.json 2>&1 | head -20`

If no tsconfig.json exists in e2e/, verify by checking that the file has no syntax errors: `node -e "require('./e2e/helpers/test-utils.ts')" 2>&1 || echo "Check with ts-node instead"` — alternatively just verify the file compiles with the test run in Task 2.
  </verify>
  <done>
`waitForReconcilerComplete` and `navigateBackToChat` functions exist in `e2e/helpers/test-utils.ts` with correct signatures and JSDoc comments.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create two-browser Stage 2 E2E test</name>
  <files>e2e/tests/two-browser-stage-2.spec.ts</files>
  <action>
Create `e2e/tests/two-browser-stage-2.spec.ts` following the exact pattern of `two-browser-stage-1.spec.ts`.

**Fixture selection (CRITICAL):**
- User A: `user-a-full-journey` (has Stage 0-2 messages, Response 5 has `ReadyShare: Y`)
- User B: `reconciler-no-gaps` (has Stage 1-2 messages + `reconciler-analysis` operation with no gaps)
- WHY: The reconciler runs in the request context of the SECOND user to share empathy. If User A shares first and User B shares second, User B's fixture provides the `reconciler-analysis` operation response. Using `reconciler-no-gaps` for User B ensures the reconciler finds no gaps, both attempts go to READY, then REVEALED.
- User A has NO reconciler operations, so User A MUST share first.

**Test structure:**

```
test.describe('Stage 2: Empathy Sharing and Reconciler', () => {
  // Setup: TwoBrowserHarness with userA=user-a-full-journey, userB=reconciler-no-gaps
  // Use different emails from Stage 1 test (e.g., stage2-a@e2e.test, stage2-b@e2e.test)

  test('both users share empathy, reconciler finds no gaps, both validate and enter Stage 3', async ({ browser, request }) => {
    test.setTimeout(600000); // 10 minutes

    // === STAGE 0 PREREQUISITE (copy pattern from Stage 1 test) ===
    // Setup User B, accept invitation
    // Both navigate, sign compact, handle mood check
    // Verify chat input visible

    // === STAGE 1: USER A WITNESSING ===
    // Send userA messages (same as Stage 1 test: 4 messages)
    // Dismiss invitation panel after response 1
    // Confirm feel-heard

    // === STAGE 1: USER B WITNESSING ===
    // User B uses reconciler-no-gaps fixture (different messages from user-b-partner-journey)
    // Messages: "Things have been tense lately", "I feel like we've just been miscommunicating",
    //           "I want them to know I still care, even when I'm stressed", "Exactly. I just want us to be on the same page again"
    // (4 messages, Response 3 has FeelHeardCheck: Y)
    // Confirm feel-heard

    // === STAGE 2: USER A EMPATHY DRAFT ===
    // User A sends Stage 2 messages. After feel-heard confirmation, next message is Response 4 (post-feel-heard).
    // Then Response 5 has ReadyShare: Y with empathy draft.
    // Message for Response 4: "Yes, I feel heard now"
    // Message for Response 5: "I guess they might be stressed from work too"
    // Use sendAndWaitForPanel with panelTestId='empathy-review-button'
    // After panel appears, click empathy-review-button
    // Then click share-empathy-button (consent to share)

    // === STAGE 2: USER B EMPATHY DRAFT ===
    // User B (reconciler-no-gaps) sends Stage 2 messages.
    // Response 4: "Yes, I feel understood" (post-feel-heard)
    // Response 5: "I think they might be feeling frustrated too" (empathy building)
    // Response 6: "Maybe they feel like I pull away when stressed and they want to connect" (ReadyShare: Y)
    // Use sendAndWaitForPanel with panelTestId='empathy-review-button'
    // After panel appears, click empathy-review-button
    // Then click share-empathy-button (consent to share)
    // NOTE: User B sharing second triggers the reconciler (using reconciler-no-gaps fixture operations)

    // === WAIT FOR RECONCILER ===
    // Wait 2s for reconciler trigger, then poll with waitForReconcilerComplete(userAPage, 60000)
    // If reconciler doesn't complete, take diagnostic screenshots and fail with descriptive message
    // Also check User B sees empathy-shared indicator

    // === NAVIGATE TO SHARE TAB FOR VALIDATION ===
    // navigateToShareFromSession(userAPage) and navigateToShareFromSession(userBPage)
    // Look for validation buttons on the partner empathy card
    // The testID pattern is `partner-empathy-card-validate-accurate` (from SharingStatusScreen)
    // If visible, click it. If not visible within 10s, document as known issue and take screenshot.

    // === VERIFY STAGE 3 ENTRY ===
    // Navigate back to chat: navigateBackToChat(userAPage) and navigateBackToChat(userBPage)
    // Verify chat input visible for both users (Stage 3 continues conversation)
    // Take final screenshots

    // === DOCUMENT KNOWN ISSUES IN COMMENTS ===
    // Comment: Empathy panel visibility depends on stage cache (Pitfall 3 from research)
    // Comment: Validation modal depends on Ably event (Pitfall 5 - don't assert on modal)
    // Comment: Reconciler timing is variable (5-30s), polling handles this
  });
});
```

**Important implementation details:**

1. **User B messages must match `reconciler-no-gaps` fixture exactly:**
   - Stage 1: "Things have been tense lately", "I feel like we've just been miscommunicating", "I want them to know I still care, even when I'm stressed", "Exactly. I just want us to be on the same page again"
   - Stage 2: "Yes, I feel understood", "I think they might be feeling frustrated too", "Maybe they feel like I pull away when stressed and they want to connect"

2. **User A messages must match `user-a-full-journey` fixture exactly:**
   - Stage 1: "Hi, I'm having a conflict with my partner", "We keep arguing about household chores", "Thanks, I sent the invitation", "I feel like I do most of the work and they don't notice or appreciate it"
   - Stage 2: "Yes, I feel heard now", "I guess they might be stressed from work too"

3. **User A MUST share empathy first** (has no reconciler operations). User B shares second (triggers reconciler with no-gaps fixture).

4. **Empathy panel detection**: After each Stage 2 message, check for `empathy-review-button` testID. The panel appears when AI response includes `ReadyShare: Y` metadata.

5. **Consent flow**: Click `empathy-review-button` to open review, then click `share-empathy-button` to consent to share. Wait 1-2s for Ably event delivery between users sharing.

6. **Validation testID**: On the SharingStatusScreen, partner empathy card uses testID `partner-empathy-card`. Validation button testID is `partner-empathy-card-validate-accurate`. Use conditional click (`.isVisible().catch(() => false)`) since validation UI may not appear if Ably events are delayed.

7. **Resilient assertions**: Use `.catch(() => false)` pattern for visibility checks on timing-sensitive elements. Take screenshots at key points for debugging.

8. **Test uses `devices['iPhone 12']`** and `test.use(devices['iPhone 12'])` consistent with Stage 1 test.

9. **Handle mood check**: Call `handleMoodCheck()` after any page navigation or reload (mood check can reappear).

10. **Screenshot at each stage transition**: Save to `test-results/stage2-*.png` for debugging.
  </action>
  <verify>
Run the Stage 2 test:
```bash
cd /Users/shantam/Software/meet-without-fear/e2e && npx playwright test --config=playwright.two-browser.config.ts two-browser-stage-2 --timeout 600000
```

Expected: Test passes (may take 6-10 minutes due to circuit breaker timeouts and reconciler processing).

If test fails, examine the failure reason:
- Timeout on empathy panel → Check fixture message sequences match exactly
- Reconciler timeout → Check if reconciler-no-gaps operations are being loaded (look for "[Bedrock] MOCK_LLM enabled" in server logs)
- Validation button not found → Document as known issue (Ably event timing)
- Stage 3 chat-input not visible → Document as known issue (stage transition cache)
  </verify>
  <done>
`two-browser-stage-2.spec.ts` exists and passes, proving:
1. Both users complete Stage 0+1 prerequisite
2. Both users draft and share empathy (User A first, User B second)
3. Reconciler runs with no-gaps result (via reconciler-no-gaps fixture)
4. Both users see empathy revealed
5. Both users validate partner empathy (or behavior documented if validation UI absent)
6. Both users enter Stage 3 (chat input visible)
  </done>
</task>

</tasks>

<verification>
Run the full two-browser test suite to ensure no regressions:
```bash
cd /Users/shantam/Software/meet-without-fear/e2e && npx playwright test --config=playwright.two-browser.config.ts --timeout 600000
```

All 4 two-browser tests should pass:
- two-browser-smoke.spec.ts
- two-browser-stage-0.spec.ts
- two-browser-stage-1.spec.ts
- two-browser-stage-2.spec.ts (NEW)
</verification>

<success_criteria>
1. `two-browser-stage-2.spec.ts` passes with both users completing Stage 2 and entering Stage 3
2. Test uses `reconciler-no-gaps` fixture for User B to ensure deterministic no-gaps reconciler path
3. Test documents actual behavior with comments on known issues from Stage 2 audit
4. Helper functions `waitForReconcilerComplete` and `navigateBackToChat` work correctly
5. No regressions in existing two-browser tests (smoke, stage-0, stage-1)
</success_criteria>

<output>
After completion, create `.planning/phases/04-stage-2-test-coverage/04-01-SUMMARY.md`
</output>
