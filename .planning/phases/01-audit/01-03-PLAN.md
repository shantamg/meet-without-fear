---
phase: 01-audit
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/01-audit/01-03-AUDIT-STAGE-2.md
autonomous: true

must_haves:
  truths:
    - "Every two-user interaction path in Stage 2 (Perspective Stretch/Empathy) is documented with expected behavior for both users"
    - "The empathy exchange flow (draft -> consent -> share -> reconciler -> reveal) is fully traced for both users"
    - "Stage 2 transition triggers map to documented outcomes for both users"
    - "Known gaps or issues in Stage 2 are flagged with severity"
  artifacts:
    - path: ".planning/phases/01-audit/01-03-AUDIT-STAGE-2.md"
      provides: "Complete audit of Stage 2 two-user interaction paths and transitions"
  key_links: []
---

<objective>
Audit every two-user interaction path in Stage 2 (Perspective Stretch / Empathy), documenting the empathy exchange flow, consent, sharing, validation, refinement, and share suggestion paths for both users.

Purpose: Stage 2 is the most complex stage with the most two-user interactions. It involves empathy drafting, consent to share, the reconciler (documented separately in Plan 02), and empathy validation/refinement. This audit traces each interaction path to understand what each user experiences.

Output: `.planning/phases/01-audit/01-03-AUDIT-STAGE-2.md`
</objective>

<execution_context>
@/Users/shantam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/ARCHITECTURE.md

Key source files to trace:

Stage 2 - Backend:
@backend/src/routes/stage2.ts
@backend/src/controllers/stage2.ts
@backend/src/services/empathy-status.ts
@backend/src/services/realtime.ts
@backend/src/routes/consent.ts
@backend/src/controllers/consent.ts

Stage 2 - Mobile:
@mobile/src/hooks/useStages.ts
@mobile/src/hooks/useRealtime.ts
@mobile/src/hooks/useChatUIState.ts
@mobile/src/utils/chatUIState.ts
@mobile/src/hooks/queryKeys.ts
@mobile/src/screens/PerspectiveStretchScreen.tsx
@mobile/src/components/EmpathyAttemptCard.tsx
@mobile/src/components/ShareSuggestionCard.tsx

Shared types:
@shared/src/dto/empathy.ts
@shared/src/dto/session-state.ts
@shared/src/enums.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Trace and document Stage 2 empathy exchange interaction paths</name>
  <files>.planning/phases/01-audit/01-03-AUDIT-STAGE-2.md</files>
  <action>
Read the source files listed in context to trace every two-user interaction path in Stage 2. Document each path in structured format.

**Stage 2 Interaction Paths to Trace:**

1. **Empathy Draft Save** (Each user independently)
   - Trace: `POST /sessions/:id/empathy/draft` in `controllers/stage2.ts` -> `saveDraft`
   - Document: What DB writes happen, does this trigger any Ably events, what mobile cache updates occur

2. **Consent to Share Empathy** (Each user independently)
   - Trace: `POST /sessions/:id/empathy/consent` in `controllers/stage2.ts` -> `consentToShare`
   - Document: What DB writes happen, what triggers the reconciler (this is the key entry point), what Ably events fire
   - This is the critical two-user interaction: when does the reconciler run? When first user consents? When second user consents? Both?

3. **Get Partner Empathy** (Each user)
   - Trace: `GET /sessions/:id/empathy/partner` in `controllers/stage2.ts` -> `getPartnerEmpathy`
   - Document: What conditions must be true for partner empathy to be visible, what cache key is used

4. **Validate Partner's Empathy** (Each user)
   - Trace: `POST /sessions/:id/empathy/validate` in `controllers/stage2.ts` -> `validateEmpathy`
   - Document: What validation options exist (ACCURATE, NEEDS_WORK, etc.), what happens for each, what Ably events fire

5. **Empathy Refinement** (When validation result is NEEDS_WORK)
   - Trace: `POST /sessions/:id/empathy/refine` and `POST /sessions/:id/empathy/resubmit` in `controllers/stage2.ts`
   - Document: The refinement conversation flow, when does resubmission trigger re-validation

6. **Get Share Suggestion** (Asymmetric reconciler - when partner has gaps)
   - Trace: `GET /sessions/:id/empathy/share-suggestion` in `controllers/stage2.ts`
   - Document: When are share suggestions created, what data they contain, what the user sees

7. **Respond to Share Suggestion** (Accept, decline, or refine)
   - Trace: `POST /sessions/:id/empathy/share-suggestion/respond` in `controllers/stage2.ts`
   - Document: Each response type and its outcome, what Ably events fire, what partner sees

8. **Empathy Exchange Status** (Polling/query endpoint)
   - Trace: `GET /sessions/:id/empathy/status` in `controllers/stage2.ts`
   - Document: What this returns, how mobile uses it, what cache key stores it

For each interaction path, document:
- **Trigger**: User action that starts it
- **Backend**: API endpoint -> controller -> service -> DB writes
- **Ably Events**: Event name, payload, channel, who receives it
- **Acting User (mobile)**: Cache key updates (from `onMutate` in `useStages.ts`), UI state changes
- **Partner (mobile)**: How they receive notification, what cache keys get invalidated/updated, what UI changes
- **Issues Found**: Any gaps, race conditions, or missing updates
  </action>
  <verify>The audit document exists and contains documented paths for all 8 Stage 2 interaction types, each with trigger/backend/ably/mobile sections for both users.</verify>
  <done>Every two-user interaction path in Stage 2 is documented with specific code references, DB changes, Ably events, cache updates, and UI state changes for both users.</done>
</task>

<task type="auto">
  <name>Task 2: Document Stage 2 panel visibility logic and consent flow</name>
  <files>.planning/phases/01-audit/01-03-AUDIT-STAGE-2.md</files>
  <action>
Append to the Stage 2 audit document sections covering UI panel visibility and consent.

**Sections to add:**

1. **Panel Visibility Logic for Stage 2**
   - Read `mobile/src/utils/chatUIState.ts` and focus on `computeShowEmpathyPanel()` and related Stage 2 functions
   - Document: What conditions determine which panel is shown (empathy draft panel, sharing panel, waiting panel, validation panel, etc.)
   - Trace the "Stable Mounting Pattern" documented in MEMORY.md: mounted based on data, animated based on data + typewriter guard
   - Document: What cache values must be set for each panel to appear/disappear

2. **Consent Flow** (Stage 2 specific)
   - Read `backend/src/routes/consent.ts` and `backend/src/controllers/consent.ts`
   - Document: How consent requests are created, how partners grant/deny consent, what happens on each outcome
   - Trace the consent grant/deny -> Ably event -> partner notification -> cache update chain

3. **Waiting States in Stage 2**
   - Document: What happens when User A has consented to share but User B hasn't
   - Document: What happens when User A has shared empathy but User B hasn't
   - How does the UI communicate waiting state for each asymmetric situation

4. **Stage 2 -> Stage 3 Entry Conditions**
   - Document: What must be true for a user to advance from Stage 2 to Stage 3
   - Is the advance automatic after reconciliation completes, or does the user trigger it?
   - What are the gate conditions checked?

5. **Issues Summary**
   - Consolidate all issues from Stage 2 audit into a prioritized list
   - Cross-reference with known issues from `.planning/codebase/CONCERNS.md`
  </action>
  <verify>The audit document contains panel visibility logic, consent flow, waiting states, Stage 2->3 entry conditions, and consolidated issues summary.</verify>
  <done>Stage 2 audit is complete: all interaction paths traced, panel visibility logic documented, consent flow mapped, waiting states documented, Stage 2->3 entry conditions identified, and issues prioritized.</done>
</task>

</tasks>

<verification>
1. `.planning/phases/01-audit/01-03-AUDIT-STAGE-2.md` exists and is comprehensive
2. All 8+ interaction paths documented with both users' perspectives
3. Panel visibility logic for Stage 2 documented with cache value requirements
4. Consent flow fully traced
5. Waiting states documented for asymmetric scenarios
6. Stage 2 -> Stage 3 entry conditions identified
7. Issues flagged with severity ratings
</verification>

<success_criteria>
- Document covers 8+ distinct interaction paths in Stage 2
- Each path traces: trigger -> backend -> Ably events -> mobile cache -> UI state
- Both users' perspectives documented for each two-user interaction
- Panel visibility logic mapped to cache values
- Consent flow fully traced from request to grant/deny
- Stage 2 -> Stage 3 entry conditions documented
- Consolidated issues list with severity ratings
</success_criteria>

<output>
After completion, create `.planning/phases/01-audit/01-03-SUMMARY.md`
</output>
