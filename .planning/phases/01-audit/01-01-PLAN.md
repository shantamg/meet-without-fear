---
phase: 01-audit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/01-audit/01-01-AUDIT-STAGE-0-1.md
autonomous: true

must_haves:
  truths:
    - "Every two-user interaction path in Stage 0 (Onboarding) is documented with expected behavior for both User A (inviter) and User B (invitee)"
    - "Every two-user interaction path in Stage 1 (Witnessing) is documented with expected behavior for both users"
    - "Every stage transition trigger in Stages 0-1 maps to documented outcomes (cache, DB, Ably events, UI) for both users"
    - "Known gaps or issues in Stages 0-1 are flagged with severity and description"
  artifacts:
    - path: ".planning/phases/01-audit/01-01-AUDIT-STAGE-0-1.md"
      provides: "Complete audit of Stage 0-1 two-user interaction paths and transitions"
  key_links: []
---

<objective>
Audit every two-user interaction path and stage transition in Stage 0 (Onboarding) and Stage 1 (Witnessing), documenting expected behavior for both users at each step.

Purpose: Produce a complete picture of how two users interact in Stages 0-1, including what happens in the database, cache, Ably events, and UI for both the acting user and their partner. This is observation-only -- no code changes.

Output: `.planning/phases/01-audit/01-01-AUDIT-STAGE-0-1.md`
</objective>

<execution_context>
@/Users/shantam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONCERNS.md

Key source files to trace:

Stage 0 (Onboarding) - Backend:
@backend/src/routes/invitations.ts
@backend/src/routes/stage0.ts
@backend/src/routes/sessions.ts
@backend/src/controllers/invitations.ts
@backend/src/controllers/sessions.ts
@backend/src/controllers/stage0.ts
@backend/src/services/sessions.ts
@backend/src/services/realtime.ts

Stage 1 (Witnessing) - Backend:
@backend/src/routes/messages.ts
@backend/src/controllers/messages.ts
@backend/src/services/messages.ts
@backend/src/services/witnessing.ts
@backend/src/services/ai-orchestrator.ts

Mobile (both stages):
@mobile/src/hooks/queryKeys.ts
@mobile/src/hooks/useSessions.ts
@mobile/src/hooks/useStages.ts
@mobile/src/hooks/useMessages.ts
@mobile/src/hooks/useRealtime.ts
@mobile/src/hooks/useStreamingMessage.ts
@mobile/src/hooks/useChatUIState.ts
@mobile/src/utils/chatUIState.ts

Shared types:
@shared/src/dto/session-state.ts
@shared/src/dto/session.ts
@shared/src/dto/stage.ts
@shared/src/dto/realtime.ts
@shared/src/enums.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Trace and document Stage 0 (Onboarding) two-user interaction paths</name>
  <files>.planning/phases/01-audit/01-01-AUDIT-STAGE-0-1.md</files>
  <action>
Read the source files listed in context to trace every two-user interaction path in Stage 0 (Onboarding). Document each path in a structured format with these sections:

**Stage 0 Interaction Paths to Trace:**

1. **Session Creation + Invitation Send** (User A only)
   - Trace: `POST /sessions` in `controllers/invitations.ts` -> `services/sessions.ts` -> DB writes -> Ably events
   - Document: What DB records are created (Session, Invitation, SessionProgress for both users), what Ably events fire, what cache updates happen in mobile

2. **Invitation Message Composition** (User A only)
   - Trace: `PUT /sessions/:id/invitation/message` and `POST /sessions/:id/invitation/confirm` in `controllers/sessions.ts`
   - Document: What happens when User A drafts and confirms invitation message, what Ably events fire, what cache keys update

3. **Invitation Acceptance** (User B)
   - Trace: `POST /invitations/:id/accept` in `controllers/invitations.ts`
   - Document: What DB changes happen, what Ably events fire to notify User A, what both users see after acceptance

4. **Compact Signing** (Both users independently)
   - Trace: `POST /sessions/:id/compact/sign` in `controllers/stage0.ts`
   - Document: What happens when User A signs, what Ably event (`partner.signed_compact`) fires, what User B sees, what happens when both have signed

5. **Stage 0 -> Stage 1 Transition** (Triggered by second compact signer)
   - Trace: What triggers the advance from Stage 0 to Stage 1 for both users
   - Document: Which code path triggers the advance, what DB/cache/Ably/UI changes happen for each user

For each interaction path, document:
- **Trigger**: User action that starts it
- **Backend**: API endpoint -> controller -> service -> DB writes (specific tables and fields)
- **Ably Events**: Event name, payload, channel, who receives it
- **Acting User (mobile)**: Cache key updates (from `onMutate`), UI state changes
- **Partner (mobile)**: How they receive notification (Ably handler in `useRealtime.ts`), what cache keys get invalidated/updated, what UI changes
- **Issues Found**: Any gaps, race conditions, or missing updates observed in the code

Write the beginning of the audit document with a header, Stage 0 section, and all Stage 0 paths documented.
  </action>
  <verify>The audit document exists at `.planning/phases/01-audit/01-01-AUDIT-STAGE-0-1.md` and contains documented paths for all 5 Stage 0 interaction types listed above, each with trigger/backend/ably/mobile sections for both users.</verify>
  <done>Every two-user interaction path in Stage 0 is documented with specific file:function references, DB table changes, Ably event names, cache key updates, and UI state changes for both User A and User B. Issues are flagged.</done>
</task>

<task type="auto">
  <name>Task 2: Trace and document Stage 1 (Witnessing) two-user interaction paths and transitions</name>
  <files>.planning/phases/01-audit/01-01-AUDIT-STAGE-0-1.md</files>
  <action>
Continue the audit document by tracing every two-user interaction path in Stage 1 (Witnessing). Append a Stage 1 section.

**Stage 1 Interaction Paths to Trace:**

1. **Message Send + AI Response** (Each user independently)
   - Trace: `POST /sessions/:id/messages/stream` in `controllers/messages.ts` -> `services/messages.ts` -> `ai-orchestrator.ts` -> SSE streaming -> Ably `message.ai_response` event
   - Document: How user's message is saved, how AI response streams back via SSE, what cache updates happen (optimistic add in `useMessages.ts`), what Ably events the partner receives

2. **Feel-Heard Confirmation** (Each user independently)
   - Trace: `POST /sessions/:id/feel-heard` in `controllers/messages.ts` -> what DB changes happen
   - Document: How the feel-heard confirmation is recorded, what milestone timestamp is set, what Ably events fire
   - Mobile: Trace `useConfirmFeelHeard` in `useStages.ts` -- what cache keys are updated in `onMutate`, what the partner sees

3. **Stage 1 -> Stage 2 Transition** (Triggered when both users confirm feel-heard)
   - Trace: What code checks whether both users have confirmed feel-heard, what triggers the advance
   - Document: Is the advance triggered by the second user's `confirmFeelHeard` call? Or by a separate `advanceStage` call?
   - Document: What DB/cache/Ably/UI changes happen for each user when advancing to Stage 2

4. **Waiting State** (When one user confirms feel-heard but partner hasn't yet)
   - Trace: How `getWaitingStatus.ts` and `waitingStatusConfig.ts` compute waiting state
   - Document: What the user who confirmed sees, what the partner who hasn't confirmed yet sees, how the UI communicates the waiting state

Use the same structured format as Stage 0 (trigger, backend, ably, acting user mobile, partner mobile, issues).

Also add a **Summary of Issues** section at the end of the document collecting all flagged issues across both stages with severity ratings (critical/medium/low) and brief descriptions.
  </action>
  <verify>The audit document contains documented paths for all 4 Stage 1 interaction types, plus a Summary of Issues section. Each path has trigger/backend/ably/mobile sections for both users.</verify>
  <done>Every two-user interaction path in Stage 1 is documented. Stage transition from 0->1 and 1->2 are fully traced. Waiting states documented. All issues flagged with severity. Complete audit of Stages 0-1 in a single document.</done>
</task>

</tasks>

<verification>
1. `.planning/phases/01-audit/01-01-AUDIT-STAGE-0-1.md` exists and is comprehensive
2. All Stage 0 interaction paths documented (session creation, invitation, acceptance, compact signing, transition)
3. All Stage 1 interaction paths documented (messaging, feel-heard, transition, waiting)
4. Each path documents both users' perspectives (acting user + partner)
5. Each path includes specific code references (file:function, not just "backend")
6. Issues flagged with severity ratings
</verification>

<success_criteria>
- Document covers 9+ distinct interaction paths across Stages 0-1
- Each path traces: trigger -> backend (endpoint, controller, service, DB) -> Ably events -> mobile cache updates -> UI state changes
- Both User A and User B perspectives are documented for each two-user interaction
- Stage transitions (0->1 and 1->2) are fully traced with trigger conditions
- All discovered issues are collected in a summary section with severity ratings
</success_criteria>

<output>
After completion, create `.planning/phases/01-audit/01-01-SUMMARY.md`
</output>
