---
phase: 01-audit
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/01-audit/01-02-AUDIT-RECONCILER.md
autonomous: true

must_haves:
  truths:
    - "Reconciler state machine shows all valid state transitions with trigger conditions and expected outcomes"
    - "Every reconciler DB table and its role in the state machine is documented"
    - "Race condition workarounds and retry logic are identified and documented"
    - "Known gaps or issues in reconciler logic are flagged with severity"
  artifacts:
    - path: ".planning/phases/01-audit/01-02-AUDIT-RECONCILER.md"
      provides: "Complete audit of reconciler state machine with transitions, DB schema, and issues"
  key_links: []
---

<objective>
Audit the reconciler state machine, documenting all valid state transitions, database tables involved, race condition workarounds, and expected outcomes for both users.

Purpose: The reconciler manages the complex empathy exchange flow (HELD -> AWAITING_SHARING -> REFINING -> REVEALED) across multiple DB tables. This audit maps the complete state machine to identify fragile areas before fixing them.

Output: `.planning/phases/01-audit/01-02-AUDIT-RECONCILER.md`
</objective>

<execution_context>
@/Users/shantam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONCERNS.md

Key source files to trace:

Reconciler core:
@backend/src/services/reconciler.ts
@backend/src/services/empathy-status.ts
@backend/src/controllers/stage2.ts
@backend/src/routes/stage2.ts
@backend/src/routes/reconciler.ts

Realtime events:
@backend/src/services/realtime.ts

Database schema:
@backend/prisma/schema.prisma

Shared types:
@shared/src/dto/empathy.ts
@shared/src/enums.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Map reconciler state machine and DB schema</name>
  <files>.planning/phases/01-audit/01-02-AUDIT-RECONCILER.md</files>
  <action>
Read `backend/src/services/reconciler.ts` (2187 lines), `backend/src/services/empathy-status.ts` (260 lines), `backend/src/controllers/stage2.ts` (2261 lines), and the relevant Prisma schema models to produce a comprehensive reconciler state machine document.

**Document these sections:**

1. **DB Tables Involved**
   - Read `backend/prisma/schema.prisma` for models: `ReconcilerResult`, `ReconcilerShareOffer`, `EmpathyStatus`, `EmpathyStatement`, `SessionProgress`
   - For each table: list fields, relationships, status enums, and role in the reconciler flow
   - Document which fields track state transitions

2. **State Machine Diagram (Text-Based)**
   - Map every valid state value for `ReconcilerResult.status` and `EmpathyStatus`
   - Document every transition: FROM state -> TO state, with:
     - Trigger (which API endpoint / function call causes it)
     - Guard conditions (what must be true for the transition to happen)
     - Side effects (DB writes, Ably events, partner notifications)
   - Include the states: HELD, AWAITING_SHARING, REFINING, REVEALED and any others found in code
   - Document invalid transitions (what the code prevents)

3. **Reconciler Entry Points**
   - Trace every code path that triggers the reconciler to run
   - Document: When does reconciliation start? What triggers it? Is it automatic or user-initiated?
   - Trace `consentToShare` in `controllers/stage2.ts` as the primary trigger

4. **Share Suggestion Flow**
   - Trace `getShareSuggestion` and `respondToShareSuggestion` in `controllers/stage2.ts`
   - Document: When does the reconciler generate share suggestions? How does the user respond?
   - Map the share offer states and transitions

5. **Race Condition Workarounds**
   - Find all retry logic, delays, and workarounds in `reconciler.ts`
   - Document each workaround: what race condition it addresses, how it works, risk of failure
   - Specifically look for the 100ms delay retry logic documented in CONCERNS.md

6. **Issues Found**
   - Flag every fragile area, missing guard, or potential failure mode
   - Rate severity: critical (blocks user flow), medium (degraded experience), low (edge case)
  </action>
  <verify>The audit document exists and contains: DB table documentation, state machine diagram with all transitions, entry points, share suggestion flow, race condition workarounds, and issues section.</verify>
  <done>Complete reconciler state machine is mapped with every valid transition, every DB table's role documented, race condition workarounds identified, and issues flagged with severity ratings. A different Claude instance could understand the full reconciler flow from this document alone.</done>
</task>

<task type="auto">
  <name>Task 2: Document reconciler outcomes for both users</name>
  <files>.planning/phases/01-audit/01-02-AUDIT-RECONCILER.md</files>
  <action>
Append to the reconciler audit document a section documenting what both users experience during reconciliation.

**Sections to add:**

1. **Reconciler Flow from User A's Perspective**
   - What User A sees/does at each stage of reconciliation
   - Trace the mobile hooks that handle reconciler state: look in `useStages.ts` for empathy-related mutations, `useChatUIState.ts` for panel visibility
   - Document: Which panels appear, what actions are available, what Ably events affect their view

2. **Reconciler Flow from User B's Perspective**
   - Same as above but for User B (who may be in a different reconciler state)
   - Document asymmetric scenarios: User A has shared but User B hasn't yet

3. **Post-Reconciliation: Transition to Stage 3**
   - Trace what happens after reconciliation completes (both empathies revealed)
   - Document: What triggers the Stage 2 -> Stage 3 advance? Is it automatic or manual?
   - What DB/cache/Ably/UI changes happen for each user?

4. **Ably Events in Reconciler Flow**
   - List every Ably event the reconciler publishes (from realtime.ts and the event type list)
   - For each event: when it fires, who receives it, what mobile handler processes it, what cache updates happen

5. **Updated Issues Summary**
   - Consolidate all issues from both tasks into a single prioritized list
  </action>
  <verify>The audit document contains user perspective sections, post-reconciliation transition documentation, Ably event list for reconciler, and consolidated issues summary.</verify>
  <done>Reconciler audit is complete: state machine mapped, both users' perspectives documented, Stage 2->3 transition traced, all Ably events listed, and issues prioritized. Document is self-contained and comprehensive.</done>
</task>

</tasks>

<verification>
1. `.planning/phases/01-audit/01-02-AUDIT-RECONCILER.md` exists and is comprehensive
2. State machine covers all valid transitions with trigger conditions
3. DB tables documented with fields and relationships
4. Race condition workarounds identified with risk assessment
5. Both users' perspectives documented for reconciler flow
6. Post-reconciliation transition to Stage 3 traced
7. All Ably events in reconciler flow listed
8. Issues flagged with severity ratings
</verification>

<success_criteria>
- Complete state machine diagram showing all valid transitions between reconciler states
- Every DB table in the reconciler flow documented (ReconcilerResult, ReconcilerShareOffer, EmpathyStatus, etc.)
- Every race condition workaround identified with risk assessment
- Both User A and User B perspectives documented for the reconciler flow
- Stage 2 -> Stage 3 transition fully traced
- Consolidated issues list with severity ratings
</success_criteria>

<output>
After completion, create `.planning/phases/01-audit/01-02-SUMMARY.md`
</output>
