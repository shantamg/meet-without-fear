---
phase: 13-full-session-e2e-verification
plan: 04
type: execute
wave: 2
depends_on: ["13-03"]
files_modified:
  - e2e/tests/two-browser-reconciler-offer-optional.spec.ts
  - e2e/tests/two-browser-reconciler-offer-sharing-refinement.spec.ts
autonomous: true
requirements:
  - E2E-02
gap_closure: true

must_haves:
  truths:
    - "OFFER_OPTIONAL reconciler E2E test passes 3 consecutive runs"
    - "OFFER_SHARING + refinement reconciler E2E test passes 3 consecutive runs"
    - "Visual regression baselines exist for all toHaveScreenshot assertions in both tests"
  artifacts:
    - path: "e2e/tests/two-browser-reconciler-offer-optional.spec.ts"
      provides: "Verified OFFER_OPTIONAL E2E test"
    - path: "e2e/tests/two-browser-reconciler-offer-sharing-refinement.spec.ts"
      provides: "Verified OFFER_SHARING + refinement E2E test"
    - path: "e2e/tests/two-browser-reconciler-offer-optional.spec.ts-snapshots/"
      provides: "Complete OFFER_OPTIONAL visual baselines"
    - path: "e2e/tests/two-browser-reconciler-offer-sharing-refinement.spec.ts-snapshots/"
      provides: "Complete OFFER_SHARING visual baselines"
  key_links:
    - from: "e2e/tests/two-browser-reconciler-offer-optional.spec.ts"
      to: "e2e/helpers/test-utils.ts"
      via: "sendAndWaitForPanel and confirmFeelHeard imports (fixed in Plan 03)"
      pattern: "import.*from.*test-utils"
    - from: "e2e/tests/two-browser-reconciler-offer-sharing-refinement.spec.ts"
      to: "e2e/helpers/test-utils.ts"
      via: "sendAndWaitForPanel and confirmFeelHeard imports (fixed in Plan 03)"
      pattern: "import.*from.*test-utils"
---

<objective>
Stabilize reconciler edge case E2E tests and generate complete visual baselines.

Purpose: With the shared helper timing fixes from Plan 03 (sendAndWaitForPanel 5s timeout, confirmFeelHeard 15s response timeout), the reconciler tests should now be more stable. This plan runs both tests, fixes any remaining test-specific issues, generates complete visual baselines, and verifies 3 consecutive passes.

Output: Verified OFFER_OPTIONAL and OFFER_SHARING tests with complete visual baselines.
</objective>

<execution_context>
@/Users/shantam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-full-session-e2e-verification/13-03-SUMMARY.md
@e2e/tests/two-browser-reconciler-offer-optional.spec.ts
@e2e/tests/two-browser-reconciler-offer-sharing-refinement.spec.ts
@e2e/helpers/test-utils.ts
@e2e/helpers/two-browser-harness.ts
@e2e/playwright.two-browser.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Stabilize and verify OFFER_OPTIONAL test with 3 consecutive passes</name>
  <files>e2e/tests/two-browser-reconciler-offer-optional.spec.ts</files>
  <action>
Run the OFFER_OPTIONAL reconciler E2E test and fix any remaining issues after the helper fixes from Plan 03.

**Step 1: Initial run**
```bash
cd /Users/shantam/Software/meet-without-fear/e2e
npx playwright test two-browser-reconciler-offer-optional --config=playwright.two-browser.config.ts
```

**Step 2: Diagnose failures (if any)**

The previous failure patterns were:
1. **Visual regression mismatch (5497px diff)** - Stale baselines. AI response text differs because baselines were generated with a different fixture state. Fix: regenerate baselines with `--update-snapshots`.
2. **Panel timeout (empathy-review-button)** - Should be fixed by Plan 03's sendAndWaitForPanel timeout increase (2s -> 5s). If still failing, the fixture responses may not be producing the correct metadata. Check if `userAStage2Messages` match the fixture responses for `user-a-full-journey`.
3. **API response timeout (feel-heard confirmation)** - Should be fixed by Plan 03's confirmFeelHeard timeout increase. If still failing, check backend logs for the `/feel-heard` endpoint.

**Step 3: Fix remaining test-specific issues (if any)**

Possible adjustments:
- If visual baselines are the only issue, regenerate with `--update-snapshots`
- If panel timeouts persist despite helper fixes, investigate whether the reconciler-offer-optional fixture's response sequence matches the expected message count. The fixture may need different messages or the `maxAttempts` parameter may need adjustment.
- If Ably propagation waits (3000ms) are insufficient, increase to 5000ms
- If the ShareTopicPanel click with `force: true` still hangs, try alternative click strategies (e.g., `evaluate` to click via JS)

**Step 4: Generate/update baselines**
```bash
npx playwright test two-browser-reconciler-offer-optional --config=playwright.two-browser.config.ts --update-snapshots
```

Verify baselines exist in `e2e/tests/two-browser-reconciler-offer-optional.spec.ts-snapshots/` -- should have 15 PNG files (matching the 15 toHaveScreenshot calls in the test).

**Step 5: Run 3 consecutive times**
```bash
for i in 1 2 3; do
  echo "=== Run $i/3 ==="
  npx playwright test two-browser-reconciler-offer-optional --config=playwright.two-browser.config.ts
  if [ $? -ne 0 ]; then echo "FAILED on run $i"; exit 1; fi
  sleep 5
done
echo "SUCCESS: 3 consecutive passes"
```

**Deviation rules:**
- Up to 3 fix attempts for test-specific issues
- If test consistently fails at the same point after 3 attempts, document the specific failure and what was tried
- If the test passes but with expected deviations (e.g., known Ably timing issues), document them
  </action>
  <verify>
```bash
cd /Users/shantam/Software/meet-without-fear/e2e
npx playwright test two-browser-reconciler-offer-optional --config=playwright.two-browser.config.ts
```
Test passes with exit code 0.
  </verify>
  <done>
- OFFER_OPTIONAL test passes with all 15 toHaveScreenshot assertions
- Visual baselines generated in `-snapshots/` directory
- Test passes 3 consecutive runs (or failure documented with specific remaining issue)
- Any test-specific fixes documented
  </done>
</task>

<task type="auto">
  <name>Task 2: Stabilize and verify OFFER_SHARING + refinement test with 3 consecutive passes</name>
  <files>e2e/tests/two-browser-reconciler-offer-sharing-refinement.spec.ts</files>
  <action>
Run the OFFER_SHARING + refinement reconciler E2E test and fix any remaining issues after the helper fixes from Plan 03.

**Step 1: Initial run**
```bash
cd /Users/shantam/Software/meet-without-fear/e2e
npx playwright test two-browser-reconciler-offer-sharing-refinement --config=playwright.two-browser.config.ts
```

**Step 2: Diagnose failures (if any)**

The previous failure pattern was:
1. **Panel timeout (feel-heard-yes) in User B Stage 1** - Should be fixed by Plan 03's sendAndWaitForPanel timeout increase. If still failing, check if `reconciler-refinement` fixture's Stage 1 responses match the expected 4 messages and produce FeelHeardCheck metadata.

**Step 3: Fix remaining test-specific issues (if any)**

This test is longer than OFFER_OPTIONAL because it includes:
- Context sharing (subject accepts and shares)
- AI draft generation for context
- Guesser refinement flow
- Second reconciler run with hasContextAlreadyBeenShared guard

Possible adjustments:
- If visual baselines are missing, regenerate with `--update-snapshots`
- If the context sharing flow has UI changes since the test was written, update selectors
- If `waitForAnyAIResponse` after accept button click times out, increase its timeout
- If the refinement/reveal flow timing is too tight, add explicit waits
- If Ably propagation waits are insufficient, increase from 3000ms to 5000ms
- The test has known issue comments about accuracy feedback timing -- these are acceptable if documented

**Step 4: Generate/update baselines**
```bash
npx playwright test two-browser-reconciler-offer-sharing-refinement --config=playwright.two-browser.config.ts --update-snapshots
```

Verify baselines exist in the `-snapshots/` directory -- should have 20 PNG files (matching the 20 toHaveScreenshot calls).

**Step 5: Run 3 consecutive times**
```bash
for i in 1 2 3; do
  echo "=== Run $i/3 ==="
  npx playwright test two-browser-reconciler-offer-sharing-refinement --config=playwright.two-browser.config.ts
  if [ $? -ne 0 ]; then echo "FAILED on run $i"; exit 1; fi
  sleep 5
done
echo "SUCCESS: 3 consecutive passes"
```

**Deviation rules:**
- Up to 3 fix attempts for test-specific issues
- The test has known conditional paths (accuracy feedback may or may not appear) -- both paths are already handled in the test code with fallback screenshots
- If the test consistently fails at the same point after 3 attempts, document the specific failure
  </action>
  <verify>
```bash
cd /Users/shantam/Software/meet-without-fear/e2e
npx playwright test two-browser-reconciler-offer-sharing-refinement --config=playwright.two-browser.config.ts
```
Test passes with exit code 0.
  </verify>
  <done>
- OFFER_SHARING + refinement test passes with all 20 toHaveScreenshot assertions
- Visual baselines generated in `-snapshots/` directory
- Test passes 3 consecutive runs (or failure documented with specific remaining issue)
- Any test-specific fixes documented
  </done>
</task>

</tasks>

<verification>
1. `cd e2e && npx playwright test two-browser-reconciler-offer-optional --config=playwright.two-browser.config.ts` passes
2. `cd e2e && npx playwright test two-browser-reconciler-offer-sharing-refinement --config=playwright.two-browser.config.ts` passes
3. Both tests pass 3 consecutive runs each
4. Baselines in `two-browser-reconciler-offer-optional.spec.ts-snapshots/` (15 PNGs expected)
5. Baselines in `two-browser-reconciler-offer-sharing-refinement.spec.ts-snapshots/` (20 PNGs expected)
</verification>

<success_criteria>
- OFFER_OPTIONAL E2E test passes reliably (3 consecutive runs)
- OFFER_SHARING + refinement E2E test passes reliably (3 consecutive runs)
- All visual regression baselines exist and pass without `--update-snapshots`
- Both reconciler edge cases verified end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/13-full-session-e2e-verification/13-04-SUMMARY.md`
</output>
