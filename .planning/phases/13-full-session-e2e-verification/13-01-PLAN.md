---
phase: 13-full-session-e2e-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - e2e/tests/two-browser-full-flow.spec.ts
autonomous: true
requirements:
  - E2E-01

must_haves:
  truths:
    - "Full-flow test covers Stage 0 through Stage 4 completion for both users"
    - "Both users see empathy revealed after reconciler (Stage 2 exit)"
    - "Both users complete needs extraction, confirmation, consent, and common ground (Stage 3)"
    - "Both users propose strategies, rank, see overlap, and confirm agreement (Stage 4)"
    - "Test passes 3 consecutive runs without flakiness"
  artifacts:
    - path: "e2e/tests/two-browser-full-flow.spec.ts"
      provides: "Extended full-flow E2E test covering Stages 0-4"
      contains: "STAGE 4"
  key_links:
    - from: "e2e/tests/two-browser-full-flow.spec.ts"
      to: "e2e/helpers/test-utils.ts"
      via: "imports signCompact, handleMoodCheck, sendAndWaitForPanel, confirmFeelHeard, waitForReconcilerComplete, navigateToShareFromSession, navigateBackToChat"
      pattern: "import.*from.*test-utils"
    - from: "e2e/tests/two-browser-full-flow.spec.ts"
      to: "backend API endpoints"
      via: "API-driven Stage 3-4 operations (needs extraction, strategy proposal, ranking, agreement)"
      pattern: "apiA\\.(get|post).*sessions"
---

<objective>
Extend the existing full-flow E2E test from Stage 0-2 to cover the complete partner session through Stage 4 completion.

Purpose: Prove that two users can reliably complete an entire partner session from start to finish (compact signing, witnessing, empathy sharing, reconciler, needs extraction, strategy ranking, agreement).

Output: Extended `two-browser-full-flow.spec.ts` that passes 3 consecutive runs covering Stages 0-4.
</objective>

<execution_context>
@/Users/shantam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@e2e/tests/two-browser-full-flow.spec.ts
@e2e/tests/two-browser-stage-3.spec.ts
@e2e/tests/two-browser-stage-4.spec.ts
@e2e/helpers/test-utils.ts
@e2e/helpers/two-browser-harness.ts
@e2e/helpers/auth.ts
@e2e/playwright.two-browser.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend full-flow test to cover Stages 3-4 with API-driven operations</name>
  <files>e2e/tests/two-browser-full-flow.spec.ts</files>
  <action>
Extend the existing `two-browser-full-flow.spec.ts` test to continue from Stage 2 completion through Stage 4 agreement confirmation. The test currently ends at "both users complete Stages 0-2 and enter Stage 3" with chat input visible for both users.

**Add Stage 3 (Needs Extraction) after the existing Stage 3 verification section (after line ~268):**

1. Create API helpers using `getE2EHeaders` for both users (similar pattern from `two-browser-stage-3.spec.ts`). Import `getE2EHeaders` from `../helpers/auth` if not already imported.
2. Trigger needs extraction via GET `${API_BASE_URL}/api/sessions/${sessionId}/needs` for both users in parallel.
3. Wait 2s for processing, then reload both pages.
4. Handle mood check after reload.
5. Wait for "Confirm my needs" text to be visible for both users (30s timeout).
6. Get needs via GET endpoint, confirm needs via POST `/api/sessions/${sessionId}/needs/confirm` with `{ needIds }` for both users.
7. Consent to share needs via POST `/api/sessions/${sessionId}/needs/consent` with `{ needIds }` for both users.
8. Poll common ground endpoint (GET `/api/sessions/${sessionId}/common-ground`) until `commonGround.length > 0` (30s timeout, 2s interval).
9. Reload both pages and verify "Shared Needs Discovered" text visible.

**Add Stage 4 (Strategies & Agreement) after Stage 3:**

1. Propose strategies via POST `/api/sessions/${sessionId}/strategies` -- User A proposes 2 strategies, User B proposes 1 (3 total, same pattern as `two-browser-stage-4.spec.ts`).
2. Verify 3 strategies via GET endpoint.
3. Mark both users ready via POST `/api/sessions/${sessionId}/strategies/ready`.
4. Get strategy IDs from GET endpoint, submit rankings for both users via POST `/api/sessions/${sessionId}/strategies/rank` with `{ rankedIds }`. Both rank strategy1 first for guaranteed overlap.
5. Verify `canReveal: true` from User B's ranking response.
6. Get overlap via GET `/api/sessions/${sessionId}/strategies/overlap`, verify at least 1 overlap strategy.
7. Create agreement via POST `/api/sessions/${sessionId}/agreements` using first overlap strategy (with `type: 'MICRO_EXPERIMENT'`, `followUpDate` 7 days out).
8. Confirm agreement via POST `/api/sessions/${sessionId}/agreements/${agreementId}/confirm` as User B.
9. Verify `sessionComplete: true` in response.

**Important implementation details:**
- Use `harness.userAPage` and `harness.userBPage` for UI interactions (not `pageA`/`pageB`).
- Use harness properties for session/user IDs: `harness.sessionId`, `harness.userAId`, `harness.userBId`.
- API_BASE_URL should be defined as constant or use harness.apiBaseUrl (use `const API_BASE_URL = process.env.API_BASE_URL || 'http://localhost:3000'`).
- Import `getE2EHeaders` from `'../helpers/auth'` for API request construction.
- Use `request` parameter from the test function for API calls (already available in test signature).
- The test already has `test.setTimeout(900000)` (15 minutes) which is sufficient for full flow.
- Update the test name from "both users complete Stages 0-2 and enter Stage 3" to "both users complete full session: Stages 0-4".
- Update the describe block name from "Full Partner Journey: Stages 0-3" to "Full Partner Journey: Stages 0-4".
- Update the file header comment to describe Stage 0-4 coverage.
- Replace the old `page.screenshot()` calls (lines 251-252 and 271-272) with `toHaveScreenshot()` assertions following the Phase 12 pattern: `await expect(page).toHaveScreenshot('name.png', { maxDiffPixels: 100 })`.
- Add screenshots at key Stage 3-4 checkpoints: after needs review, after common ground, after strategy pool, after overlap, and final agreement state.
- Do NOT add screenshots for the share page verification section (lines 230-248) -- keep the existing validation button checks.

**Helper function pattern for API requests:**
```typescript
function makeApiRequest(
  request: APIRequestContext,
  userEmail: string,
  userId: string,
  fixtureId?: string
) {
  const headers = getE2EHeaders(userEmail, userId, fixtureId);
  return {
    get: (url: string) => request.get(url, { headers }),
    post: (url: string, data?: object) => request.post(url, { headers, data }),
  };
}
```

Import `APIRequestContext` from `@playwright/test` in the existing import statement.
  </action>
  <verify>
Run the extended full-flow test 3 consecutive times:
```bash
cd /Users/shantam/Software/meet-without-fear/e2e
for i in 1 2 3; do
  echo "=== Run $i/3 ==="
  npx playwright test two-browser-full-flow --config=playwright.two-browser.config.ts
  if [ $? -ne 0 ]; then
    echo "FAILED on run $i"
    exit 1
  fi
  sleep 5
done
echo "SUCCESS: 3 consecutive passes"
```

Also verify the test covers all stages by checking console output includes:
- Stage 0: compact signing
- Stage 1: feel-heard confirmation
- Stage 2: empathy sharing + reconciler
- Stage 3: needs extraction + common ground
- Stage 4: strategies + ranking + agreement
  </verify>
  <done>
- Test `two-browser-full-flow.spec.ts` covers Stages 0-4 completely
- Both users complete needs extraction, confirmation, consent, and common ground in Stage 3
- Both users propose strategies, rank, see overlap, create and confirm agreement in Stage 4
- Session marked complete after agreement confirmation (`sessionComplete: true`)
- Test passes 3 consecutive runs without flakiness
- Visual regression screenshots captured at key State 3-4 checkpoints
  </done>
</task>

</tasks>

<verification>
1. `cd e2e && npx playwright test two-browser-full-flow --config=playwright.two-browser.config.ts` passes
2. Test name updated to reflect Stages 0-4 coverage
3. Test completes within 15-minute timeout
4. Console output shows all 5 stages completing for both users
5. Visual regression screenshots generated in `two-browser-full-flow.spec.ts-snapshots/` directory
6. 3 consecutive runs pass without flakiness
</verification>

<success_criteria>
- Full-flow test covers complete partner session from compact signing to agreement confirmation
- Both users complete all stages (0, 1, 2, 3, 4) in a single test run
- Session is marked complete at the end
- Test is reliable (3 consecutive passes)
- Screenshots document key state transitions
</success_criteria>

<output>
After completion, create `.planning/phases/13-full-session-e2e-verification/13-01-SUMMARY.md`
</output>
