---
phase: 13-full-session-e2e-verification
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - e2e/tests/two-browser-reconciler-offer-optional.spec.ts
  - e2e/tests/two-browser-reconciler-offer-sharing-refinement.spec.ts
autonomous: true
requirements:
  - E2E-02

must_haves:
  truths:
    - "OFFER_OPTIONAL reconciler E2E test passes reliably (3 consecutive runs)"
    - "OFFER_SHARING + refinement reconciler E2E test passes reliably (3 consecutive runs)"
    - "Visual regression baselines exist and pass for all reconciler edge case screenshots"
    - "No test modifications needed OR bugs fixed if tests were failing"
  artifacts:
    - path: "e2e/tests/two-browser-reconciler-offer-optional.spec.ts"
      provides: "Verified OFFER_OPTIONAL E2E test"
    - path: "e2e/tests/two-browser-reconciler-offer-sharing-refinement.spec.ts"
      provides: "Verified OFFER_SHARING + refinement E2E test"
  key_links:
    - from: "e2e/tests/two-browser-reconciler-offer-optional.spec.ts"
      to: "e2e/tests/two-browser-reconciler-offer-optional.spec.ts-snapshots/"
      via: "toHaveScreenshot() visual regression assertions"
      pattern: "toHaveScreenshot"
    - from: "e2e/tests/two-browser-reconciler-offer-sharing-refinement.spec.ts"
      to: "e2e/tests/two-browser-reconciler-offer-sharing-refinement.spec.ts-snapshots/"
      via: "toHaveScreenshot() visual regression assertions"
      pattern: "toHaveScreenshot"
---

<objective>
Verify that reconciler edge case E2E tests (OFFER_OPTIONAL and OFFER_SHARING) pass reliably with 3 consecutive runs each.

Purpose: Confirm that the reconciler edge case paths work correctly and consistently, completing the E2E-02 requirement. These tests already exist from Phase 8 and were converted to visual regression in Phase 12 -- this plan verifies they run reliably now.

Output: Verified passing reconciler edge case tests with documentation of any fixes applied.
</objective>

<execution_context>
@/Users/shantam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@e2e/tests/two-browser-reconciler-offer-optional.spec.ts
@e2e/tests/two-browser-reconciler-offer-sharing-refinement.spec.ts
@e2e/helpers/test-utils.ts
@e2e/helpers/two-browser-harness.ts
@e2e/playwright.two-browser.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run and verify OFFER_OPTIONAL test passes 3 consecutive times</name>
  <files>e2e/tests/two-browser-reconciler-offer-optional.spec.ts</files>
  <action>
Run the OFFER_OPTIONAL reconciler test and verify it passes reliably.

**Step 1: Initial run to check current status**
```bash
cd /Users/shantam/Software/meet-without-fear/e2e
npx playwright test two-browser-reconciler-offer-optional --config=playwright.two-browser.config.ts
```

**Step 2: Analyze results**
- If test PASSES: proceed to 3-consecutive-run verification
- If test FAILS due to missing baselines (screenshot comparison with no baseline): run with `--update-snapshots` to generate baselines, then re-run to verify
- If test FAILS due to screenshot diff: check if the diff is from intentional UI changes (Phase 12+ changes). If so, update baselines with `--update-snapshots`. If not, investigate the root cause.
- If test FAILS due to timeout: increase specific wait times (e.g., Ably propagation waits, reconciler polling timeouts). Common fixes:
  - Increase `waitForReconcilerComplete` timeout from 60s to 90s
  - Add `page.waitForTimeout(2000)` after Ably event triggers
  - Increase `toBeVisible` timeouts from 5000 to 10000
- If test FAILS due to element not found: check if testIDs changed since Phase 8. Update selectors if needed.
- If test FAILS due to race condition: ensure both users complete empathy drafting BEFORE either shares (critical pattern from MEMORY.md).

**Step 3: Fix any issues found** (only if test fails)
Apply targeted fixes to the test file. Do NOT restructure the test -- make minimal changes to fix the specific failure.

**Step 4: Run 3 consecutive times**
```bash
for i in 1 2 3; do
  echo "=== Run $i/3 ==="
  npx playwright test two-browser-reconciler-offer-optional --config=playwright.two-browser.config.ts
  if [ $? -ne 0 ]; then echo "FAILED on run $i"; exit 1; fi
  sleep 5
done
echo "SUCCESS: 3 consecutive passes"
```
  </action>
  <verify>
```bash
cd /Users/shantam/Software/meet-without-fear/e2e
npx playwright test two-browser-reconciler-offer-optional --config=playwright.two-browser.config.ts
```
Test passes with all visual regression assertions.
  </verify>
  <done>
- OFFER_OPTIONAL test passes 3 consecutive runs
- All toHaveScreenshot() assertions pass against baselines
- Any fixes documented (or "no changes needed" if test passed as-is)
  </done>
</task>

<task type="auto">
  <name>Task 2: Run and verify OFFER_SHARING + refinement test passes 3 consecutive times</name>
  <files>e2e/tests/two-browser-reconciler-offer-sharing-refinement.spec.ts</files>
  <action>
Run the OFFER_SHARING + refinement reconciler test and verify it passes reliably. Follow the same diagnostic and fix approach as Task 1.

**Step 1: Initial run to check current status**
```bash
cd /Users/shantam/Software/meet-without-fear/e2e
npx playwright test two-browser-reconciler-offer-sharing-refinement --config=playwright.two-browser.config.ts
```

**Step 2: Analyze results** (same diagnostic approach as Task 1)
- Missing baselines → generate with `--update-snapshots`
- Screenshot diffs → evaluate if intentional, update if so
- Timeouts → increase specific wait times
- Element not found → update selectors
- Race conditions → fix ordering

**Step 3: Fix any issues found** (minimal targeted changes only)

**Step 4: Run 3 consecutive times**
```bash
for i in 1 2 3; do
  echo "=== Run $i/3 ==="
  npx playwright test two-browser-reconciler-offer-sharing-refinement --config=playwright.two-browser.config.ts
  if [ $? -ne 0 ]; then echo "FAILED on run $i"; exit 1; fi
  sleep 5
done
echo "SUCCESS: 3 consecutive passes"
```

**Note:** This test is longer than OFFER_OPTIONAL (~180s+) because it includes context sharing, guesser refinement, and reconciler re-run. If it runs close to the timeout, verify `test.setTimeout()` is set to at least 900000 (15 minutes).
  </action>
  <verify>
```bash
cd /Users/shantam/Software/meet-without-fear/e2e
npx playwright test two-browser-reconciler-offer-sharing-refinement --config=playwright.two-browser.config.ts
```
Test passes with all visual regression assertions.
  </verify>
  <done>
- OFFER_SHARING + refinement test passes 3 consecutive runs
- All toHaveScreenshot() assertions pass against baselines
- Any fixes documented (or "no changes needed" if test passed as-is)
  </done>
</task>

</tasks>

<verification>
1. `cd e2e && npx playwright test two-browser-reconciler-offer-optional --config=playwright.two-browser.config.ts` passes
2. `cd e2e && npx playwright test two-browser-reconciler-offer-sharing-refinement --config=playwright.two-browser.config.ts` passes
3. Both tests pass 3 consecutive runs each
4. Visual regression baselines present in `-snapshots/` directories
5. All toHaveScreenshot() assertions pass without `--update-snapshots`
</verification>

<success_criteria>
- OFFER_OPTIONAL E2E test passes reliably (3 consecutive runs)
- OFFER_SHARING + refinement E2E test passes reliably (3 consecutive runs)
- All visual regression assertions pass
- Any fixes applied are minimal and targeted (no unnecessary restructuring)
</success_criteria>

<output>
After completion, create `.planning/phases/13-full-session-e2e-verification/13-02-SUMMARY.md`
</output>
