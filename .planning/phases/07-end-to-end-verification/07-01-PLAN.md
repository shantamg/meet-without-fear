---
phase: 07-end-to-end-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - e2e/tests/two-browser-full-flow.spec.ts
autonomous: false

must_haves:
  truths:
    - "Full two-browser E2E test passes: both users complete Stages 0-2 and enter Stage 3"
    - "Test passes 3 consecutive runs without flakiness"
    - "All 18 v1 requirements are verified as satisfied"
  artifacts:
    - path: "e2e/tests/two-browser-full-flow.spec.ts"
      provides: "Full partner journey E2E test (Stages 0 through Stage 3 entry)"
      min_lines: 150
  key_links:
    - from: "e2e/tests/two-browser-full-flow.spec.ts"
      to: "e2e/helpers/two-browser-harness.ts"
      via: "TwoBrowserHarness import"
      pattern: "import.*TwoBrowserHarness"
    - from: "e2e/tests/two-browser-full-flow.spec.ts"
      to: "e2e/helpers/test-utils.ts"
      via: "helper function imports"
      pattern: "import.*signCompact.*handleMoodCheck.*sendAndWaitForPanel.*confirmFeelHeard.*waitForReconcilerComplete"
---

<objective>
Create and validate a full two-browser E2E test proving both users can reliably complete Stages 0-2 and enter Stage 3 together, passing 3 consecutive runs.

Purpose: This is the final verification phase. All bugs have been fixed (Phases 5-6), all individual stage tests pass (Phases 3-4). Phase 7 proves the COMPLETE partner journey works end-to-end, reliably and repeatably.

Output: `e2e/tests/two-browser-full-flow.spec.ts` passing 3 consecutive runs via `--repeat-each=3`.
</objective>

<execution_context>
@/Users/shantam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@e2e/tests/two-browser-stage-2.spec.ts
@e2e/helpers/two-browser-harness.ts
@e2e/helpers/test-utils.ts
@e2e/playwright.two-browser.config.ts
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create full-flow E2E test composing Stages 0-3 entry</name>
  <files>e2e/tests/two-browser-full-flow.spec.ts</files>
  <action>
Create `e2e/tests/two-browser-full-flow.spec.ts` by composing the proven patterns from `two-browser-stage-2.spec.ts` into a dedicated full-flow test. The Stage 2 test already exercises the complete Stage 0->1->2->3 journey; this test is a clean, standalone version focused on the "proof" use case.

Structure:
1. Import TwoBrowserHarness and all helpers: signCompact, handleMoodCheck, sendAndWaitForPanel, confirmFeelHeard, waitForReconcilerComplete, navigateToShareFromSession, navigateBackToChat
2. Use `test.use(devices['iPhone 12'])` for mobile viewport
3. Use UNIQUE email addresses to avoid collisions with other tests: `full-flow-a@e2e.test` and `full-flow-b@e2e.test`
4. Use asymmetric fixtures: User A = `user-a-full-journey` (no reconciler ops, shares first), User B = `reconciler-no-gaps` (reconciler ops, shares second triggers reconciler)
5. Set `test.setTimeout(900000)` (15 minutes)

Test flow (single test case inside `test.describe('Full Partner Journey: Stages 0-3', ...)`):

**beforeEach:** Create harness, cleanup, setupUserA, createSession
**afterEach:** harness.teardown()

**Test: "both users complete Stages 0-2 and enter Stage 3":**

Stage 0 (Compact Signing):
- setupUserB, acceptInvitation
- navigateUserA -> signCompact -> handleMoodCheck
- navigateUserB -> signCompact -> handleMoodCheck
- Assert: both users see chat-input

Stage 1 User A (Witnessing + Feel-Heard):
- Send first 2 messages: "Hi, I'm having a conflict with my partner", "We keep arguing about household chores"
  (use manual loop: fill chat-input, click send-button, wait for typing-indicator to not be visible with 60s timeout, waitForTimeout(500))
- Dismiss invitation panel: check for "I've sent it - Continue" text visibility (5s timeout, catch to false), click if visible
- Send remaining messages via sendAndWaitForPanel: ["Thanks, I sent the invitation", "I feel like I do most of the work and they don't notice or appreciate it"] targeting 'feel-heard-yes' panel, maxAttempts=2
- confirmFeelHeard

Stage 1 User B (Witnessing + Feel-Heard):
- sendAndWaitForPanel with messages: ["Things have been tense lately", "I feel like we've just been miscommunicating", "I want them to know I still care, even when I'm stressed", "Exactly. I just want us to be on the same page again"] targeting 'feel-heard-yes', maxAttempts=4
- confirmFeelHeard

Stage 2 Empathy Drafting (BOTH users draft BEFORE either shares - critical race condition avoidance):
- User A empathy: sendAndWaitForPanel with ["Yes, I feel heard now", "I guess they might be stressed from work too"] targeting 'empathy-review-button', maxAttempts=2
- User B empathy: sendAndWaitForPanel with ["Yes, I feel understood", "I think they might be feeling frustrated too", "Maybe they feel like I pull away when stressed and they want to connect"] targeting 'empathy-review-button', maxAttempts=3

Stage 2 Empathy Sharing:
- User A shares: click empathy-review-button, assert share-empathy-button visible, click it
- Wait 3s for Ably event delivery (waitForTimeout(3000))
- User B shares: click empathy-review-button, assert share-empathy-button visible, click it

Reconciler Completion:
- Wait 2s for reconciler trigger
- waitForReconcilerComplete for User A (60s timeout) - throw with screenshot if false
- waitForReconcilerComplete for User B (60s timeout) - throw with screenshot if false

Stage 3 Verification:
- Navigate both users to Share tab: navigateToShareFromSession for both
- Navigate both back to chat: navigateBackToChat for both
- handleMoodCheck for both (can reappear after navigation)
- Assert: both users see chat-input (5s timeout) - this proves Stage 3 entry
- Take final screenshots: test-results/full-flow-final-a.png, test-results/full-flow-final-b.png

IMPORTANT: Use exact same message strings and flow order as two-browser-stage-2.spec.ts. These match the fixture response indices. Do NOT invent new messages.

IMPORTANT: Include clear section comments (// === STAGE 0: COMPACT SIGNING ===, etc.) for readability.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd e2e && npx tsc --noEmit --project tsconfig.json 2>&1 || echo "Check for TS errors"
```
File exists and has expected structure:
```bash
grep -c "Stage 0\|Stage 1\|Stage 2\|Stage 3" e2e/tests/two-browser-full-flow.spec.ts
```
  </verify>
  <done>
`e2e/tests/two-browser-full-flow.spec.ts` exists with complete test covering Stages 0 through Stage 3 entry for both users, using unique emails, asymmetric fixtures, and all established patterns from the Stage 2 test.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run full-flow test 3 consecutive times and verify all requirements</name>
  <files>e2e/tests/two-browser-full-flow.spec.ts</files>
  <action>
Run the full-flow test 3 consecutive times using Playwright's --repeat-each flag:

```bash
cd e2e && npx playwright test --config=playwright.two-browser.config.ts two-browser-full-flow.spec.ts --repeat-each=3
```

Expected runtime: ~45 minutes total (15 min per run).

If all 3 runs pass: VERIF-01 and VERIF-02 are satisfied.

If any run fails:
1. Check test-results/ for screenshots and traces
2. Diagnose whether failure is test-level (flaky wait, timing) or app-level (actual bug)
3. If test-level: fix the test (adjust timeout, add wait, fix selector) and re-run
4. If app-level: document the bug and note that Phase 7 reveals it (this should be rare since individual stage tests all pass)

After 3 consecutive passes, verify all 18 v1 requirements by cross-referencing with prior phase work:
- AUDIT-01 through AUDIT-04: Satisfied by Phase 1 audit documents
- TEST-01 through TEST-05: Satisfied by Phases 2-4 test files
- TRANS-01 through TRANS-04: Satisfied by Phase 5 fixes + E2E verification
- RECON-01 through RECON-03: Satisfied by Phase 6 fixes + E2E verification
- VERIF-01: Full-flow test passes
- VERIF-02: 3 consecutive runs without flakiness

Document the verification in the SUMMARY.
  </action>
  <verify>
Playwright output shows "3 passed" with 0 failures:
```
3 passed (approximately 45 minutes)
```
  </verify>
  <done>
Full-flow test passes 3 consecutive runs. All 18 v1 requirements verified as satisfied. VERIF-01 and VERIF-02 complete.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verification of Session Reliability milestone completion</name>
  <files>e2e/tests/two-browser-full-flow.spec.ts</files>
  <action>
Present test results to user for final milestone approval. User reviews:
1. Test output showing 3/3 consecutive passes
2. The full-flow test file covering complete Stages 0-3 entry
3. Final screenshots from both users in test-results/
4. All 18 v1 requirements cross-referenced as satisfied
  </action>
  <verify>User confirms milestone is complete by typing "approved"</verify>
  <done>User has approved the Session Reliability milestone as complete</done>
</task>

</tasks>

<verification>
1. `e2e/tests/two-browser-full-flow.spec.ts` exists and compiles
2. Test passes 3 consecutive runs: `cd e2e && npx playwright test --config=playwright.two-browser.config.ts two-browser-full-flow.spec.ts --repeat-each=3`
3. All existing tests still pass (no regressions): `cd e2e && npx playwright test --config=playwright.two-browser.config.ts`
</verification>

<success_criteria>
1. Full two-browser E2E test covers complete Stages 0-2 journey and Stage 3 entry for both users
2. Test passes 3 consecutive runs without flakiness (--repeat-each=3, 0 failures)
3. All 18 v1 requirements verified as satisfied
4. No regressions in existing Stage 0, 1, 2 tests
</success_criteria>

<output>
After completion, create `.planning/phases/07-end-to-end-verification/07-01-SUMMARY.md`
</output>
