---
phase: 09-circuit-breaker-implementation
plan: 02
type: execute
wave: 2
depends_on:
  - 09-01
files_modified:
  - backend/src/fixtures/reconciler-circuit-breaker.ts
  - backend/src/fixtures/index.ts
  - e2e/tests/two-browser-circuit-breaker.spec.ts
autonomous: true
requirements:
  - RECON-EC-04

must_haves:
  truths:
    - "E2E test proves 4th reconciler attempt is skipped and both users see empathy revealed"
    - "Circuit breaker transition message appears in guesser's chat (natural, not error-like)"
    - "Screenshot captures the circuit breaker progression state"
  artifacts:
    - path: "backend/src/fixtures/reconciler-circuit-breaker.ts"
      provides: "Fixture that always returns OFFER_SHARING (significant gaps) to force repeated refinement attempts"
    - path: "e2e/tests/two-browser-circuit-breaker.spec.ts"
      provides: "Two-browser E2E test verifying circuit breaker trips after 3 attempts"
  key_links:
    - from: "e2e/tests/two-browser-circuit-breaker.spec.ts"
      to: "backend/src/fixtures/reconciler-circuit-breaker.ts"
      via: "fixtureId: 'reconciler-circuit-breaker' in TwoBrowserHarness config"
      pattern: "fixtureId.*reconciler-circuit-breaker"
    - from: "backend/src/fixtures/reconciler-circuit-breaker.ts"
      to: "backend/src/fixtures/index.ts"
      via: "registered in fixtureRegistry"
      pattern: "reconciler-circuit-breaker"
---

<objective>
Create an E2E test that proves the circuit breaker forces READY status after 3 refinement attempts, with a dedicated fixture and screenshots documenting the progression.

Purpose: Verifies the circuit breaker works end-to-end in a real two-browser session. The fixture always returns significant gaps (OFFER_SHARING), which forces the reconciler to keep looping — until the circuit breaker trips on the 4th attempt and both users see empathy revealed.

Output: New fixture file, updated fixture registry, and a two-browser E2E test with screenshots.
</objective>

<execution_context>
@/Users/shantam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-circuit-breaker-implementation/09-RESEARCH.md
@.planning/phases/09-circuit-breaker-implementation/09-01-SUMMARY.md
@backend/src/fixtures/reconciler-refinement.ts
@backend/src/fixtures/index.ts
@e2e/tests/two-browser-reconciler-offer-sharing-refinement.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create circuit breaker fixture and register it</name>
  <files>
    backend/src/fixtures/reconciler-circuit-breaker.ts
    backend/src/fixtures/index.ts
  </files>
  <action>
**Create fixture: `backend/src/fixtures/reconciler-circuit-breaker.ts`**

Clone the structure of `reconciler-refinement.ts` but modify it for the circuit breaker test:

1. **Same witnessing/empathy responses** (7 responses total: 4 witnessing + feel-heard check, 3 empathy building with ReadyShare:Y and draft). Copy directly from `reconciler-refinement.ts` — these drive the Stage 0-1-2 prerequisite flow.

2. **Operations — reconciler-analysis**: Must ALWAYS return `OFFER_SHARING` with significant gaps. Unlike the refinement fixture (which relies on hasContextAlreadyBeenShared guard to stop the loop), this fixture wants the loop to continue until the circuit breaker stops it. The fixture response is identical to the refinement fixture's reconciler-analysis — the circuit breaker happens BEFORE the fixture response is used, so on the 4th call, the fixture is never consulted.

3. **Operations — reconciler-share-suggestion**: Same as refinement fixture (generates draft for subject to share).

4. **Operations — reconciler-refine-suggestion**: Same as refinement fixture (generates refined empathy for guesser).

The key insight: the circuit breaker operates at the `runReconcilerForDirection` level BEFORE any fixture/AI call. So the fixture just needs to return OFFER_SHARING consistently for the first 3 attempts. On the 4th attempt, `checkAndIncrementAttempts` returns `shouldSkipReconciler=true` and the reconciler never runs.

**Register in index.ts:**

In `backend/src/fixtures/index.ts`:
1. Import: `import { reconcilerCircuitBreaker } from './reconciler-circuit-breaker';`
2. Add to exports: `reconcilerCircuitBreaker,`
3. Add to fixtureRegistry: `'reconciler-circuit-breaker': reconcilerCircuitBreaker,`
  </action>
  <verify>
- `npm run check` passes (fixture types are correct)
- `backend/src/fixtures/reconciler-circuit-breaker.ts` exists
- `grep 'reconciler-circuit-breaker' backend/src/fixtures/index.ts` shows registration
  </verify>
  <done>
- Fixture file created with OFFER_SHARING responses for all reconciler operations
- Fixture registered in index.ts with ID 'reconciler-circuit-breaker'
- Type checking passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Create two-browser circuit breaker E2E test</name>
  <files>
    e2e/tests/two-browser-circuit-breaker.spec.ts
  </files>
  <action>
**Create E2E test: `e2e/tests/two-browser-circuit-breaker.spec.ts`**

Follow the pattern established in `two-browser-reconciler-offer-sharing-refinement.spec.ts`. Key differences:

**Setup:**
- User A: `fixtureId: 'user-a-full-journey'` (guesser)
- User B: `fixtureId: 'reconciler-circuit-breaker'` (subject — fixture always returns OFFER_SHARING)
- Timeout: 15 minutes (900000ms) — multiple refinement loops + circuit breaker
- iPhone 12 viewport

**Test flow:**
1. **Stage 0-1 prerequisite** — Both users complete compact signing and feel-heard. (Use established patterns from existing two-browser tests.)
2. **Stage 2 empathy drafting** — Both users draft empathy BEFORE either shares (avoids race condition per established pattern).
3. **User A shares empathy (guesser)** — First to share, no reconciler triggered yet.
4. **User B shares empathy (subject)** — Triggers reconciler. This is attempt 1 (circuit breaker count = 1).
5. **Reconciler loop iteration 1:** Reconciler returns OFFER_SHARING. Subject sees ShareTopicPanel (orange). Subject accepts and shares context. Guesser receives context, refines empathy, and resubmits. This triggers attempt 2.
6. **Reconciler loop iteration 2:** Same as iteration 1. Reconciler returns OFFER_SHARING again. Subject shares more context, guesser refines and resubmits. This triggers attempt 3.
7. **Reconciler loop iteration 3:** Same again. Attempt 3. Subject shares, guesser refines and resubmits. This triggers attempt 4.
8. **Circuit breaker trips (attempt 4):** `checkAndIncrementAttempts` returns `shouldSkipReconciler=true`. Reconciler is SKIPPED. `markEmpathyReady` is called with `circuitBreakerTripped=true`. Guesser sees transition message ("Let's move forward").
9. **Verify final state:** Both users see empathy revealed (partner's empathy statement visible). Screenshot both perspectives.

**Important note on the reconciler call counting:**
- The reconciler is called by `runReconcilerForDirection` for one direction at a time
- The FIRST reconciler call happens when User B shares empathy (the last to share triggers reconciler for BOTH directions)
- Subsequent calls happen when a guesser resubmits refined empathy
- The circuit breaker counts each call to `runReconcilerForDirection` for the same direction
- The test needs to drive the guesser through 3 full refinement cycles (share, receive context, refine, resubmit) so the 4th reconciler call for that direction trips the breaker

**Practical simplification:** The E2E test may be very long (3 full refinement loops). If the test exceeds reasonable execution time or context, it can be simplified to verify that:
1. At least 1 refinement loop completes normally (proving the fixture works)
2. The circuit breaker counter is checked by examining the guesser's chat for the circuit breaker transition message ("Let's move forward")
3. Both users eventually see empathy revealed

The test should also check the server logs or rely on the distinct transition message text as proof that the circuit breaker (not normal READY flow) triggered the progression.

**Screenshots to capture:**
- `circuit-breaker-01-refinement-loop.png` — Guesser during a refinement iteration
- `circuit-breaker-02-guesser-message.png` — Circuit breaker transition message visible to guesser
- `circuit-breaker-03-guesser-revealed.png` — Final state: guesser sees partner empathy
- `circuit-breaker-03-subject-revealed.png` — Final state: subject sees partner empathy

**Patterns to follow (from 08-04 test patterns):**
- Wait for typing indicator to disappear before interacting with panels
- Use `force: true` click for ShareTopicPanel
- Set up dialog handler BEFORE clicking decline button (if applicable)
- Wait 3s after Ably-triggering actions before screenshots
- Dismiss "Almost There" modal before interacting with panels
  </action>
  <verify>
Run the E2E test:
```bash
cd e2e && npx playwright test two-browser-circuit-breaker --config=playwright.config.ts --headed
```

Verify:
- Test completes without timeout
- Screenshots captured in `test-results/` directory
- Guesser's chat contains circuit breaker message text ("Let's move forward" or similar)
- Both users see partner empathy revealed at end of test
  </verify>
  <done>
- E2E test file exists at e2e/tests/two-browser-circuit-breaker.spec.ts
- Test proves circuit breaker forces READY after repeated refinement attempts
- Circuit breaker transition message is visible in guesser chat (not the normal "quite accurate" message)
- Both users see empathy revealed (partner empathy statement visible)
- Screenshots captured documenting the circuit breaker flow
  </done>
</task>

</tasks>

<verification>
```bash
# Type checking
npm run check

# Fixture registered
grep 'reconciler-circuit-breaker' backend/src/fixtures/index.ts

# E2E test exists
ls -la e2e/tests/two-browser-circuit-breaker.spec.ts

# Run E2E test (headed for debugging if needed)
cd e2e && npx playwright test two-browser-circuit-breaker --config=playwright.config.ts

# Check screenshots captured
ls test-results/circuit-breaker-*.png
```
</verification>

<success_criteria>
1. Fixture always returns OFFER_SHARING for reconciler-analysis operation
2. E2E test drives guesser through multiple refinement loops until circuit breaker trips
3. Circuit breaker transition message ("Let's move forward") appears in guesser chat
4. Both users see empathy revealed after circuit breaker trips
5. Screenshots document the circuit breaker flow
6. Test runs within 15-minute timeout
</success_criteria>

<output>
After completion, create `.planning/phases/09-circuit-breaker-implementation/09-02-SUMMARY.md`
</output>
