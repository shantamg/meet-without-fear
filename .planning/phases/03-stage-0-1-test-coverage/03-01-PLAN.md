---
phase: 03-stage-0-1-test-coverage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - e2e/tests/two-browser-stage-0.spec.ts
  - e2e/tests/two-browser-stage-1.spec.ts
autonomous: true

must_haves:
  truths:
    - "Test proves both users sign compact and both see chat input (Stage 0 complete)"
    - "Test proves both users see each other's partner name via Ably after compact signing"
    - "Test proves both users converse with AI, receive feel-heard check, confirm feel-heard, and advance to Stage 2"
    - "Both test files pass with `cd e2e && npx playwright test --config=playwright.two-browser.config.ts`"
  artifacts:
    - path: "e2e/tests/two-browser-stage-0.spec.ts"
      provides: "Two-browser Stage 0 test covering compact signing and witnessing entry"
    - path: "e2e/tests/two-browser-stage-1.spec.ts"
      provides: "Two-browser Stage 1 test covering AI conversation, feel-heard confirmation, and Stage 2 entry"
  key_links:
    - from: "e2e/tests/two-browser-stage-0.spec.ts"
      to: "e2e/helpers/two-browser-harness.ts"
      via: "TwoBrowserHarness import"
      pattern: "import.*TwoBrowserHarness"
    - from: "e2e/tests/two-browser-stage-1.spec.ts"
      to: "e2e/helpers/test-utils.ts"
      via: "sendAndWaitForPanel, confirmFeelHeard imports"
      pattern: "import.*(sendAndWaitForPanel|confirmFeelHeard)"
    - from: "e2e/tests/two-browser-stage-1.spec.ts"
      to: "backend/src/fixtures/user-a-full-journey.ts"
      via: "Per-user fixture ID 'user-a-full-journey' set in TwoBrowserHarness config"
      pattern: "fixtureId.*user-a-full-journey"
---

<objective>
Write two-browser E2E tests that verify both users can complete Stages 0 and 1 together, documenting actual system behavior.

Purpose: Establish test baseline for partner interaction reliability. Tests document how the system actually works (including workarounds for known issues), creating a safety net for Phase 5-6 fixes.

Output: Two test files (two-browser-stage-0.spec.ts, two-browser-stage-1.spec.ts) that pass with current implementation.
</objective>

<execution_context>
@/Users/shantam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shantam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Infrastructure from Phase 2 (essential context)
@e2e/tests/two-browser-smoke.spec.ts
@e2e/helpers/two-browser-harness.ts
@e2e/helpers/test-utils.ts
@e2e/helpers/index.ts
@e2e/playwright.two-browser.config.ts

# Fixtures that define AI responses per user
@backend/src/fixtures/user-a-full-journey.ts
@backend/src/fixtures/user-b-partner-journey.ts
@backend/src/fixtures/types.ts
@backend/src/fixtures/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create two-browser Stage 0 test</name>
  <files>e2e/tests/two-browser-stage-0.spec.ts</files>
  <action>
Create `e2e/tests/two-browser-stage-0.spec.ts` following the exact pattern from `two-browser-smoke.spec.ts`.

**Test structure:**

```typescript
test.describe('Stage 0: Compact Signing', () => {
  // beforeEach: Create TwoBrowserHarness with user configs, cleanup, setupUserA, createSession
  // afterEach: teardown

  test('both users sign compact and enter witnessing', async ({ browser, request }) => {
    // 1. setupUserB, acceptInvitation
    // 2. User A: navigateUserA, signCompact, handleMoodCheck
    // 3. User B: navigateUserB, signCompact, handleMoodCheck
    // 4. Assert: both see chat-input (testID 'chat-input')
    // 5. Assert: User A sees partner name "Bob" via waitForPartnerUpdate (reload fallback)
    // 6. Assert: User B sees partner name "Alice" via waitForPartnerUpdate (reload fallback)
    // 7. Screenshots: both users' final state
  });
});
```

**Specifics:**
- Use `test.setTimeout(180000)` (3 minutes — compact signing is fast but Ably needs time)
- User A: `email: 'stage0-a@e2e.test', name: 'Alice', fixtureId: 'user-a-full-journey'`
- User B: `email: 'stage0-b@e2e.test', name: 'Bob', fixtureId: 'user-b-partner-journey'`
- Use `test.use(devices['iPhone 12'])` for mobile viewport
- Import from `'../helpers'` (TwoBrowserHarness, waitForPartnerUpdate) and `'../helpers/test-utils'` (signCompact, handleMoodCheck)
- Partner name assertion uses `page.getByTestId('session-chat-header-partner-name')` with `waitForPartnerUpdate(page, locator, { timeout: 15000, reloadOnMiss: true })`
- After reload, call `handleMoodCheck(page)` since mood check can reappear
- Screenshot paths: `test-results/stage0-user-a-complete.png`, `test-results/stage0-user-b-complete.png`

**This test documents that:** Both users can complete onboarding (compact signing) and arrive at the witnessing chat interface with partner awareness via Ably.
  </action>
  <verify>
Run: `cd /Users/shantam/Software/meet-without-fear/e2e && npx playwright test --config=playwright.two-browser.config.ts tests/two-browser-stage-0.spec.ts`

Test passes. Screenshots appear in `e2e/test-results/`.
  </verify>
  <done>
Stage 0 test passes: both users sign compact, both see chat input, both see partner name via Ably.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create two-browser Stage 1 test</name>
  <files>e2e/tests/two-browser-stage-1.spec.ts</files>
  <action>
Create `e2e/tests/two-browser-stage-1.spec.ts` that tests the full Stage 1 (WITNESS) flow for both users.

**Test structure:**

```typescript
test.describe('Stage 1: Witnessing - Feel Heard', () => {
  // beforeEach: Create TwoBrowserHarness, cleanup, setupUserA, createSession
  // afterEach: teardown

  test('both users converse with AI, confirm feel-heard, and advance to Stage 2', async ({ browser, request }) => {
    // === STAGE 0 PREREQUISITE ===
    // 1. setupUserB, acceptInvitation
    // 2. Both users: navigate, signCompact, handleMoodCheck
    // 3. Verify both see chat-input

    // === USER A: WITNESSING CONVERSATION ===
    // 4. User A sends messages using sendAndWaitForPanel to drive through fixture responses
    //    Messages to send (matching user-a-full-journey fixture):
    //      - "Hi, I'm having a conflict with my partner" (response 0: initial greeting)
    //      - "We keep arguing about household chores" (response 1: invitation draft — but we skip invitation UI for Stage 1)
    //      - "Thanks, I sent the invitation" (response 2: post-invitation)
    //      - "I feel like I do most of the work and they don't notice or appreciate it" (response 3: FeelHeardCheck: Y)
    //    Use sendAndWaitForPanel(page, messages, 'feel-heard-yes', 4)
    //    This sends messages one at a time until feel-heard panel appears
    // 5. User A confirms feel-heard: confirmFeelHeard(harness.userAPage)
    // 6. Screenshot User A post-feel-heard state

    // === USER B: WITNESSING CONVERSATION ===
    // 7. User B sends messages using sendAndWaitForPanel:
    //    Messages (matching user-b-partner-journey fixture):
    //      - "Things have been tense lately" (response 0)
    //      - "I feel like they don't see how much I'm dealing with" (response 1)
    //      - "I work so hard and come home exhausted, but there's always more to do" (response 2)
    //      - "Months now. I don't know how to get through to them" (response 3: FeelHeardCheck: Y)
    //    Use sendAndWaitForPanel(page, messages, 'feel-heard-yes', 4)
    // 8. User B confirms feel-heard: confirmFeelHeard(harness.userBPage)
    // 9. Screenshot User B post-feel-heard state

    // === VERIFY STAGE 2 ENTRY ===
    // 10. After both confirm feel-heard, verify advancement.
    //     The UI should show empathy-related UI elements or at minimum
    //     the chat should still be functional. Use structural assertions:
    //     - Both users still have chat-input visible (conversation continues in Stage 2)
    //     - Screenshot final state for both users
    //
    //     NOTE: If Stage 2 UI panels don't appear (known cache staleness issue),
    //     document with comment. This test proves Stage 1 COMPLETION, not Stage 2 entry UI.
  });
});
```

**Specifics:**
- Use `test.setTimeout(300000)` (5 minutes — conversation with 4 messages per user + streaming)
- Same user configs as Stage 0 test: stage1-a@e2e.test / stage1-b@e2e.test, same fixture IDs
- Import `sendAndWaitForPanel` and `confirmFeelHeard` from `'../helpers/test-utils'`
- The `sendAndWaitForPanel` function sends messages one at a time, waiting for AI response after each, then checks for the panel. It handles the full send-wait-check cycle.
- User A message array must match `user-a-full-journey.ts` fixture `responses[].user` strings exactly (fixture matching is by response index, not by user text content — the fixture serves responses in order regardless of what the user types, but matching keeps the test readable)
- User B message array must match `user-b-partner-journey.ts` fixture `responses[].user` strings exactly
- After `confirmFeelHeard`, the feel-heard button should disappear (confirmFeelHeard already asserts this)
- For Stage 2 verification: check `chat-input` is still visible. If `invitation-panel` appears for User A after feel-heard (expected per user-a-full-journey fixture response 4 flow), assert it with a comment explaining this is the invitation drafting flow.
- Screenshot paths: `test-results/stage1-user-a-feel-heard.png`, `test-results/stage1-user-b-feel-heard.png`, `test-results/stage1-final.png`

**Known workarounds to document in comments:**
- Feel-heard panel may take up to 5s to appear after AI response (metadata SSE event arrives after text)
- `sendAndWaitForPanel` already handles this with 5000ms panel check timeout
- If mood check reappears after any reload during test, `handleMoodCheck` is called by harness utilities

**This test documents that:** Both users can complete the witnessing stage conversation and confirm they feel heard, which is the gate for Stage 2 entry.
  </action>
  <verify>
Run: `cd /Users/shantam/Software/meet-without-fear/e2e && npx playwright test --config=playwright.two-browser.config.ts tests/two-browser-stage-1.spec.ts`

Test passes. Screenshots appear in `e2e/test-results/`.

Then run the full two-browser suite to verify no conflicts with smoke test:
`cd /Users/shantam/Software/meet-without-fear/e2e && npx playwright test --config=playwright.two-browser.config.ts`

All 3 test files pass (smoke + stage-0 + stage-1).
  </verify>
  <done>
Stage 1 test passes: both users converse with fixture-based AI, both receive and confirm feel-heard check, conversation continues. Full two-browser suite (smoke + stage-0 + stage-1) passes without conflicts.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/shantam/Software/meet-without-fear/e2e && npx playwright test --config=playwright.two-browser.config.ts` — all tests pass
2. `e2e/tests/two-browser-stage-0.spec.ts` exists with Stage 0 test
3. `e2e/tests/two-browser-stage-1.spec.ts` exists with Stage 1 test
4. Screenshots exist in `e2e/test-results/` showing both users' states
5. No `npm run check` errors in e2e workspace
</verification>

<success_criteria>
- Both test files pass with current implementation
- Stage 0 test: both users sign compact, see chat input, see partner name
- Stage 1 test: both users converse, confirm feel-heard, remain in functional chat state
- Full two-browser test suite passes (smoke + stage-0 + stage-1)
- Tests document actual behavior with comments explaining workarounds for known issues
</success_criteria>

<output>
After completion, create `.planning/phases/03-stage-0-1-test-coverage/03-01-SUMMARY.md`
</output>
