# Specification: AI Therapy App Feedback Fixes (2026-01-14)

*Generated from Lisa interview - 2026-01-14*

## Overview

Address user feedback issues: AI tone (too technical/NVC jargon), context/memory (AI unaware of shared messages), suggested share guardrails (aggressive suggestions), UI/UX issues (stuck states, message re-animation), I/O logic errors (wrong text sent), and convert share actions to modal prompts.

## Problem Statement

The AI therapy app has several quality issues affecting user experience:
1. AI speaks with overwhelming technical/clinical language
2. AI gives inappropriate advice because it doesn't know what's been shared
3. AI sometimes suggests aggressive opening lines during drafting
4. UI has stuck states requiring re-login, animates past messages
5. System confuses internal process thoughts with actual output content
6. Action buttons near chat input are too subtle - users miss them

## Scope

### In Scope
- Issue #1: AI tone - inject simple language prompt constant
- Issue #2: Context/memory - inject shared content history into stage prompts
- Issue #3: Share guardrails - add non-accusational constraints to generateShareSuggestion
- Issue #4B: Stuck state - investigate Ably notification flow
- Issue #4C: Message re-animation - fix knownMessageIdsRef race condition
- Issue #5: I/O logic error - remove fallback placeholder text, handle errors properly
- Modal action prompts - convert share-with-refinement to modal with dismiss/re-offer logic

### Out of Scope
- Issue #4A: Hidden "Next Step" button - defer for separate UX brainstorm session
- Compact signing button - stays as current UI
- Invitation button - stays as current UI

---

## User Stories

### US-1: Simple Language Prompt Constant
**Description:** As a user, I want the AI to speak in plain English so that I can understand the guidance without needing advanced vocabulary.

**Acceptance Criteria:**
- [ ] New constant `SIMPLE_LANGUAGE_PROMPT` created in backend prompt constants
- [ ] Constant injected into all stage prompts (witnessing, empathy, reconciler, etc.)
- [ ] Constant text matches approved wording (see Technical Design)
- [ ] `npm run check` passes
- [ ] `npm run test` passes

### US-2: Shared Content Context Utility
**Description:** As a user, I want the AI to know what I've already shared with my partner so that it gives contextually appropriate advice.

**Acceptance Criteria:**
- [ ] `getSharedContentContext(sessionId, userId)` utility function created
- [ ] Returns formatted string with all shared content visible to user
- [ ] Includes: EmpathyAttempt (REVEALED), ReconcilerShareOffer.sharedContent, special role Messages
- [ ] Utility called from all stage prompt builders
- [ ] `npm run check` passes
- [ ] `npm run test` passes

### US-3: Non-Accusational Share Guardrails
**Description:** As a user, I want share suggestions to be non-confrontational so that I maintain a constructive tone with my partner.

**Acceptance Criteria:**
- [ ] `generateShareSuggestion` prompt in reconciler.ts updated with guardrails
- [ ] Guardrails prohibit: "Look,", "Listen,", accusational "you" statements
- [ ] Guardrails require: "I" statements, experience-focused language
- [ ] `npm run check` passes
- [ ] `npm run test` passes

### US-4: Remove Fallback Placeholder Text
**Description:** As a user, I want errors to be surfaced properly so that I never see internal placeholder text as my "share suggestion."

**Acceptance Criteria:**
- [ ] Fallback text "There's something about my experience..." removed from line 762 in reconciler.ts
- [ ] Fallback text removed from line 1006 in reconciler.ts
- [ ] AI call failures return error state instead of placeholder
- [ ] UI handles error state gracefully (shows retry option or error message)
- [ ] `npm run check` passes
- [ ] `npm run test` passes

### US-5: Fix Message Re-Animation Bug
**Description:** As a user, I want past messages to display immediately when I return to a session, not animate one-by-one.

**Acceptance Criteria:**
- [ ] `knownMessageIdsRef` initialization handles async message loading
- [ ] Messages present in initial query are marked as "known" even if they load after first render
- [ ] Returning to a session shows all past messages statically
- [ ] Only NEW messages (arriving via Ably after load) animate
- [ ] `npm run check` passes
- [ ] `npm run test` passes

### US-6: Investigate Stuck/Waiting State
**Description:** As a user, I want to see the next step when it's ready without needing to relog.

**Acceptance Criteria:**
- [ ] Trace Ably notification flow for reconciler completion
- [ ] Document whether notification fires, is received, triggers refresh
- [ ] Identify root cause of UI not updating
- [ ] Implement fix (either fix notification or add polling fallback)
- [ ] `npm run check` passes
- [ ] `npm run test` passes

### US-7: Share Action Modal - Basic Implementation
**Description:** As a user, I want share suggestions to appear as modals so that I notice them immediately.

**Acceptance Criteria:**
- [ ] ShareSuggestionDrawer replaced with/converted to Modal component
- [ ] Modal shows when reconciler has share offer ready
- [ ] Modal displays suggested content with refine/accept/decline options
- [ ] Dismiss button closes modal and continues chat
- [ ] `npm run check` passes
- [ ] `npm run test` passes

### US-8: Share Action Modal - Re-offer Logic
**Description:** As a user, I want dismissed share offers to re-appear at appropriate times so that I don't forget to share.

**Acceptance Criteria:**
- [ ] `pendingShareOffer` state tracked on session/vessel
- [ ] AI prompt includes awareness of pending offer
- [ ] AI output JSON can include `showShareModal: true` to trigger re-offer
- [ ] Fallback: Modal re-appears after 5 messages since dismiss
- [ ] Fallback: Modal re-appears on stage transition
- [ ] `npm run check` passes
- [ ] `npm run test` passes

---

## Technical Design

### Approved Prompt Language (Issue #1)

```
Speak in plain, conversational English. Use simple words and clear sentence structures that anyone can easily follow - no psychology jargon, no "NVC speak," no clinical language. You can explore deep concepts, but express them the way a wise friend would, not a textbook. If the user starts using technical terms first, you may mirror their vocabulary. Otherwise, keep it accessible.
```

### Share Guardrails (Issue #3)

Add to `generateShareSuggestion` prompt:
```
IMPORTANT GUIDELINES for the suggestion:
- Never start with confrontational phrases like "Look," or "Listen,"
- Focus on sharing YOUR experience, not making claims about the other person's behavior
- Use "I" statements, never "you" accusations
- Keep the tone warm and vulnerable, not defensive or aggressive
```

### Shared Content Context Format (Issue #2)

```
## What has been shared in this conversation:
- [timestamp] You shared your empathy statement: "[content]"
- [timestamp] You shared additional context: "[content]"
- [timestamp] [Partner] shared their perspective: "[content]"
```

### Data Sources for Shared Content

| Source | Condition | What to Include |
|--------|-----------|-----------------|
| EmpathyAttempt | status = REVEALED | content field |
| ReconcilerShareOffer | deliveryStatus = DELIVERED | sharedContent field |
| Message | role in (EMPATHY_STATEMENT, SHARED_CONTEXT) | content field |
| ConsentedContent | consentActive = true | transformedContent field |

### Modal Re-offer State Machine

```
States:
- NO_OFFER: No pending share offer
- OFFERED: Modal visible
- DISMISSED: User dismissed, tracking message count
- ACCEPTED/DECLINED: Terminal states

Transitions:
- NO_OFFER -> OFFERED: Reconciler creates offer
- OFFERED -> DISMISSED: User clicks dismiss
- DISMISSED -> OFFERED: 5 messages elapsed OR stage transition OR AI triggers
- OFFERED -> ACCEPTED: User accepts/shares
- OFFERED -> DECLINED: User declines
```

### Key Files to Modify

| File | Changes |
|------|---------|
| `backend/src/services/reconciler.ts` | Remove fallbacks (762, 1006), add guardrails to prompt |
| `backend/src/services/prompt-constants.ts` | Add SIMPLE_LANGUAGE_PROMPT |
| `backend/src/services/shared-context.ts` | New file: getSharedContentContext() |
| `backend/src/controllers/stage*.ts` | Inject shared content and simple language |
| `mobile/src/components/ChatInterface.tsx` | Fix knownMessageIdsRef initialization |
| `mobile/src/components/ShareSuggestionDrawer.tsx` | Convert to modal, add dismiss logic |
| `mobile/src/hooks/useUnifiedSession.ts` | Add pendingShareOffer tracking |

---

## Implementation Phases

### Phase 1: Prompt Fixes (Issues #1 & #3)
- [ ] Create `SIMPLE_LANGUAGE_PROMPT` constant
- [ ] Inject into all stage prompt builders
- [ ] Add guardrails to `generateShareSuggestion`
- **Verification:** `npm run check && npm run test`

### Phase 2: Context Injection (Issue #2)
- [ ] Create `getSharedContentContext()` utility
- [ ] Query EmpathyAttempt, ReconcilerShareOffer, special Messages
- [ ] Format as prompt section
- [ ] Inject into stage prompts
- **Verification:** `npm run check && npm run test`

### Phase 3: Bug Fixes (Issues #4C & #5)
- [ ] Remove fallback placeholder text from reconciler.ts
- [ ] Add proper error handling for AI call failures
- [ ] Fix knownMessageIdsRef race condition in ChatInterface
- [ ] Ensure messages loaded async are captured as "known"
- **Verification:** `npm run check && npm run test`

### Phase 4: Stuck State Investigation (Issue #4B)
- [ ] Add logging to Ably notification flow
- [ ] Trace from reconciler completion to client handler
- [ ] Document findings
- [ ] Implement fix based on findings
- **Verification:** `npm run check && npm run test`

### Phase 5: Modal Action Prompts (US-7 & US-8)
- [ ] Convert ShareSuggestionDrawer to modal
- [ ] Add dismiss functionality
- [ ] Track pendingShareOffer state
- [ ] Update AI prompts with pending offer awareness
- [ ] Add output JSON field for re-offer trigger
- [ ] Implement 5-message and stage-transition fallbacks
- **Verification:** `npm run check && npm run test`

---

## Definition of Done

This feature is complete when:
- [ ] All acceptance criteria in user stories pass
- [ ] All implementation phases verified
- [ ] Tests pass: `npm run test`
- [ ] Types/lint check: `npm run check`

---

## Ralph Loop Command

```bash
/ralph-loop "Implement feedback fixes per spec at docs/specs/feedback-2026-01-14.md

PHASES:
1. Prompt Fixes: Add SIMPLE_LANGUAGE_PROMPT constant, inject into stages, add guardrails to generateShareSuggestion - verify with npm run check && npm run test
2. Context Injection: Create getSharedContentContext() utility, inject into stage prompts - verify with npm run check && npm run test
3. Bug Fixes: Remove fallback placeholders from reconciler.ts, fix ChatInterface knownMessageIdsRef race condition - verify with npm run check && npm run test
4. Stuck State: Add logging to Ably flow, trace reconciler notification, document and fix - verify with npm run check && npm run test
5. Modal Prompts: Convert ShareSuggestionDrawer to modal, add dismiss/re-offer logic with 5-message and stage-transition fallbacks - verify with npm run check && npm run test

VERIFICATION (run after each phase):
- npm run check
- npm run test

ESCAPE HATCH: After 20 iterations without progress:
- Document what's blocking in docs/specs/feedback-2026-01-14.md under 'Implementation Notes'
- List approaches attempted
- Stop and ask for human guidance

Output <promise>COMPLETE</promise> when all phases pass verification." --max-iterations 50 --completion-promise "COMPLETE"
```

---

## Open Questions

None remaining - all clarified during interview.

## Progress Tracking

Implementation progress is tracked in a separate file: `docs/specs/feedback-2026-01-14-progress.md`

## Implementation Notes

*To be filled during implementation*

---

## References

- Original feedback: `docs/plans/feedback-2026-01-14.md`
- Reconciler service: `backend/src/services/reconciler.ts`
- ChatInterface: `mobile/src/components/ChatInterface.tsx`
- ShareSuggestionDrawer: `mobile/src/components/ShareSuggestionDrawer.tsx`
