# PRD: Stage 3-4 E2E Test with Share Page Migration

**Status:** Draft  
**Created:** 2026-02-03  
**Generated by:** Lisa Spec Interview

---

## Executive Summary

This feature solves: Need E2E test to verify Stage 3 (Need Mapping) and Stage 4 (Strategic Repair) UI works end-to-end wi... Primary users: Developer (me) - using E2E as visual verification tool before deployment MVP scope: Happy path only: Both users validate empathy → view needs on Share page → confirm → view common grou...

---

## 1. Problem Statement

### What problem does this solve?
Need E2E test to verify Stage 3 (Need Mapping) and Stage 4 (Strategic Repair) UI works end-to-end with visual screenshots at key decision points. Also need to migrate Stage 3/4 content from inline cards to Share page for consistency with Stage 2.

### Who are the users?
Developer (me) - using E2E as visual verification tool before deployment

### Success Criteria
Test runs from empathy reveal through resolution, captures screenshots of all key UI states, validates that Stage 3/4 content appears on Share page consistent with Stage 2 patterns

---

## 2. Technical Architecture

### Components
- Playwright E2E framework, Backend API, Mobile web app (Expo), Share page (/session/[id]/share
- tsx), Chat indicators, Ably real-time, Fixtures for mocked AI responses

### External Dependencies
- Ably (real-time), Backend API (localhost:3002), Expo web (localhost:8082), Existing DB/Clerk patterns from Stage 2 tests

### Technical Constraints
- Must match Stage 1/2 UI patterns (chat/share split, indicator lines with arrows, pop-ups, drawers)
- Start from empathy reveal (existing test endpoint)
- Use real Ably like existing tests

---

## 3. User Experience

### Primary Flow
1. Both users at empathy reveal on Share page (validation buttons visible) → 2. Both validate → indicator appears in chat → 3. Navigate to Share page → Needs section visible → 4. Adjust needs or confirm → indicator appears → 5. Common ground revealed on Share page → 6. Confirm → indicator appears → 7. Strategy pool on Share page → 8. Generate suggestions (function only) → 9. Rank strategies → 10. Overlap reveal on Share page → 11. Agreement → indicator appears → 12. Resolution

### Edge Cases & Error States
- Partner hasn't validated yet (waiting), User wants to adjust needs, No common ground found, No strategy overlap, Partner disconnects mid-session

### Design Considerations
Must match Stage 2 patterns: Chat indicators with arrows that navigate to Share page, Share page as central hub for user-to-user content, Pop-ups for attention (like PartnerEventModal), Drawers for focused interactions

---

## 4. Implementation Plan

### MVP Scope
Happy path only: Both users validate empathy → view needs on Share page → confirm → view common ground → view strategy pool → rank → view overlap → agree. Screenshots at each Share page state.

### Future Phases
Adjust needs flow with AI chat, Generate AI strategy suggestions with validation, Error state handling (offline, timeouts), Multiple fixture scenarios

### Risks & Blockers
- Stage 3/4 content currently in inline cards on UnifiedSessionScreen - needs migration to Share page
- Chat indicators for Stage 3/4 milestones not yet implemented

---

## 5. Open Questions
- None identified at this time

---

## Appendix: Interview Notes

<details>
<summary>Raw interview responses</summary>

### Full Answers
**Q1: Problem**
Need E2E test to verify Stage 3 (Need Mapping) and Stage 4 (Strategic Repair) UI works end-to-end with visual screenshots at key decision points. Also need to migrate Stage 3/4 content from inline cards to Share page for consistency with Stage 2.

**Q2: Users**
Developer (me) - using E2E as visual verification tool before deployment

**Q3: Success Criteria**
Test runs from empathy reveal through resolution, captures screenshots of all key UI states, validates that Stage 3/4 content appears on Share page consistent with Stage 2 patterns

**Q4: Components**
Playwright E2E framework, Backend API, Mobile web app (Expo), Share page (/session/[id]/share.tsx), Chat indicators, Ably real-time, Fixtures for mocked AI responses

**Q5: Dependencies**
Ably (real-time), Backend API (localhost:3002), Expo web (localhost:8082), Existing DB/Clerk patterns from Stage 2 tests

**Q6: Constraints**
Must match Stage 1/2 UI patterns (chat/share split, indicator lines with arrows, pop-ups, drawers). Start from empathy reveal (existing test endpoint). Use real Ably like existing tests.

**Q7: Primary Flow**
1. Both users at empathy reveal on Share page (validation buttons visible) → 2. Both validate → indicator appears in chat → 3. Navigate to Share page → Needs section visible → 4. Adjust needs or confirm → indicator appears → 5. Common ground revealed on Share page → 6. Confirm → indicator appears → 7. Strategy pool on Share page → 8. Generate suggestions (function only) → 9. Rank strategies → 10. Overlap reveal on Share page → 11. Agreement → indicator appears → 12. Resolution

**Q8: Edge Cases**
Partner hasn't validated yet (waiting), User wants to adjust needs, No common ground found, No strategy overlap, Partner disconnects mid-session

**Q9: Design Constraints**
Must match Stage 2 patterns: Chat indicators with arrows that navigate to Share page, Share page as central hub for user-to-user content, Pop-ups for attention (like PartnerEventModal), Drawers for focused interactions

**Q10: MVP Scope**
Happy path only: Both users validate empathy → view needs on Share page → confirm → view common ground → view strategy pool → rank → view overlap → agree. Screenshots at each Share page state.

**Q11: Future Phases**
Adjust needs flow with AI chat, Generate AI strategy suggestions with validation, Error state handling (offline, timeouts), Multiple fixture scenarios

**Q12: Blockers**
Stage 3/4 content currently in inline cards on UnifiedSessionScreen - needs migration to Share page. Chat indicators for Stage 3/4 milestones not yet implemented.


### AI Notes
Key architectural decision: Move Stage 3/4 from inline cards to Share page for consistency with Stage 2 pattern. Chat indicators should appear in chat flow (like 'empathy-shared', 'context-shared') and navigate to Share page. Share page becomes central hub for all user-to-user content across all stages. Stage 3 shows: NeedsSection, CommonGroundCard. Stage 4 shows: StrategyPool, StrategyRanking, OverlapReveal, AgreementCard.

</details>

---

*This PRD was generated by Lisa Spec Interview. Update as the project evolves.*
